<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kỹ Thuật Pro Max - Dashboard</title>
    <style>
        :root { --primary: #00d2ff; --secondary: #3a7bd5; --dark: #1a1a2e; --card: #16213e; --text: #e9ecef; }
        body { font-family: 'Inter', sans-serif; background: var(--dark); color: var(--text); margin: 0; padding: 15px; }
        .container { max-width: 1100px; margin: auto; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .header h2 { margin: 0; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.5rem; }
        
        /* Input Form */
        .glass-card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); margin-top: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        select, textarea, input { background: #0f3460; border: 1px solid #162447; color: white; padding: 12px; border-radius: 8px; font-size: 14px; outline: none; transition: 0.3s; }
        select:focus, textarea:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 210, 255, 0.3); }
        textarea { grid-column: span 2; height: 80px; }
        .btn-save { grid-column: span 2; background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 15px; }
        
        /* Table Style */
        .table-section { margin-top: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { padding: 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: #888; }
        td { background: var(--card); padding: 15px; transition: 0.3s; cursor: pointer; }
        td:first-child { border-radius: 10px 0 0 10px; }
        td:last-child { border-radius: 0 10px 10px 0; }
        tr:hover td { background: #1f4068; transform: translateY(-2px); }
        .tag { background: rgba(0, 210, 255, 0.1); color: var(--primary); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; }

        /* Popup (Modal) */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); width: 90%; max-width: 500px; padding: 30px; border-radius: 20px; border: 1px solid var(--primary); position: relative; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 25px; cursor: pointer; color: #888; }
        .modal-item { margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
        .modal-label { font-size: 11px; color: var(--primary); text-transform: uppercase; font-weight: bold; }
        .modal-value { font-size: 15px; margin-top: 5px; line-height: 1.5; }

        /* Search & Filter */
        .search-bar { width: 100%; max-width: 300px; margin-bottom: 10px; background: var(--card); }

        /* Lock Screen */
        #lock-screen { position: fixed; inset: 0; background: var(--dark); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .lock-box { background: var(--card); padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-box" id="lock-box-content">
        <h2 style="color:var(--primary); margin-bottom:20px">KỸ THUẬT LOGIN</h2>
        <input type="password" id="passInput" placeholder="Passcode..." style="width:200px; text-align:center"><br><br>
        <button class="btn-save" onclick="unlock()" style="padding: 10px 40px">TRUY CẬP</button>
    </div>
</div>

<div class="container" id="main-content" style="display:none">
    <div class="header">
        <h2>TECHNICAL LOGS</h2>
        <div>
            <span id="syncStatus" style="font-size: 10px; color: #555; margin-right:10px"></span>
            <button onclick="logout()" style="background:none; border:none; color:var(--primary); cursor:pointer">Đăng xuất</button>
        </div>
    </div>

    <div class="glass-card">
        <div class="form-grid">
            <select id="customer"><option value="">Đang tải khách hàng...</option></select>
            <select id="techName"><option value="">Đang tải kỹ thuật...</option></select>
            <textarea id="content" placeholder="Mô tả chi tiết nội dung công việc hoặc tình trạng lỗi máy..."></textarea>
            <button class="btn-save" id="btnSave" onclick="saveData()">LƯU NHẬT KÝ</button>
        </div>
    </div>

    <div class="table-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="font-size: 14px; color: #888;">LỊCH SỬ GẦN ĐÂY</h3>
            <input type="text" id="searchBox" class="search-bar" placeholder="Tìm kiếm nhanh..." onkeyup="filterTable()">
        </div>
        <table>
            <thead>
                <tr>
                    <th width="60">Giờ</th>
                    <th>Khách Hàng</th>
                    <th>Nội Dung</th>
                    <th width="70">Tech</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="infoModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h3 style="margin-top:0; color:var(--primary)">Chi Tiết Công Việc</h3>
        <div class="modal-item">
            <div class="modal-label">Thời gian xử lý</div>
            <div class="modal-value" id="mTime"></div>
        </div>
        <div class="modal-item">
            <div class="modal-label">Khách hàng</div>
            <div class="modal-value" id="mCust" style="font-weight:bold"></div>
        </div>
        <div class="modal-item">
            <div class="modal-label">Nội dung chi tiết</div>
            <div class="modal-value" id="mCont"></div>
        </div>
        <div class="modal-item" style="border:none">
            <div class="modal-label">Kỹ thuật viên</div>
            <div class="modal-value"><span class="tag" id="mTech"></span></div>
        </div>
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwRpmVrgb2q6IAjHQqZa33r5_cWvs_BOnmtrkvl6N9oyyJFPJkAooS02cxgKbbeT9aO/exec';
    let CURRENT_PASS = '';

    window.onload = () => {
        const p = localStorage.getItem('tech_pass_v2');
        if(p) autoUnlock(p);
    };

    async function autoUnlock(p) {
        document.getElementById('lock-box-content').innerHTML = "SYSTEM SYNCING...";
        try {
            const res = await fetch(`${GOOGLE_SCRIPT_URL}?password=${encodeURIComponent(p)}`);
            const data = await res.json();
            CURRENT_PASS = p;
            showMain(data);
        } catch(e) { localStorage.removeItem('tech_pass_v2'); location.reload(); }
    }

    async function unlock() {
        const p = document.getElementById('passInput').value;
        try {
            const res = await fetch(`${GOOGLE_SCRIPT_URL}?password=${encodeURIComponent(p)}`);
            const data = await res.json();
            if(data.logs) {
                localStorage.setItem('tech_pass_v2', p);
                CURRENT_PASS = p;
                showMain(data);
            } else { alert("Mật khẩu không đúng!"); }
        } catch(e) { alert("Lỗi kết nối!"); }
    }

    function showMain(data) {
        document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        
        document.getElementById('customer').innerHTML = '<option value="">-- Chọn Khách Hàng --</option>' + 
            data.customers.map(c => `<option value="${c}">${c}</option>`).join('');
            
        document.getElementById('techName').innerHTML = '<option value="">-- Chọn Kỹ Thuật --</option>' + 
            data.techs.map(t => `<option value="${t}">${t}</option>`).join('');

        renderTable(data.logs);
    }

    async function saveData() {
        const c = document.getElementById('customer').value;
        const t = document.getElementById('techName').value;
        const n = document.getElementById('content').value;
        if(!c || !n) return alert("Vui lòng điền đủ thông tin!");

        document.getElementById('btnSave').innerText = "ĐANG LƯU...";
        document.getElementById('btnSave').disabled = true;

        await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ password: CURRENT_PASS, customer: c, tech: t, content: n })
        });
        
        document.getElementById('content').value = '';
        document.getElementById('btnSave').innerText = "LƯU NHẬT KÝ";
        document.getElementById('btnSave').disabled = false;
        setTimeout(refresh, 1500);
    }

    async function refresh() {
        try {
            const res = await fetch(`${GOOGLE_SCRIPT_URL}?password=${encodeURIComponent(CURRENT_PASS)}&v=${new Date().getTime()}`);
            const data = await res.json();
            renderTable(data.logs);
            document.getElementById('syncStatus').innerText = "Đã cập nhật: " + new Date().toLocaleTimeString();
        } catch(e) { console.error(e); }
    }

function renderTable(logs) {
    // Lấy tất cả dòng (bao gồm dòng 1 nếu có dữ liệu)
    const html = logs.slice().reverse().map((row, index) => {
        if(!row[0] || !row[1]) return '';
        
        // Tạo định dạng giờ rút gọn (ví dụ: 14:30) để bảng không bị rối
        const dateObj = new Date(row[0]);
        const shortTime = dateObj.getHours().toString().padStart(2, '0') + ":" + 
                          dateObj.getMinutes().toString().padStart(2, '0');
        const shortDate = dateObj.getDate() + "/" + (dateObj.getMonth() + 1);

        // Rút gọn nội dung hiển thị ở bảng
        const shortCont = row[2].length > 40 ? row[2].substring(0, 40) + "..." : row[2];
        
        return `
            <tr onclick="openModal('${row[0]}','${row[1]}','${encodeURIComponent(row[2])}','${row[3]}')">
                <td style="font-size:11px; color:#888; white-space:nowrap">${shortDate}<br>${shortTime}</td>
                <td><span class="tag">${row[1]}</span></td>
                <td style="font-size:13px; color:#ccc">${shortCont}</td>
                <td><b>${row[3] || ''}</b></td>
            </tr>`;
    }).join('');
    document.getElementById('tableBody').innerHTML = html;
}

    function openModal(time, cust, cont, tech) {
        document.getElementById('mTime').innerText = new Date(time).toLocaleString('vi-VN');
        document.getElementById('mCust').innerText = cust;
        document.getElementById('mCont').innerText = decodeURIComponent(cont);
        document.getElementById('mTech').innerText = tech;
        document.getElementById('infoModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('infoModal').style.display = 'none'; }
    window.onclick = (e) => { if(e.target == document.getElementById('infoModal')) closeModal(); }

    function filterTable() {
        const val = document.getElementById('searchBox').value.toUpperCase();
        const rows = document.getElementById('tableBody').getElementsByTagName('tr');
        for (let r of rows) { r.style.display = r.innerText.toUpperCase().includes(val) ? "" : "none"; }
    }

    function logout() { localStorage.removeItem('tech_pass_v2'); location.reload(); }
    setInterval(refresh, 10000); // 30 giây làm mới 1 lần
    window.onfocus = () => { if(CURRENT_PASS) refresh(); };
</script>
</body>
</html>
