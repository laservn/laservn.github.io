<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√ÅO C√ÅO K·ª∏ THU·∫¨T</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ†Ô∏è</text></svg>">
    <style>
        /* GI·ªÆ NGUY√äN TO√ÄN B·ªò CSS G·ªêC C·ª¶A B·∫†N */
        :root { 
            --primary: #00d2ff; --secondary: #3a7bd5; --dark: #0f172a; 
            --card: #1e293b; --border: rgba(255,255,255,0.1);
            --text-main: #f8fafc; --text-muted: #94a3b8;
        }
        body { font-family: 'Inter', sans-serif; background: var(--dark); color: var(--text-main); margin: 0; padding: 12px; line-height: 1.5; }
        .tab-navigation { display: flex; gap: 10px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 12px; border: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: var(--text-muted); font-weight: 600; cursor: pointer; border-radius: 8px; transition: 0.3s; font-size: 13px; text-transform: uppercase; }
        .tab-btn.active { background: var(--primary); color: var(--dark); box-shadow: 0 0 15px rgba(0, 210, 255, 0.4); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #lock-screen { position: fixed; inset: 0; background: var(--dark); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .login-box { width: 320px; padding: 30px; background: var(--card); border-radius: 20px; border: 1px solid var(--border); text-align: center; }
        input, select, textarea { background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 12px; outline: none; font-size: 14px; }
        .btn-save { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-weight: 600; width: 100%; }
        .table-container { margin-top: 15px; border: 1px solid var(--border); border-radius: 12px; overflow-x: auto; background: var(--card); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 850px; }
        th { background: #111827; color: var(--text-muted); font-size: 11px; padding: 14px 12px; border-bottom: 2px solid var(--border); text-align: left; }
        td { padding: 14px 12px; border-bottom: 1px solid var(--border); font-size: 13px; cursor: pointer; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); padding: 20px; }
        .modal-content { background: var(--card); width: 95%; max-width: 600px; border-radius: 20px; border: 1px solid var(--primary); padding: 25px; max-height: 85vh; display: flex; flex-direction: column; }
        .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px; }
        .meta-col { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); z-index: 4000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; top: 20px; right: 20px; background: var(--card); color: white; padding: 12px 20px; border-radius: 8px; border-left: 4px solid var(--primary); z-index: 10000; }
    </style>
</head>
<body>
    
<div id="toast-container"></div>
<div id="loading-overlay"><div class="spinner"></div><div id="loading-text" style="color:var(--primary); margin-top:10px;">ƒêANG X·ª¨ L√ù...</div></div>
    
<div id="lock-screen">
    <div class="login-box">
        <h2 style="color:var(--primary); margin-bottom:20px;">H·ªÜ TH·ªêNG V5</h2>
        <input type="text" id="userInput" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="passInput" placeholder="M·∫≠t kh·∫©u">
        <button class="btn-save" onclick="unlock()">ƒêƒÇNG NH·∫¨P</button>
    </div>
</div>

<div class="container" id="main-content" style="display:none; padding: 20px; max-width: 1200px; margin: auto;">
    <div class="header" style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color:var(--primary); margin:0;">TECH REPORT SYSTEM</h3>
        <div style="text-align: right">
            <span id="helloUser" style="color:var(--primary); font-weight:600">---</span>
            <button onclick="logout()" style="color:#ef4444; background:none; border:none; cursor:pointer; font-weight:bold; margin-left:15px;">THO√ÅT</button>
        </div>
    </div>

    <div class="tab-navigation" id="tabBar">
        <button class="tab-btn active" onclick="switchTab('data-tab', this)">üìä D·ªØ li·ªáu</button>
        <button class="tab-btn" id="btnTabForm" onclick="switchTab('form-tab', this)">üìë B√°o c√°o</button>
        <button class="tab-btn" id="btnTabMeta" onclick="switchTab('meta-tab', this)">üß± Kh·ªëi</button>
        <button class="tab-btn" id="btnTabUser" onclick="switchTab('user-tab', this)">üë• User</button>
        <button class="tab-btn" id="btnTabDoc" onclick="switchTab('doc-tab', this)">üìÇ T√†i li·ªáu</button>
    </div>

    <div id="data-tab" class="tab-content active">
        <input type="text" id="searchBox" onkeyup="filterTable()" placeholder="üîç T√¨m ki·∫øm nhanh...">
        <div class="table-container">
            <table>
                <thead>
                    <tr><th>Ng√†y</th><th>Kh√°ch h√†ng</th><th>Lo·∫°i m√°y</th><th>H·ªó tr·ª£</th><th>N·ªôi dung</th><th>K·ªπ thu·∫≠t</th></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="form-tab" class="tab-content">
        <div style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary);">
            <input type="date" id="workDate">
            <select id="customer"><option value="">-- Kh√°ch h√†ng --</option></select>
            <select id="techName"><option value="">-- K·ªπ thu·∫≠t --</option></select>
            <select id="machineType"><option value="">-- Lo·∫°i m√°y --</option></select>
            <select id="supportType"><option value="">-- H·ªó tr·ª£ --</option></select>
            <textarea id="content" placeholder="M√¥ t·∫£ c√¥ng vi·ªác..." style="height:100px"></textarea>
            <input type="text" id="note" placeholder="Ghi ch√∫ th√™m...">
            <button class="btn-save" id="btnSave" onclick="saveData()">L∆ØU B√ÅO C√ÅO</button>
        </div>
    </div>

    <div id="meta-tab" class="tab-content">
        <div class="meta-grid" id="metaContainer"></div>
    </div>

    <div id="user-tab" class="tab-content">
        <div style="background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--primary);">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                <input type="text" id="u_id" placeholder="User ID">
                <input type="text" id="u_name" placeholder="H·ªç t√™n">
                <input type="text" id="u_pass" placeholder="M·∫≠t kh·∫©u">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
                <select id="u_role"><option value="VIEWER">VIEWER</option><option value="EDIT">EDIT</option><option value="ADMIN">ADMIN</option></select>
                <input type="text" id="u_access" placeholder="Quy·ªÅn kh√°ch h√†ng (Kh√°ch A, Kh√°ch B ho·∫∑c ALL)">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <button class="btn-save" onclick="addUser()">TH√äM / C·∫¨P NH·∫¨T</button>
                <button class="btn-save" onclick="deleteUser()" style="background:#7f1d1d">X√ìA USER</button>
            </div>
        </div>
        <div class="table-container">
            <table><thead><tr><th>ID</th><th>T√™n</th><th>Quy·ªÅn</th><th>Truy c·∫≠p</th></tr></thead><tbody id="userTableBody"></tbody></table>
        </div>
    </div>

    <div id="doc-tab" class="tab-content">
        <div id="docAdminForm" style="background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--primary);">
            <input type="text" id="doc_name" placeholder="T√™n t√†i li·ªáu">
            <input type="text" id="doc_link" placeholder="Link (Drive/Dropbox)">
            <p style="font-size:12px; color:var(--primary); margin-bottom:5px;">Ch·ªçn kh√°ch h√†ng ƒë∆∞·ª£c ph√©p xem:</p>
            <div id="doc_customer_checks" style="max-height:150px; overflow-y:auto; background:rgba(0,0,0,0.2); border-radius:8px; padding:10px;"></div>
            <button class="btn-save" style="margin-top:15px;" onclick="addDoc()">L∆ØU T√ÄI LI·ªÜU</button>
        </div>
        <div id="doc_list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:15px;"></div>
    </div>
</div>

<div id="infoModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content">
        <h3 id="modalTitle" style="color:var(--primary); text-align:center; margin-top:0;">CHI TI·∫æT</h3>
        <div id="modalBody" style="overflow-y:auto;"></div>
        <button class="btn-save" style="margin-top:20px;" onclick="document.getElementById('infoModal').style.display='none'">ƒê√ìNG</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyC-WW6N3ZzmZ8gk_XypHWa3oW6VJMMGloM",
        authDomain: "data-260206.firebaseapp.com",
        projectId: "data-260206",
        storageBucket: "data-260206.firebasestorage.app",
        messagingSenderId: "992766098254",
        appId: "1:992766098254:web:8e9f5d3216541023d03c1f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    try { db.settings({ experimentalForceLongPolling: true }); } catch (e) {}

    let AUTH = JSON.parse(localStorage.getItem('tech_auth_v5')) || null;
    let currentLogs = [];

    // --- KH·ªûI T·∫†O ---
    window.onload = () => {
        if (AUTH && new Date().getTime() < AUTH.expire) showApp();
        else logout();
    };

    // --- AUTH FUNCTIONS ---
    async function unlock() {
        const u = document.getElementById('userInput').value.trim();
        const p = document.getElementById('passInput').value.trim();
        showLoading(true, "X√ÅC TH·ª∞C...");
        try {
            const doc = await db.collection("users").doc(u).get();
            if (doc.exists && doc.data().pass === p) {
                const d = doc.data();
                AUTH = { user: u, role: d.role, access: d.access || "", expire: new Date().getTime() + 86400000 };
                localStorage.setItem('tech_auth_v5', JSON.stringify(AUTH));
                showApp();
            } else { showToast("Sai th√¥ng tin!", "error"); }
        } catch (e) { showToast("L·ªói k·∫øt n·ªëi!", "error"); }
        showLoading(false);
    }

    function showApp() {
        document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('helloUser').innerText = "Ch√†o, " + AUTH.user;
        applyPermissions();
        fetchData();
        fetchMetadata();
        fetchDocs();
        if(AUTH.role === "ADMIN") fetchUsers();
    }

    function logout() { localStorage.removeItem('tech_auth_v5'); location.reload(); }

    // --- DATA FUNCTIONS ---
    function fetchData() {
        let query = db.collection("logs").orderBy("createdAt", "desc").limit(200);
        if (AUTH.role === "VIEWER") {
            const allowed = AUTH.access.split(",").map(s => s.trim()).filter(s => s !== "");
            if (allowed.length > 0) query = query.where("customer", "in", allowed);
            else { document.getElementById('tableBody').innerHTML = ""; return; }
        }
        query.onSnapshot(snap => {
            currentLogs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTable(currentLogs);
        });
    }

    function renderTable(logs) {
        document.getElementById('tableBody').innerHTML = logs.map((l, i) => `
            <tr onclick="openInfo(${i})">
                <td style="color:var(--text-muted)">${l.workDate}</td>
                <td><b style="color:var(--primary)">${l.customer}</b></td>
                <td>${l.machineType}</td>
                <td>${l.support}</td>
                <td>${(l.content || "").substring(0,30)}...</td>
                <td>${l.tech}</td>
            </tr>
        `).join('');
    }

    async function saveData() {
        const data = {
            workDate: document.getElementById('workDate').value,
            customer: document.getElementById('customer').value,
            tech: document.getElementById('techName').value,
            machineType: document.getElementById('machineType').value,
            support: document.getElementById('supportType').value,
            content: document.getElementById('content').value,
            note: document.getElementById('note').value,
            createdBy: AUTH.user,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if(!data.customer || !data.content) return showToast("Thi·∫øu th√¥ng tin!", "error");
        showLoading(true);
        await db.collection("logs").add(data);
        showToast("ƒê√£ l∆∞u!");
        switchTab('data-tab', document.querySelector('.tab-btn'));
        showLoading(false);
    }

    // --- METADATA (TAB 3) ---
    function fetchMetadata() {
        db.collection("metadata").doc("dropdowns").onSnapshot(doc => {
            if (!doc.exists) return;
            const d = doc.data();
            // Dropdowns Tab 2
            updateSelect('customer', d.customers);
            updateSelect('techName', d.techs);
            updateSelect('machineType', d.machineTypes);
            updateSelect('supportType', d.supports);
            // Checkbox Tab 5
            document.getElementById('doc_customer_checks').innerHTML = d.customers.map(c => `
                <label style="display:block; margin:5px 0;"><input type="checkbox" name="doc_cust" value="${c}"> ${c}</label>
            `).join('');
            // Tab 3 Editor
            if(AUTH.role === "ADMIN") renderMetaEditor(d);
        });
    }

    function renderMetaEditor(d) {
        const fields = [{k:'customers',n:'KH√ÅCH H√ÄNG'}, {k:'techs',n:'K·ª∏ THU·∫¨T'}, {k:'machineTypes',n:'LO·∫†I M√ÅY'}, {k:'supports',n:'H·ªñ TR·ª¢'}];
        document.getElementById('metaContainer').innerHTML = fields.map(f => `
            <div class="meta-col">
                <h4 style="color:var(--primary); margin-top:0;">${f.n}</h4>
                <textarea id="meta_${f.k}" style="height:150px; font-size:12px;">${(d[f.k]||[]).join(', ')}</textarea>
                <button class="btn-save" style="padding:8px; font-size:12px;" onclick="saveMeta('${f.k}')">C·∫¨P NH·∫¨T</button>
            </div>
        `).join('');
    }

    async function saveMeta(key) {
        const val = document.getElementById('meta_'+key).value.split(',').map(s => s.trim()).filter(v => v !== "");
        showLoading(true);
        await db.collection("metadata").doc("dropdowns").update({ [key]: val });
        showToast("ƒê√£ c·∫≠p nh·∫≠t!");
        showLoading(false);
    }

    // --- USER MANAGEMENT (TAB 4) ---
    function fetchUsers() {
        db.collection("users").onSnapshot(snap => {
            document.getElementById('userTableBody').innerHTML = snap.docs.map(doc => {
                const u = doc.data();
                return `<tr onclick="loadUserToForm('${doc.id}','${u.name}','${u.role}','${u.pass}','${u.access||""}')">
                    <td>${doc.id}</td><td>${u.name}</td><td>${u.role}</td><td>${u.access||"ALL"}</td>
                </tr>`;
            }).join('');
        });
    }

    async function addUser() {
        const id = document.getElementById('u_id').value.trim();
        const data = {
            name: document.getElementById('u_name').value,
            pass: document.getElementById('u_pass').value,
            role: document.getElementById('u_role').value,
            access: document.getElementById('u_access').value
        };
        await db.collection("users").doc(id).set(data);
        showToast("Th√†nh c√¥ng!");
    }

    // --- DOCS (TAB 5) ---
    function fetchDocs() {
        db.collection("documents").onSnapshot(snap => {
            const docs = snap.docs.map(d => ({id: d.id, ...d.data()}));
            let filtered = docs;
            if(AUTH.role === "VIEWER") {
                const myAccess = AUTH.access.split(",").map(s => s.trim());
                filtered = docs.filter(d => !d.customers || d.customers.length === 0 || d.customers.some(c => myAccess.includes(c)));
            }
            document.getElementById('doc_list').innerHTML = filtered.map(d => `
                <div class="meta-col">
                    <h4 style="margin:0; color:var(--primary)">üìÑ ${d.name}</h4>
                    <p style="font-size:11px; color:var(--text-muted)">Quy·ªÅn: ${(d.customers||[]).join(', ') || 'T·∫•t c·∫£'}</p>
                    <a href="${d.link}" target="_blank" style="display:block; background:var(--secondary); color:white; text-align:center; padding:10px; border-radius:8px; text-decoration:none; font-weight:bold; margin-top:10px;">T·∫¢I T√ÄI LI·ªÜU</a>
                </div>
            `).join('');
        });
    }

    async function addDoc() {
        const custs = Array.from(document.querySelectorAll('input[name="doc_cust"]:checked')).map(c => c.value);
        await db.collection("documents").add({
            name: document.getElementById('doc_name').value,
            link: document.getElementById('doc_link').value,
            customers: custs
        });
        showToast("ƒê√£ th√™m t√†i li·ªáu!");
    }

    // --- UTILS ---
    function switchTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function openInfo(i) {
        const l = currentLogs[i];
        document.getElementById('modalBody').innerHTML = `
            <p><b>Ng√†y:</b> ${l.workDate}</p>
            <p><b>Kh√°ch h√†ng:</b> ${l.customer}</p>
            <p><b>M√°y:</b> ${l.machineType} | <b>H·ªó tr·ª£:</b> ${l.support}</p>
            <p><b>K·ªπ thu·∫≠t:</b> ${l.tech}</p>
            <hr border="0" style="border-top:1px solid var(--border)">
            <p><b>N·ªôi dung:</b><br>${l.content}</p>
            <p style="color:var(--text-muted)"><i>Ghi ch√∫: ${l.note || "N/A"}</i></p>
        `;
        document.getElementById('infoModal').style.display = 'flex';
    }

    function applyPermissions() {
        const r = AUTH.role;
        document.getElementById('btnTabForm').style.display = (r === 'ADMIN' || r === 'EDIT') ? 'block' : 'none';
        document.getElementById('btnTabMeta').style.display = (r === 'ADMIN') ? 'block' : 'none';
        document.getElementById('btnTabUser').style.display = (r === 'ADMIN') ? 'block' : 'none';
        document.getElementById('docAdminForm').style.display = (r === 'ADMIN' || r === 'EDIT') ? 'block' : 'none';
    }

    function updateSelect(id, list) {
        const s = document.getElementById(id);
        const val = s.value;
        s.innerHTML = `<option value="">-- Ch·ªçn --</option>` + (list||[]).map(v => `<option value="${v}">${v}</option>`).join('');
        s.value = val;
    }

    function showLoading(s, t) { document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none'; if(t) document.getElementById('loading-text').innerText = t; }
    function showToast(m, type) { 
        const t = document.createElement('div'); t.className = 'toast'; 
        if(type==='error') t.style.borderLeftColor = '#ef4444';
        t.innerText = m; document.getElementById('toast-container').appendChild(t); 
        setTimeout(() => t.remove(), 3000); 
    }
    function filterTable() {
        const v = document.getElementById('searchBox').value.toUpperCase();
        renderTable(currentLogs.filter(l => JSON.stringify(l).toUpperCase().includes(v)));
    }
    function loadUserToForm(id, name, role, pass, access) {
        document.getElementById('u_id').value = id;
        document.getElementById('u_name').value = name;
        document.getElementById('u_pass').value = pass;
        document.getElementById('u_role').value = role;
        document.getElementById('u_access').value = access;
    }
</script>
</body>
</html>
