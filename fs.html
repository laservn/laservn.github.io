<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√ÅO C√ÅO K·ª∏ THU·∫¨T</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ†Ô∏è</text></svg>">
    <style>
        :root { 
            --primary: #00d2ff; 
            --secondary: #3a7bd5; 
            --dark: #0f172a; 
            --card: #1e293b; 
            --border: rgba(255,255,255,0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--dark); 
            color: var(--text-main); 
            margin: 0; 
            padding: 12px; 
            line-height: 1.5;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Tab Navigation */
        .tab-navigation { display: flex; gap: 10px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 12px; border: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: var(--text-muted); font-weight: 600; cursor: pointer; border-radius: 8px; transition: 0.3s; font-size: 13px; text-transform: uppercase; }
        .tab-btn.active { background: var(--primary); color: var(--dark); box-shadow: 0 0 15px rgba(0, 210, 255, 0.4); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Login Screen */
        #lock-screen { position: fixed; inset: 0; background: var(--dark); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .login-box { width: 320px; padding: 30px; background: var(--card); border-radius: 20px; border: 1px solid var(--border); text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-box img { filter: drop-shadow(0 0 15px var(--primary)) brightness(1.2);}

        
        /* Container & Header */
        .container { max-width: 1000px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 20px; }
        
        /* Inputs */
        input, select, textarea { 
            background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; 
            border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 12px; outline: none; transition: 0.3s; font-size: 14px;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0, 210, 255, 0.2); }
        
        .btn-save { 
            background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border: none; 
            padding: 14px; border-radius: 10px; cursor: pointer; font-weight: 600; width: 100%; transition: transform 0.1s;
        }
        .btn-save:active { transform: scale(0.98); }
        .btn-save:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* Professional Table (GI·ªÆ NGUY√äN G·ªêC) */
        .table-container { 
            margin-top: 15px; border: 1px solid var(--border); border-radius: 12px; 
            overflow-x: auto; background: var(--card); box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 850px; }
        th { 
            background: #111827; color: var(--text-muted); font-size: 11px; font-weight: 600; 
            text-transform: uppercase; letter-spacing: 0.05em; padding: 14px 12px; border-bottom: 2px solid var(--border); text-align: left;
        }
        td { padding: 14px 12px; border-bottom: 1px solid var(--border); font-size: 13px; cursor: pointer; transition: 0.2s; }
        tbody tr:nth-child(even) { background: rgba(255, 255, 255, 0.02); }
        tbody tr:hover td { background: rgba(0, 210, 255, 0.08); }

        .badge-tech { background: rgba(58, 123, 213, 0.2); color: #93c5fd; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; white-space: nowrap; }
        .badge-mec { background: rgba(58, 123, 213, 0.2); color: #93c5ff; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; white-space: nowrap; }
        .badge-sup { background: rgba(58, 123, 213, 0.2); color: #93c5dd; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; white-space: nowrap; }

        /* Popup Modals (GI·ªÆ NGUY√äN G·ªêC) */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); padding: 20px; }
        .modal-content { 
            background: var(--card); width: 95%; max-width: 600px; border-radius: 20px; border: 1px solid var(--primary); 
            padding: 25px; max-height: 85vh; display: flex; flex-direction: column;
        }
        #modalBody { overflow-y: auto; margin-top: 15px; padding-right: 5px; }

        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .detail-item { display: flex; align-items: center; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 6px 0; }
        .detail-label { color: var(--text-muted); width: 85px; flex-shrink: 0; }
        .detail-value { color: var(--primary); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Metadata Block Style (Tab 3) */
        .meta-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .meta-col { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; }
        .meta-col h4 { margin: 0 0 12px 0; color: var(--primary); font-size: 12px; text-align: center; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        .meta-list { flex-grow: 1; min-height: 250px; max-height: 400px; overflow-y: auto; }
        .meta-item { background: rgba(0,0,0,0.2); margin-bottom: 4px; border-radius: 6px; border: 1px solid transparent; }
        .meta-item input { margin-bottom: 0; padding: 8px; font-size: 12px; background: transparent; border: none; color: #fff; }
        .meta-item.editing { background: #0f172a; border-color: var(--primary); }
        .meta-item.editing input { background: #1e293b; }
        .meta-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 12px; }
        .btn-meta { padding: 8px; border-radius: 6px; border: none; font-size: 11px; font-weight: 600; cursor: pointer; text-transform: uppercase; }
        .btn-edit-mode { background: rgba(0, 210, 255, 0.1); color: var(--primary); border: 1px solid var(--primary); }
        .btn-save-mode { background: var(--primary); color: var(--dark); }

        @media (max-width: 480px) { .meta-grid { grid-template-columns: 1fr; } .detail-grid { grid-template-columns: 1fr; } }
        
        #workDateDisplay { background: rgba(0, 210, 255, 0.1); border: 1px solid var(--primary); color: var(--primary); font-weight: bold; cursor: pointer; text-align: center; }
        #searchBox { border: 1px solid var(--primary); background: rgba(0, 210, 255, 0.05); margin-top: 10px; }

        /* Progress & Loading */
        #top-progress { position: fixed; top: 0; left: 0; height: 3px; background: linear-gradient(to right, var(--primary), #fff); z-index: 9999; transition: width 0.3s; width: 0%; display: none; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(5px); z-index: 4000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toasts */
        #toast-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .toast { background: rgba(30, 41, 59, 0.95); color: white; padding: 20px 30px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-align: center; border: 1px solid rgba(255,255,255,0.1); animation: toastPop 0.3s forwards; min-width: 300px; /* Chi·ªÅu r·ªông t·ªëi thi·ªÉu */    max-width: 90vw;  /* Chi·ªÅu r·ªông t·ªëi ƒëa (kh√¥ng tr√†n m√†n h√¨nh ƒëi·ªán tho·∫°i) */}
        @keyframes toastPop { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .header-logo { height: 55px; filter: drop-shadow(0 0 15px var(--primary)) brightness(1.2); }
        .cust-row:hover { background: rgba(0, 210, 255, 0.1); }
        /* Th√™m v√†o ph·∫ßn <style> c·ªßa b·∫°n */
.card {
    height: 200px; /* Chi·ªÅu cao v·ª´a v·∫∑n cho c√°c bi·ªÉu ƒë·ªì ƒë·ª©ng */
    position: relative;
    margin-bottom: 20px;
}

.main-footer {
    background: rgba(30, 41, 59, 0.7);
    backdrop-filter: blur(10px);
    border-top: 1px solid var(--border);
    padding: 40px 20px 20px 20px;
    margin-top: 50px;
}

.footer-content {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 40px;
}

.footer-section h3 {
    font-size: 22px;
    letter-spacing: 1px;
    margin-bottom: 15px;
}

.footer-logo span {
    color: var(--primary);
}

.footer-section h4 {
    color: var(--primary);
    font-size: 14px;
    text-transform: uppercase;
    margin-bottom: 20px;
    letter-spacing: 2px;
}

.footer-section p {
    color: var(--text-muted);
    font-size: 14px;
    line-height: 1.6;
}

.footer-links {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.footer-links a {
    color: var(--text-muted);
    text-decoration: none;
    font-size: 14px;
    transition: 0.3s;
}

.footer-links a:hover {
    color: var(--primary);
    padding-left: 5px;
}

.footer-bottom {
    max-width: 1200px;
    margin: 40px auto 0 auto;
    padding-top: 20px;
    border-top: 1px solid rgba(255,255,255,0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.footer-bottom p {
    color: var(--text-muted);
    font-size: 12px;
}

.status-indicator {
    font-size: 12px;
    color: #10b981;
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(16, 185, 129, 0.1);
    padding: 5px 12px;
    border-radius: 20px;
}

.status-indicator .dot {
    width: 8px;
    height: 8px;
    background: #10b981;
    border-radius: 50%;
    box-shadow: 0 0 10px #10b981;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.4; }
    100% { opacity: 1; }
}

/* ƒê·∫£m b·∫£o footer kh√¥ng ƒë√® l√™n content khi ·ªü m√†n h√¨nh nh·ªè */
@media (max-width: 768px) {
    .footer-bottom {
        justify-content: center;
        text-align: center;
    }
}
    </style>
</head>
<body>
    
<div id="toast-container"></div>
<div id="top-progress"></div>
<div id="loading-overlay"><div class="spinner"></div><div id="loading-text" style="color:var(--primary); font-weight:600; margin-top:10px;">ƒêANG X·ª¨ L√ù...</div></div>
    
<div id="lock-screen">
    <div class="login-box">
        <img src="https://lh3.googleusercontent.com/pw/AP1GczNyKJCNBen1I6WeBIOFBHnduEAc-raKjpQsiE-xMOPlkgBLUxSUPtPfnGUO-h_gVE4xbhoZyycDSfpCjJD_uk7EkCLQJEXeuBytxHxBTDS0NEIMKC7RqBA-GIxKhZed7ddwzYsTmKsh5fKxggPZvFM=w483-h154" alt="Logo" style="width: 250px; margin-bottom: 20px;">
        <h2 style="color:var(--primary); margin:0 0 20px 0;">B√ÅO C√ÅO K·ª∏ THU·∫¨T</h2>
        <input type="text" id="userInput" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="passInput" placeholder="M·∫≠t kh·∫©u">
        <button class="btn-save" onclick="unlock()">ƒêƒÇNG NH·∫¨P</button>
    </div>
</div>

<div class="container" id="main-content" style="display:none;">
    <div class="header">
        <img src="https://lh3.googleusercontent.com/pw/AP1GczNyKJCNBen1I6WeBIOFBHnduEAc-raKjpQsiE-xMOPlkgBLUxSUPtPfnGUO-h_gVE4xbhoZyycDSfpCjJD_uk7EkCLQJEXeuBytxHxBTDS0NEIMKC7RqBA-GIxKhZed7ddwzYsTmKsh5fKxggPZvFM=w483-h154" class="header-logo" alt="Logo">
        <div style="text-align: right">
            <span id="helloUser" style="color:var(--primary); font-size:13px; font-weight:600">---</span>
            <button onclick="signOut()" style="color:#ef4444; background:none; border:none; cursor:pointer; margin-left:12px; font-size:12px; font-weight:bold">THO√ÅT</button>
            <small id="syncStatus" style="font-size:10px; color:var(--text-muted); display:block; margin-top:4px">ƒêang ƒë·ªìng b·ªô...</small>
        </div>
    </div>

    <div class="tab-navigation" id="tabBar" style="display:none;">
    <button class="tab-btn active" onclick="switchTab('dashboard', this)">üè† T·ªîNG QUAN</button>
        <button class="tab-btn" onclick="switchTab('data-tab', this)">üìä B·∫£ng D·ªØ Li·ªáu</button>
        <button class="tab-btn" onclick="switchTab('form-tab', this)">üìë B√°o C√°o M·ªõi</button>
        <button class="tab-btn" id="btnTabMeta" onclick="switchTab('meta-tab', this)">üß± Th√¥ng Tin Kh·ªëi</button>
        <button class="tab-btn" id="btnTabUser" onclick="switchTab('user-tab', this)">üë• T√†i Kho·∫£n</button>
        <button class="tab-btn" id="btnTabDoc" onclick="switchTab('doc-tab', this)">üìÇ T√†i li·ªáu</button>
    </div>
    
	<div id="dashboard" class="tab-content active">
	
		<div class="inner-filter-box" style="background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
		    <div style="flex: 1; min-width: 150px;">
			<label style="font-size: 11px; color: var(--primary); font-weight: bold; display: block; margin-bottom: 5px;">TH·ªúI GIAN</label>
			<select class="timePreset" onchange="handlePresetChange(this)" style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
			    <option value="all">T·∫•t c·∫£ th·ªùi gian</option>
			    <option value="today">H√¥m nay</option>
			    <option value="7days">7 ng√†y qua</option>
			    <option value="thisMonth">Th√°ng n√†y</option>
			    <option value="custom">T√πy ch·ªçn...</option>
			</select>
		    </div>

		    <div class="customDateGroup" style="display: none; gap: 10px; flex: 2; min-width: 250px;">
			<div style="flex:1">
			    <input type="date" class="filterFrom" onchange="syncAndFilter(this)" style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
			</div>
			<div style="flex:1">
			    <input type="date" class="filterTo" onchange="syncAndFilter(this)" style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
			</div>
		    </div>

		    <div style="flex: 1; min-width: 150px;">
			<label style="font-size: 11px; color: var(--primary); font-weight: bold; display: block; margin-bottom: 5px;">KH√ÅCH H√ÄNG</label>
			<select class="filterCust" onchange="syncAndFilter(this)" style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
			    <option value="ALL">T·∫•t c·∫£ kh√°ch h√†ng</option>
			</select>
		    </div>
		</div>

		<div class="card" style="position: relative; padding:15px; height: 400px; width: 100%;">
		    <h4 style="margin-top:0; color:var(--primary); ">üë• Kh√°ch H√†ng</h4>
		    <canvas id="chartCust"></canvas>
		</div>
		    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top:40px">
			<div class="card" style="padding:15px;">
			    <h4 style="margin-top:0; color:var(--primary);">‚öôÔ∏è Lo·∫°i M√°y</h4>
			    <canvas id="chartMachine"></canvas>
			</div>
			<div class="card" style="padding:15px;">
			    <h4 style="margin-top:0; color:var(--primary);">üë®‚Äçüîß K·ªπ Thu·∫≠t Vi√™n</h4>
			    <canvas id="chartStaff"></canvas>
			</div>
			<div class="card" style="padding:15px;">
			    <h4 style="margin-top:0; color:var(--primary);">ü§ù Lo·∫°i H·ªó Tr·ª£</h4>
			    <canvas id="chartSupport"></canvas>
			</div>
		    </div>
	</div>

    <div id="data-tab" class="tab-content">
    
	<div class="inner-filter-box" style="background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
	    <div style="flex: 1; min-width: 150px;">
		<label style="font-size: 11px; color: var(--primary); font-weight: bold; display: block; margin-bottom: 5px;">TH·ªúI GIAN</label>
		<select class="timePreset" onchange="handlePresetChange(this)" style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
		    <option value="all">T·∫•t c·∫£ th·ªùi gian</option>
		    <option value="today">H√¥m nay</option>
		    <option value="7days">7 ng√†y qua</option>
		    <option value="thisMonth">Th√°ng n√†y</option>
		    <option value="custom">T√πy ch·ªçn...</option>
		</select>
	    </div>

	    <div class="customDateGroup" style="display: none; gap: 10px; flex: 2; min-width: 250px;">
		<div style="flex:1">
		    <input type="date" class="filterFrom" onchange="syncAndFilter(this)" style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
		</div>
		<div style="flex:1">
		    <input type="date" class="filterTo" onchange="syncAndFilter(this)" style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
		</div>
	    </div>

	    <div style="flex: 1; min-width: 150px;">
		<label style="font-size: 11px; color: var(--primary); font-weight: bold; display: block; margin-bottom: 5px;">KH√ÅCH H√ÄNG</label>
		<select class="filterCust" onchange="syncAndFilter(this)" style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
		    <option value="ALL">T·∫•t c·∫£ kh√°ch h√†ng</option>
		</select>
	    </div>
	</div>

        <input type="text" id="searchBox" onkeyup="filterTable()" placeholder="üîç T√¨m ki·∫øm nhanh (M√°y, kh√°ch, n·ªôi dung...)">
        <div class="table-container">
            <table>
                <thead>
                    <tr><th>Ng√†y l√†m</th><th>Kh√°ch h√†ng</th><th>Lo·∫°i m√°y</th><th>H·ªó tr·ª£</th><th>N·ªôi dung</th><th>K·ªπ thu·∫≠t</th><th>Ghi ch√∫</th></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="form-tab" class="tab-content">
        <div id="formContainer" style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px;">
            <input type="text" id="workDateDisplay" readonly onclick="document.getElementById('dateModal').style.display='flex'">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="customer"><option value="">T·∫£i kh√°ch h√†ng...</option></select>
                <select id="techName"><option value="">T·∫£i k·ªπ thu·∫≠t...</option></select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="machineType"><option value="">-- Lo·∫°i m√°y --</option></select>
                <select id="supportType"><option value="">-- H·ªó tr·ª£ --</option></select>
            </div>
            <textarea id="content" placeholder="M√¥ t·∫£ c√¥ng vi·ªác th·ª±c hi·ªán (B·∫Øt bu·ªôc)..." style="height:100px"></textarea>
            <input type="text" id="note" placeholder="Ghi ch√∫ th√™m (Kh√¥ng b·∫Øt bu·ªôc)...">
            <button class="btn-save" id="btnSave" onclick="saveData()">L∆ØU B√ÅO C√ÅO</button>
        </div>
    </div>

    <div id="meta-tab" class="tab-content">
        <div class="meta-grid">
            <div class="meta-col">
                <h4>KH√ÅCH H√ÄNG</h4>
                <div class="meta-list" id="list-customers"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('customers')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('customers')" style="display:none;">L∆ØU</button>
                </div>
            </div>
            <div class="meta-col">
                <h4>LO·∫†I M√ÅY</h4>
                <div class="meta-list" id="list-machineTypes"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('machineTypes')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('machineTypes')" style="display:none;">L∆ØU</button>
                </div>
            </div>
            <div class="meta-col">
                <h4>K·ª∏ THU·∫¨T</h4>
                <div class="meta-list" id="list-techs"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('techs')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('techs')" style="display:none;">L∆ØU</button>
                </div>
            </div>
            <div class="meta-col">
                <h4>H·ªñ TR·ª¢</h4>
                <div class="meta-list" id="list-supports"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('supports')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('supports')" style="display:none;">L∆ØU</button>
                </div>
            </div>
        </div>
    </div>

    <div id="user-tab" class="tab-content">
    <div style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px;">
            <input type="text" id="u_id" placeholder="User ID (T√™n ƒëƒÉng nh·∫≠p)">
            <input type="text" id="u_name" placeholder="H·ªç t√™n">
            <input type="text" id="u_pass" placeholder="M·∫≠t kh·∫©u">
            <select id="u_role">
		<option value="VIEWER">VIEWER</option>
		<option value="EDIT">EDIT</option>
		<option value="ADMIN">ADMIN</option>
	    </select>
        </div>
          
            
	    
	    <div style="background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid var(--border); overflow: hidden;">
		<div style="padding: 5px 10px; font-size: 11px; color: var(--primary); font-weight: bold; border-bottom: 1px solid var(--border);">
		    QUY·ªÄN TRUY C·∫¨P (CH·ªàNH KH√ÅCH H√ÄNG)
		</div>
		<div id="u_access_checks" style="max-height: 150px; overflow-y: auto; padding: 5px 0;">
		    </div>
	    </div>
	

        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px; margin-top:10px;">
            <button class="btn-save" onclick="addUser()" style="background:#065f46">‚ûï TH√äM</button>
            <button class="btn-save" id="btnUpdateUser" onclick="updateUser()" style="background:#1e3a8a; display:none;">üíæ C·∫¨P NH·∫¨T</button>
	    <button class="btn-save" id="btnDeleteUser" onclick="deleteUser()" style="background:#7f1d1d; display:none;">üóëÔ∏è X√ìA</button>
            <button class="btn-save" onclick="resetUserForm()" style="background:#475569">üßπ L√ÄM M·ªöI</button>
        </div>
    
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>User ID</th>
                    <th>H·ªç t√™n</th>
                    <th>Quy·ªÅn</th>
                    <th>M·∫≠t kh·∫©u</th>
                    <th>Truy c·∫≠p</th>
                </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
        </table>
    </div>
</div>

<div id="doc-tab" class="tab-content">
    <div id="doc-form-container" style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr 1.5fr; gap:10px;">
            <input type="text" id="doc_name" placeholder="T√™n t√†i li·ªáu (VD: HDSD Bi·∫øn t·∫ßn...)">
            <select id="doc_machine_type">
                <option value="">-- Lo·∫°i m√°y --</option>
            </select>
            <input type="text" id="doc_link" placeholder="Link t√†i li·ªáu (Drive, Dropbox...)">
        </div>
        
        <p style="font-size: 12px; color: var(--primary); margin: 10px 0 5px 0;">Ph√¢n quy·ªÅn xem t√†i li·ªáu (Ch·ªçn kh√°ch h√†ng ƒë∆∞·ª£c ph√©p xem - Tr·ªëng = T·∫•t c·∫£):</p>
        <div style="background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid var(--border); overflow: hidden;">
            <div style="display: grid; grid-template-columns: 1fr 80px; background: rgba(255,255,255,0.05); padding: 8px 15px; border-bottom: 1px solid var(--border); font-size: 11px; font-weight: 600; color: var(--text-muted);">
                <div>T√äN KH√ÅCH H√ÄNG</div>
                <div style="text-align: center;">CH·ªåN</div>
            </div>
            <div id="doc_customer_checks" style="max-height: 180px; overflow-y: auto; padding: 5px 0;">
                </div>
        </div>

        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:15px;">
            <button class="btn-save" onclick="addDoc()" style="background:#065f46">‚ûï TH√äM</button>
            <button class="btn-save" id="btnUpdateDoc" onclick="updateDoc()" style="background:#1e3a8a; display:none;">üíæ C·∫¨P NH·∫¨T</button>
            <button class="btn-save" id="btnDeleteDoc" onclick="deleteDoc()" style="background:#7f1d1d; display:none;">üóëÔ∏è X√ìA</button>
            <button class="btn-save" onclick="resetDocForm()" style="background:#475569">üßπ L√ÄM M·ªöI</button>
        </div>
    </div>

    <input type="text" id="searchDoc" onkeyup="filterDocs()" placeholder="üîç T√¨m ki·∫øm t√†i li·ªáu..." style="border: 1px solid var(--primary); background: rgba(0,210,255,0.05);">
    
    <div id="doc_groups_container" style="margin-top: 15px;"></div>
</div>


<div id="infoModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content">
        <h3 style="color:var(--primary); text-align:center; margin:0 0 20px 0">CHI TI·∫æT üîé</h3>
        <div id="modalBody"></div>
        <button class="btn-save" style="margin-top:25px" onclick="document.getElementById('infoModal').style.display='none'">ƒê√ìNG</button>
    </div>
</div>

<div id="dateModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content" style="text-align:center">
        <h4 style="margin:0 0 15px 0">CH·ªåN NG√ÄY L√ÄM VI·ªÜC</h4>
        <input type="date" id="hiddenDate" onchange="confirmDate(this.value)">
        <button class="btn-save" onclick="document.getElementById('dateModal').style.display='none'">X√ÅC NH·∫¨N</button>
    </div>
</div>


<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script>
    // --- FIREBASE CONFIG (ORIGINAL) ---
    const firebaseConfig = {
        apiKey: "AIzaSyC-WW6N3ZzmZ8gk_XypHWa3oW6VJMMGloM",
        authDomain: "data-260206.firebaseapp.com",
        projectId: "data-260206",
        storageBucket: "data-260206.firebasestorage.app",
        messagingSenderId: "992766098254",
        appId: "1:992766098254:web:8e9f5d3216541023d03c1f"
    };
    firebase.initializeApp(firebaseConfig);
// Kh·ªüi t·∫°o Firestore
const db = firebase.firestore();

// Ki·ªÉm tra n·∫øu ch∆∞a thi·∫øt l·∫≠p th√¨ m·ªõi thi·∫øt l·∫≠p, tr√°nh ghi ƒë√® nhi·ªÅu l·∫ßn g√¢y l·ªói logger.ts:115
try {
    db.settings({
        experimentalForceLongPolling: true,
        useFetchStreams: false
    });
} catch (e) {
    console.warn("Firestore settings already configured");
}

    let AUTH = JSON.parse(localStorage.getItem('tech_auth_v4')) || null;
    let USER_ROLE = "VIEWER"; 
    window.currentLogs = [];

    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
        if (tabId === 'data-tab') resetSaveButton();
    }

    document.addEventListener("DOMContentLoaded", () => {
        setInitialDate();
        checkSession();
    });

    function checkSession() {
        const now = new Date().getTime();
        if (AUTH && AUTH.expire && now < AUTH.expire) {
            USER_ROLE = AUTH.role;
            showApp(); fetchData();
        } else {
            localStorage.removeItem('tech_auth_v4');
            document.getElementById('lock-screen').style.display = 'flex';
        }
    }

async function unlock() {
    const email = document.getElementById('userInput').value.trim();
    const pass = document.getElementById('passInput').value.trim();
    
    if (!email || !pass) {
        showToast("Vui l√≤ng nh·∫≠p Email v√† M·∫≠t kh·∫©u", "error");
        return;
    }

    showLoading(true, "ƒêANG X√ÅC TH·ª∞C...");
    try {
        // B∆Ø·ªöC 1: X√°c th·ª±c v·ªõi Firebase Auth (N∆°i qu·∫£n l√Ω ƒëƒÉng nh·∫≠p)
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, pass);
        const userAuth = userCredential.user;

        // B∆Ø·ªöC 2: L·∫•y Role t·ª´ Firestore d·ª±a tr√™n Document ID (ch√≠nh l√† email)
        const userDoc = await db.collection("users").doc(email).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            USER_ROLE = userData.role; // L·∫•y ra "ADMIN" ho·∫∑c "VIEWER"
            
            AUTH = { 
                user: email, 
                uid: userAuth.uid,
                role: USER_ROLE, 
                access: userData.access || "ALL", 
                expire: new Date().getTime() + (24*60*60*1000) 
            };
            
            localStorage.setItem('tech_auth_v4', JSON.stringify(AUTH));
            showApp(); 
            fetchData();
            showToast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!", "success");
        } else { 
            // N·∫øu ƒëƒÉng nh·∫≠p Auth th√†nh c√¥ng nh∆∞ng Firestore kh√¥ng c√≥ ID n√†y
            await firebase.auth().signOut();
            showToast("T√†i kho·∫£n ch∆∞a c√≥ d·ªØ li·ªáu trong b·∫£ng Users!", "error"); 
        }
    } catch (e) { 
        console.error("L·ªói chi ti·∫øt:", e.code, e.message);
        // N·∫øu e.code l√† "auth/user-not-found" ho·∫∑c "auth/wrong-password"
        showToast("Email ho·∫∑c M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!", "error"); 
    }
    showLoading(false);
}

async function signOut() {
    try {
        // 1. G·ªçi l·ªánh ƒëƒÉng xu·∫•t ch√≠nh th·ª©c c·ªßa Firebase
        await firebase.auth().signOut();
        
        // 2. X√≥a d·ªØ li·ªáu x√°c th·ª±c c·ª•c b·ªô
        AUTH = null;
        localStorage.removeItem('tech_auth_v4');
               
        // 3. Chuy·ªÉn v·ªÅ m√†n h√¨nh ƒëƒÉng nh·∫≠p
        document.getElementById('main-content').style.display = 'none';
        document.getElementById('lock-screen').style.display = 'flex';
        
        // 4. Reset c√°c √¥ nh·∫≠p li·ªáu cho s·∫°ch s·∫Ω
        document.getElementById('userInput').value = '';
        document.getElementById('passInput').value = '';
        
        showToast("ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng", "success");

        
    } catch (e) {
        console.error("L·ªói ƒëƒÉng xu·∫•t:", e);
        showToast("Kh√¥ng th·ªÉ ƒëƒÉng xu·∫•t, vui l√≤ng th·ª≠ l·∫°i", "error");
    }
}


function handlePresetChange(el) {
    const preset = el.value;
    const parent = el.closest('.inner-filter-box');
    const customGroup = parent.querySelectorAll('.customDateGroup'); // L·∫•y t·∫•t c·∫£ group ·ªü c√°c tab
    const now = new Date();
    
    let from = '', to = '';

    if (preset === 'today') {
        from = to = now.toISOString().split('T')[0];
    } else if (preset === '7days') {
        const d = new Date();
        d.setDate(d.getDate() - 7);
        from = d.toISOString().split('T')[0];
    } else if (preset === 'thisMonth') {
        from = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    }

    // ƒê·ªìng b·ªô tr·∫°ng th√°i hi·ªÉn th·ªã v√† gi√° tr·ªã cho T·∫§T C·∫¢ c√°c b·ªô l·ªçc ·ªü c√°c tab
    document.querySelectorAll('.timePreset').forEach(s => s.value = preset);
    document.querySelectorAll('.customDateGroup').forEach(g => g.style.display = (preset === 'custom' ? 'flex' : 'none'));
    document.querySelectorAll('.filterFrom').forEach(i => i.value = from);
    document.querySelectorAll('.filterTo').forEach(i => i.value = to);

    syncAndFilter();
}

function syncAndFilter(el) {
    // N·∫øu g·ªçi t·ª´ s·ª± ki·ªán thay ƒë·ªïi, ƒë·ªìng b·ªô gi√° tr·ªã ƒë√≥ sang tab kia
    if(el) {
        if(el.classList.contains('filterFrom')) document.querySelectorAll('.filterFrom').forEach(i => i.value = el.value);
        if(el.classList.contains('filterTo')) document.querySelectorAll('.filterTo').forEach(i => i.value = el.value);
        if(el.classList.contains('filterCust')) document.querySelectorAll('.filterCust').forEach(i => i.value = el.value);
    }

    // L·∫•y gi√° tr·ªã hi·ªán t·∫°i (t·ª´ b·∫•t k·ª≥ b·ªô l·ªçc n√†o v√¨ ch√∫ng ƒë√£ ƒë·ªìng b·ªô)
    const from = document.querySelector('.filterFrom').value;
    const to = document.querySelector('.filterTo').value;
    const cust = document.querySelector('.filterCust').value;

    const filtered = window.rawLogs.filter(row => {
        const date = row[1]; // workDate
        const customer = row[2];
        const mFrom = from ? date >= from : true;
        const mTo = to ? date <= to : true;
        const mCust = cust === "ALL" ? true : customer === cust;
        return mFrom && mTo && mCust;
    });

    // C·∫≠p nh·∫≠t giao di·ªán
    renderData({ logs: [["Header"], ...filtered], role: AUTH.role });
    updateDashboard(filtered);
}


window.rawLogs = []; // Bi·∫øn l∆∞u d·ªØ li·ªáu g·ªëc

function fetchData() {
    if (!AUTH) return;
    let query = db.collection("logs");

    // X·ª≠ l√Ω ph√¢n quy·ªÅn cho VIEWER
    if (AUTH.role === "VIEWER") {
        if (AUTH.access && AUTH.access.trim() !== "" && AUTH.access !== "ALL") {
            const allowedList = AUTH.access.split(",").map(s => s.trim()).filter(s => s !== "");
            if (allowedList.length > 0) {
                query = query.where("customer", "in", allowedList);
            }
        } else if (!AUTH.access || AUTH.access.trim() === "") {
            // N·∫øu VIEWER kh√¥ng c√≥ quy·ªÅn truy c·∫≠p kh√°ch h√†ng n√†o
            window.rawLogs = []; // ƒê·∫£m b·∫£o m·∫£ng r·ªóng thay v√¨ undefined
            renderData({ logs: [["Header"]], role: AUTH.role });
            updateDashboard([]); 
            return;
        }
    }

    query.orderBy("createdAt", "desc").limit(1000).onSnapshot((snapshot) => {
        // L∆ØU D·ªÆ LI·ªÜU V√ÄO BI·∫æN GLOBAL
        window.rawLogs = snapshot.docs.map(doc => {
            const d = doc.data();
            return [doc.id, d.workDate, d.customer, d.machineType, d.support, d.content, d.tech, d.createdBy || "", d.note || ""];
        });

        // C·∫≠p nh·∫≠t danh s√°ch kh√°ch h√†ng v√†o c√°c b·ªô l·ªçc class
        const custs = [...new Set(window.rawLogs.map(l => l[2]))].sort();
        document.querySelectorAll('.filterCust').forEach(select => {
            const currentVal = select.value;
            select.innerHTML = '<option value="ALL">T·∫•t c·∫£ kh√°ch h√†ng</option>' + 
                               custs.map(c => `<option value="${c}">${c}</option>`).join('');
            select.value = currentVal;
        });

        // G·ªçi h√†m l·ªçc ƒë·ªÉ hi·ªÉn th·ªã l√™n Tab 1 v√† Tab 2
        syncAndFilter(); 
        applyPermissions();
    }, (error) => {
        console.error("L·ªói Firestore:", error);
    });

    // Load metadata cho dropdown
    if (AUTH.role === "ADMIN" || AUTH.role === "EDIT") {
        db.collection("metadata").doc("dropdowns").onSnapshot((doc) => {
            if (doc.exists) {
                const d = doc.data();
                updateDropdowns(d);
                if (AUTH.role === "ADMIN") renderMetaBlock(d);
            }
        });
    }
}


    // --- UI RENDER (KH√îI PH·ª§C C·∫§U TR√öC G·ªêC C·ª¶A B·∫†N) ---
    function renderData(data) {
        window.currentLogs = data.logs.slice(1);
        const html = window.currentLogs.map((row, index) => `
            <tr onclick="openInfoModal(${index})">
                <td style="color:var(--text-muted)">${formatVN(row[1])}</td>
                <td><b style="color:var(--primary)">${row[2] || ''}</b></td>
                <td style="font-size:11px"><span class="badge-mec">${row[3] || ''}</span></td>
                <td><small>${row[4] || ''}</small></td>
                <td style="color:#cbd5e1">${(row[5]||"").substring(0,30)}${(row[5]||"").length>30?'...':''}</td>
                <td><span class="badge-tech">${row[6] || ''}</span></td>
                <td style="font-style:italic; color:var(--text-muted); font-size:12px">
                    ${(row[8] || '').substring(0,15)}${(row[8]||'').length > 15 ? '...' : ''}
                </td>
            </tr>
        `).join('');
        document.getElementById('tableBody').innerHTML = html;
        document.getElementById('syncStatus').innerText = "ƒê·ªìng b·ªô: " + new Date().toLocaleTimeString();
    }

    function updateDropdowns(d) {
        const update = (id, list, txt) => {
            const select = document.getElementById(id);
            const val = select.value;
            select.innerHTML = `<option value="">-- ${txt} --</option>` + list.map(i => `<option value="${i}">${i}</option>`).join('');
            select.value = val;
        };
        if(d.customers) update('customer', d.customers, 'Kh√°ch h√†ng');
        if(d.techs) update('techName', d.techs, 'K·ªπ thu·∫≠t');
        if(d.machineTypes) update('machineType', d.machineTypes, 'Lo·∫°i m√°y');
        if(d.supports) update('supportType', d.supports, 'H·ªó tr·ª£');
    }

    // --- POPUP CHI TI·∫æT (KH√îI PH·ª§C C·∫§U TR√öC G·ªêC C·ª¶A B·∫†N) ---
    function openInfoModal(index) {
        const row = window.currentLogs[index];
        const isAdmin = (AUTH && AUTH.role === "ADMIN");
        let modalHtml = `
            <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; border:1px solid var(--border)">
                <div class="detail-grid">
                    <div class="detail-item"><span class="detail-label">üóìÔ∏è Ng√†y l√†m:</span><span class="detail-value">${formatVN(row[1])}</span></div>
                    <div class="detail-item"><span class="detail-label">üïµÔ∏è‚Äç‚ôÇÔ∏è Kh√°ch:</span><span class="detail-value">${row[2]}</span></div>
                    <div class="detail-item"><span class="detail-label">‚öôÔ∏è Lo·∫°i m√°y:</span><span class="detail-value">${row[3] || '---'}</span></div>
                    <div class="detail-item"><span class="detail-label">üìå H·ªó tr·ª£:</span><span class="detail-value">${row[4] || '---'}</span></div>
                    <div class="detail-item"><span class="detail-label">üë∑‚Äç‚ôÇÔ∏è K·ªπ thu·∫≠t:</span><span class="detail-value">${row[6]}</span></div>
                    <div class="detail-item"><span class="detail-label">ü™™ User:</span><span class="detail-value">${row[7] || '---'}</span></div>
                </div>
                <div style="margin-top:10px; border-top:1px solid var(--border); padding-top:10px">
                    <p style="margin:0 0 5px 0; color:var(--text-muted); font-size:11px; font-weight:600">üìù N·ªòI DUNG:</p>
                    <div style="white-space:pre-wrap; color:#fff; background:rgba(0,0,0,0.3); padding:12px; border-radius:10px; font-size:14px;">${row[5]}</div>
                </div>
                <div style="margin-top:10px">
                    <p style="margin:0 0 5px 0; color:var(--text-muted); font-size:11px; font-weight:600">üóíÔ∏è GHI CH√ö:</p>
                    <div style="color:var(--primary); font-style:italic; font-size:13px">${row[8] || 'Kh√¥ng c√≥ ghi ch√∫.'}</div>
                </div>
            </div>
        `;
        if (isAdmin) {
            modalHtml += `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px">
                <button onclick="deleteLog('${row[0]}')" style="background:#450a0a; color:#f87171; border:1px solid #7f1d1d; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold">üóëÔ∏è X√ìA</button>
                <button onclick="editLog(${index})" style="background:#1e1b4b; color:#818cf8; border:1px solid #312e81; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold">‚úèÔ∏è S·ª¨A</button>
            </div>`;
        }
        document.getElementById('modalBody').innerHTML = modalHtml;
        document.getElementById('infoModal').style.display = 'flex';
    }

    // --- TAB 3 LOGIC (THEO Y√äU C·∫¶U M·ªöI) ---
    function renderMetaBlock(data) {
        const renderCol = (id, list) => {
            const container = document.getElementById('list-' + id);
            const fullList = [...(list || []), "", "", ""]; // Th√™m d√≤ng tr·ªëng ƒë·ªÉ nh·∫≠p m·ªõi
            container.innerHTML = fullList.map(v => `<div class="meta-item"><input type="text" value="${v}" readonly></div>`).join('');
        };
        renderCol('customers', data.customers);
        renderCol('machineTypes', data.machineTypes);
        renderCol('techs', data.techs);
        renderCol('supports', data.supports);
    }

function enableMetaEdit(id) {
    // 1. M·ªü kh√≥a c√°c √¥ input ƒë·ªÉ s·ª≠a
    document.querySelectorAll(`#list-${id} .meta-item`).forEach(item => {
        item.classList.add('editing');
        const input = item.querySelector('input');
        if (input) input.readOnly = false;
    });

    // 2. T√¨m khu v·ª±c ch·ª©a n√∫t (meta-actions) c·ªßa ri√™ng c·ªôt ƒë√≥
    const parentCol = document.getElementById(`list-${id}`).closest('.meta-col');
    const btnEdit = parentCol.querySelector('.btn-edit-mode');
    const btnSave = parentCol.querySelector('.btn-save-mode');

    // 3. ·∫®n S·ª≠a, Hi·ªán L∆∞u
    if (btnEdit) btnEdit.style.display = 'none';
    if (btnSave) btnSave.style.display = 'block';

    showToast("ƒê√£ m·ªü ch·∫ø ƒë·ªô s·ª≠a!", "info");
}

async function saveMetaData(id) {
    const inputs = document.querySelectorAll(`#list-${id} input`);
    const newList = [...new Set(Array.from(inputs).map(i => i.value.trim()).filter(v => v !== ""))];
    
    showLoading(true, "ƒêANG L∆ØU...");
    
    try {
        // S·ª¨A T·∫†I ƒê√ÇY: ƒê∆∞·ªùng d·∫´n ƒë√∫ng l√† Collection "metadata" -> Document "dropdowns"
        // S·ª≠ d·ª•ng .set v·ªõi { merge: true } ƒë·ªÉ an to√†n n·∫øu document ch∆∞a t·ªìn t·∫°i
        await db.collection("metadata").doc("dropdowns").set({
            [id]: newList 
        }, { merge: true });

        // --- Logic x·ª≠ l√Ω giao di·ªán (Gi·ªØ nguy√™n) ---
        document.querySelectorAll(`#list-${id} .meta-item`).forEach(item => {
            item.classList.remove('editing');
            const input = item.querySelector('input');
            if (input) input.readOnly = true;
        });

        const parentCol = document.getElementById(`list-${id}`).closest('.meta-col');
        const btnEdit = parentCol.querySelector('.btn-edit-mode');
        const btnSave = parentCol.querySelector('.btn-save-mode');

        if (btnSave) btnSave.style.display = 'none';
        if (btnEdit) btnEdit.style.display = 'block';

        showToast("ƒê√£ l∆∞u th√†nh c√¥ng!", "success");
        
        // C·∫≠p nh·∫≠t l·∫°i giao di·ªán
        if(typeof fetchMeta === 'function') fetchMeta();

    } catch (e) {
        console.error("L·ªói c·∫≠p nh·∫≠t Firestore:", e);
        showToast("L·ªói: " + e.message, "error");
    } finally {
        showLoading(false);
    }
}

    // --- OTHER LOGIC (GI·ªÆ NGUY√äN G·ªêC) ---
async function saveData() {
    const d = document.getElementById('hiddenDate').value;
    const c = document.getElementById('customer').value;
    const n = document.getElementById('content').value.trim();
    
    if(!c || !n) return showToast("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin!", "error");
    
    showLoading(true, "ƒêANG L∆ØU...");
    try {
        await db.collection("logs").add({
            workDate: d, 
            customer: c, 
            tech: document.getElementById('techName').value,
            machineType: document.getElementById('machineType').value,
            support: document.getElementById('supportType').value,
            content: n, 
            note: document.getElementById('note').value.trim(),
            createdBy: AUTH.user, // Email ng∆∞·ªùi t·∫°o
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast("ƒê√£ l∆∞u b√°o c√°o!", "success");
        resetSaveButton(); 
        fetchData(); // T·∫£i l·∫°i d·ªØ li·ªáu m·ªõi sau khi l∆∞u th√†nh c√¥ng
        switchTab('dashboard', document.querySelector('.tab-btn'));
    } catch (e) { 
        console.error("L·ªói chi ti·∫øt:", e); // ƒê·ªÉ b·∫°n xem l·ªói ·ªü F12
        showToast("L·ªói khi l∆∞u! " + e.message, "error"); 
    }
    showLoading(false);
}

function deleteLog(id) {
    const confirmHtml = `
        <div style="min-width: 200px;">
            <p style="margin: 0 0 12px 0; font-weight: 600;">üóëÔ∏è X√ìA B√ÅO C√ÅO N√ÄY?</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button id="logNo" style="background: #475569; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">KH√îNG</button>
                <button id="logYes" style="background: #7f1d1d; color: #f87171; border: 1px solid #7f1d1d; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">X√ìA</button>
            </div>
        </div>
    `;

    const t = showToast("", "error", confirmHtml);

    t.querySelector('#logNo').onclick = () => t.remove();
    
    t.querySelector('#logYes').onclick = async () => {
        t.remove();
        showLoading(true, "ƒêANG X√ìA...");
        await db.collection("logs").doc(id).delete();
        document.getElementById('infoModal').style.display = 'none';
        showLoading(false);
        showToast("ƒê√£ x√≥a xong!", "success");
    };
}

    function editLog(index) {
        const row = window.currentLogs[index];
        document.getElementById('infoModal').style.display = 'none';
        switchTab('form-tab', document.querySelectorAll('.tab-btn')[1]);
        document.getElementById('hiddenDate').value = row[1];
        document.getElementById('workDateDisplay').value = formatVN(row[1]);
        document.getElementById('customer').value = row[2];
        document.getElementById('machineType').value = row[3];
        document.getElementById('supportType').value = row[4];
        document.getElementById('content').value = row[5];
        document.getElementById('techName').value = row[6];
        document.getElementById('note').value = row[8] || "";
        const btn = document.getElementById('btnSave');
        btn.innerHTML = "üíæ C·∫¨P NH·∫¨T";
        btn.onclick = async () => {
            showLoading(true);
            await db.collection("logs").doc(row[0]).update({
                workDate: document.getElementById('hiddenDate').value,
                customer: document.getElementById('customer').value,
                content: document.getElementById('content').value.trim(),
                note: document.getElementById('note').value.trim(),
                tech: document.getElementById('techName').value,
                machineType: document.getElementById('machineType').value,
                support: document.getElementById('supportType').value
            });
            showLoading(false); resetSaveButton(); switchTab('dashboard', document.querySelector('.tab-btn'));
        };
    }

    function resetSaveButton() {
        const btn = document.getElementById('btnSave');
        btn.innerHTML = "L∆ØU B√ÅO C√ÅO";
        btn.onclick = saveData;
        document.getElementById('content').value = '';
        document.getElementById('note').value = '';
    }


// Bi·∫øn l∆∞u tr·ªØ h√†m click g·ªëc ƒë·ªÉ kh√¥i ph·ª•c khi l√† Admin
let originalHandleDocClick = null;

function applyPermissions() {
    const currentRole = AUTH ? AUTH.role : "VIEWER";
    
    // L∆∞u l·∫°i h√†m click g·ªëc n·∫øu ch∆∞a l∆∞u (ƒë·ªÉ kh√¥i ph·ª•c cho Admin)
    if (!originalHandleDocClick && typeof handleDocClick === 'function') {
        originalHandleDocClick = handleDocClick;
    }

    // 1. L·∫•y t·∫•t c·∫£ c√°c tab n·ªôi dung v√† n√∫t b·∫•m
    const allTabs = ['form-tab', 'meta-tab', 'user-tab'];
    const allButtons = ['btnTabMeta', 'btnTabUser'];
    const docFormContainer = document.getElementById('doc-form-container');
    const navButtons = document.querySelectorAll('.tab-btn');

    if (currentRole === "VIEWER") {
        // --- CH·∫æ ƒê·ªò VIEWER: ·∫®N ƒêI ---
        
        // ·∫®n c√°c tab qu·∫£n tr·ªã
        allTabs.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });

        // ·∫®n c√°c n√∫t tr√™n thanh ƒëi·ªÅu h∆∞·ªõng
        allButtons.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });

        // ·∫®n n√∫t "B√°o c√°o m·ªõi"
        navButtons.forEach(btn => {
            if(btn.onclick && btn.onclick.toString().includes('form-tab')) {
                btn.style.display = 'none';
            }
        });

        // ·∫®N Form nh·∫≠p t√†i li·ªáu (D√πng display none thay v√¨ remove)
        if (docFormContainer) {
            docFormContainer.style.display = 'none';
        }

        // Ch·∫∑n m·ªü form s·ª≠a khi viewer click (ch·ªâ m·ªü link)
        window.handleDocClick = (id, name, link) => window.open(link, '_blank');

    } else {
        // --- CH·∫æ ƒê·ªò ADMIN/EDIT: HI·ªÜN L·∫†I T·∫§T C·∫¢ ---
        
        // Hi·ªán l·∫°i c√°c tab (Tr·ª´ tab User ch·ªâ cho Admin)
        allTabs.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                // Tab User ch·ªâ hi·ªán n·∫øu l√† Admin th·ª±c th·ª•
                if (id === 'user-tab') {
                    el.style.display = (currentRole === "ADMIN") ? '' : 'none';
                } else {
                    el.style.display = ''; 
                }
            }
        });

        // Hi·ªán l·∫°i c√°c n√∫t ƒëi·ªÅu h∆∞·ªõng
        allButtons.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (id === 'btnTabUser') {
                    el.style.display = (currentRole === "ADMIN") ? 'inline-flex' : 'none';
                } else {
                    el.style.display = 'inline-flex';
                }
            }
        });

        // Hi·ªán l·∫°i n√∫t "B√°o c√°o m·ªõi"
        navButtons.forEach(btn => {
            if(btn.onclick && btn.onclick.toString().includes('form-tab')) {
                btn.style.display = 'inline-flex';
            }
        });

        // HI·ªÜN L·∫†I Form nh·∫≠p t√†i li·ªáu
        if (docFormContainer) {
            docFormContainer.style.display = 'block';
        }

        // Kh√¥i ph·ª•c l·∫°i h√†m click g·ªëc ƒë·ªÉ Admin c√≥ th·ªÉ s·ª≠a t√†i li·ªáu
        if (originalHandleDocClick) {
            window.handleDocClick = originalHandleDocClick;
        }
    }

    const tabBar = document.getElementById('tabBar');
    if (tabBar) tabBar.style.display = "flex";
}


function showApp() {
    document.getElementById('lock-screen').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
    
        // C·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng
        if (AUTH && AUTH.user) {
            const helloEl = document.getElementById('helloUser');
            if (helloEl) helloEl.innerText = "Ch√†o, " + AUTH.user;
        }
        
    const nav = document.querySelector('.tab-navigation');
    // Hi·ªán tab T√†i li·ªáu cho m·ªçi Role n·∫øu h·ªç c√≥ quy·ªÅn truy c·∫≠p (access)
    if (AUTH.access && AUTH.access !== "") {
        const docBtn = nav.querySelector('button[onclick*="doc-tab"]');
        if (docBtn) docBtn.style.display = 'inline-flex';
    }
    
    // Hi·ªán tab Qu·∫£n tr·ªã ch·ªâ cho ADMIN/EDIT
    const adminBtn = nav.querySelector('button[onclick*="admin-tab"]');
    if (adminBtn) adminBtn.style.display = (AUTH.role === "ADMIN" || AUTH.role === "EDIT") ? 'inline-flex' : 'none';
}

    function setInitialDate() { const iso = new Date().toISOString().split('T')[0]; document.getElementById('hiddenDate').value = iso; document.getElementById('workDateDisplay').value = formatVN(iso); }
    function confirmDate(v) { document.getElementById('workDateDisplay').value = formatVN(v); document.getElementById('dateModal').style.display = 'none'; }
    function formatVN(s) { if(!s) return ''; const d = new Date(s); return d.getDate().toString().padStart(2,'0')+'/'+(d.getMonth()+1).toString().padStart(2,'0')+'/'+d.getFullYear(); }
    function filterTable() { const v = document.getElementById('searchBox').value.toUpperCase(); const rows = document.getElementById('tableBody').getElementsByTagName('tr'); for (let r of rows) r.style.display = r.innerText.toUpperCase().includes(v) ? "" : "none"; }
    function showLoading(s, t) { document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none'; if(t) document.getElementById('loading-text').innerText = t; }
    
    function showToast(m, type, htmlContent = "") {
    const c = document.getElementById('toast-container');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.style.pointerEvents = "auto"; // Cho ph√©p t∆∞∆°ng t√°c v·ªõi n√∫t b·∫•m b√™n trong
    
    if (htmlContent) {
        t.innerHTML = htmlContent;
    } else {
        t.innerText = m;
    }
    
    c.appendChild(t);
    
    // N·∫øu kh√¥ng c√≥ n·ªôi dung HTML (toast th√¥ng th∆∞·ªùng) th√¨ t·ª± bi·∫øn m·∫•t sau 2.5s
    if (!htmlContent) {
        setTimeout(() => t.remove(), 2500);
    }
    return t; // Tr·∫£ v·ªÅ element ƒë·ªÉ c√≥ th·ªÉ ch·ªß ƒë·ªông remove khi b·∫•m n√∫t
}
    // --- LOGIC QU·∫¢N L√ù T√ÄI KHO·∫¢N (TAB 4) ---

// 1. T·ª± ƒë·ªông l·∫•y danh s√°ch user khi tab m·ªü
function fetchUsers() {
    if (AUTH.role !== "ADMIN") return;
    db.collection("users").onSnapshot((snapshot) => {
        const html = snapshot.docs.map(doc => {
            const u = doc.data();
            return `
                <tr onclick="loadUserToForm('${doc.id}', '${u.name}', '${u.role}', '${u.pass}', '${u.access || ""}')">
                    <td><b style="color:var(--primary)">${doc.id}</b></td>
                    <td>${u.name}</td>
                    <td><span class="badge-tech">${u.role}</span></td>
                    <td>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                    <td style="font-size:11px; color:var(--text-muted)">${u.access || 'ALL'}</td>
                </tr>
            `;
        }).join('');
        document.getElementById('userTableBody').innerHTML = html;
    });
}

// 2. Load d·ªØ li·ªáu t·ª´ b·∫£ng l√™n form khi k√≠ch v√†o d√≤ng
function loadUserToForm(id, name, role, pass, access) {
    document.getElementById('u_id').value = id;
    document.getElementById('u_id').readOnly = true;
    document.getElementById('u_name').value = name;
    document.getElementById('u_role').value = role;
    document.getElementById('u_pass').value = pass;
    
    // X·ª≠ l√Ω Checkbox quy·ªÅn truy c·∫≠p
    const allowedList = (access || "").split(",").map(s => s.trim());
    const checks = document.querySelectorAll('input[name="user_cust"]');
    checks.forEach(ch => {
        ch.checked = allowedList.includes(ch.value);
    });
	// TH√äM 2 D√íNG N√ÄY ƒê·ªÇ HI·ªÜN N√öT
    document.getElementById('btnUpdateUser').style.display = 'block';
    document.getElementById('btnDeleteUser').style.display = 'block';
    showToast("ƒê√£ ch·ªçn user: " + id, "info");
}

// 3. Th√™m User m·ªõi
async function addUser() {
    const id = document.getElementById('u_id').value.trim(); // ƒê√¢y ch√≠nh l√† Email
    const pass = document.getElementById('u_pass').value.trim();
    
    if(!id) return showToast("Vui l√≤ng nh·∫≠p Email l√†m User ID", "error");
    if(pass.length < 6) return showToast("M·∫≠t kh·∫©u ph·∫£i t·ª´ 6 k√Ω t·ª± tr·ªü l√™n", "error");

    const selectedAccess = Array.from(document.querySelectorAll('input[name="user_cust"]:checked'))
                        .map(cb => cb.value)
                        .join(', ') || "ALL"; // N·∫øu v·∫ø tr√°i r·ªóng, l·∫•y "ALL"

    showLoading(true, "ƒêANG T·∫†O T√ÄI KHO·∫¢N...");

    try {
        // --- B∆Ø·ªöC 1: T·∫†O T√ÄI KHO·∫¢N TR√äN GOOGLE AUTHENTICATION ---
        // S·ª≠ d·ª•ng m·ªôt instance ph·ª• ƒë·ªÉ tr√°nh b·ªã logout t√†i kho·∫£n Admin hi·ªán t·∫°i
        const secondaryApp = firebase.initializeApp(firebaseConfig, "SecondaryContext");
        
        try {
            await secondaryApp.auth().createUserWithEmailAndPassword(id, pass);
        } catch (authError) {
            // N·∫øu email ƒë√£ t·ªìn t·∫°i trong Auth, ta v·∫´n ti·∫øp t·ª•c c·∫≠p nh·∫≠t Firestore 
            // ho·∫∑c b√°o l·ªói t√πy b·∫°n. ·ªû ƒë√¢y t√¥i s·∫Ω b√°o l·ªói n·∫øu tr√πng.
            if (authError.code === 'auth/email-already-in-use') {
                throw new Error("Email n√†y ƒë√£ ƒë∆∞·ª£c t·∫°o t√†i kho·∫£n ƒëƒÉng nh·∫≠p r·ªìi!");
            }
            throw authError;
        }

        // --- B∆Ø·ªöC 2: L∆ØU TH√îNG TIN QUY·ªÄN V√ÄO FIRESTORE (H√ÄM G·ªêC C·ª¶A B·∫†N) ---
        await db.collection("users").doc(id).set({
            name: document.getElementById('u_name').value,
            role: document.getElementById('u_role').value,
            pass: pass, // L∆∞u pass v√†o ƒë√¢y ch·ªâ ƒë·ªÉ Admin ti·ªán theo d√µi (t√πy ch·ªçn)
            access: selectedAccess
        });

        // X√≥a instance ph·ª• sau khi xong
        await secondaryApp.delete();

        showToast("ƒê√£ t·∫°o t√†i kho·∫£n th√†nh c√¥ng!", "success");
        resetUserForm();
        if(typeof fetchUsers === 'function') fetchUsers(); // Load l·∫°i danh s√°ch

    } catch (e) { 
        showToast("L·ªói: " + e.message, "error"); 
    } finally {
        showLoading(false);
    }
}

// 4. C·∫≠p nh·∫≠t User
async function updateUser() {
    const id = document.getElementById('u_id').value.trim();
    const selectedAccess = Array.from(document.querySelectorAll('input[name="user_cust"]:checked'))
                        .map(cb => cb.value)
                        .join(', ') || "ALL"; // N·∫øu v·∫ø tr√°i r·ªóng, l·∫•y "ALL"
    showLoading(true, "ƒêANG C·∫¨P NH·∫¨T...");
    try {
        await db.collection("users").doc(id).update({
            name: document.getElementById('u_name').value,
            role: document.getElementById('u_role').value,
            pass: document.getElementById('u_pass').value,
            access: selectedAccess // S·ª≠ d·ª•ng danh s√°ch ƒë√£ ch·ªçn
        });
        showToast("ƒê√£ c·∫≠p nh·∫≠t!", "success");
    } catch (e) { showToast("L·ªói khi c·∫≠p nh·∫≠t!", "error"); }
    showLoading(false);
}

// 5. X√≥a User
function deleteUser() {
    const id = document.getElementById('u_id').value.trim();
    if (!id) return showToast("Vui l√≤ng ch·ªçn t√†i kho·∫£n c·∫ßn x√≥a!", "error");

    const confirmHtml = `
        <div style="min-width: 220px;">
            <p style="margin: 0 0 5px 0; font-weight: 600; color: #f87171;">‚ö†Ô∏è X√ìA T√ÄI KHO·∫¢N?</p>
            <p style="margin: 0 0 12px 0; font-size: 13px; color: #cbd5e1;">X√°c nh·∫≠n x√≥a user: <b>${id}</b></p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button id="userNo" style="background: #475569; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">H·ª¶Y</button>
                <button id="userYes" style="background: #7f1d1d; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">X√ìA USER</button>
            </div>
        </div>
    `;

    const t = showToast("", "error", confirmHtml);

    // H·ªßy b·ªè
    t.querySelector('#userNo').onclick = () => t.remove();
    
    // ƒê·ªìng √Ω x√≥a
    t.querySelector('#userYes').onclick = async () => {
        t.remove();
        showLoading(true, "ƒêANG X√ìA T√ÄI KHO·∫¢N...");
        try {
            await db.collection("users").doc(id).delete();
            showToast("ƒê√£ x√≥a t√†i kho·∫£n " + id, "success");
            resetUserForm();
        } catch (e) {
            showToast("L·ªói khi x√≥a: " + e.message, "error");
        }
        showLoading(false);
    };
}
function resetUserForm() {
    document.getElementById('u_id').value = "";
    document.getElementById('u_id').readOnly = false;
    document.getElementById('u_name').value = "";
    document.getElementById('u_pass').value = "";
    // B·ªè ch·ªçn t·∫•t c·∫£ checkbox
    document.querySelectorAll('input[name="user_cust"]').forEach(ch => ch.checked = false);
    // ·∫®N c√°c n√∫t C·∫≠p nh·∫≠t v√† X√≥a
    document.getElementById('btnUpdateUser').style.display = 'none';
    document.getElementById('btnDeleteUser').style.display = 'none';
}

// C·∫≠p nh·∫≠t h√†m applyPermissions ƒë·ªÉ hi·ªÉn th·ªã tab 4 cho ADMIN
const originalApplyPermissions = applyPermissions;
applyPermissions = function() {
    originalApplyPermissions(); // Ch·∫°y h√†m c≈©
    const currentRole = AUTH ? AUTH.role : USER_ROLE;
    document.getElementById('btnTabUser').style.display = currentRole === "ADMIN" ? "block" : "none";
    if(currentRole === "ADMIN") fetchUsers();
};
    let selectedDocId = null;

// 1. Load danh s√°ch kh√°ch h√†ng v√†o Checkbox (Ch·ªâ g·ªçi khi l√† Admin/Edit)
function loadCustomerCheckboxes(customers) {
    const container = document.getElementById('doc_customer_checks');
    if (!container) return;
    
    if (!customers || customers.length === 0) {
        container.innerHTML = `<div style="padding:15px; text-align:center; font-size:12px; color:var(--text-muted);">Ch∆∞a c√≥ d·ªØ li·ªáu kh√°ch h√†ng.</div>`;
        return;
    }

    container.innerHTML = customers.map(c => `
        <label style="display: grid; grid-template-columns: 1fr 80px; align-items: center; padding: 8px 15px; border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer; transition: 0.2s;" class="cust-row">
            <span style="font-size: 13px; color: var(--text-main);">${c}</span>
            <div style="text-align: center;">
                <input type="checkbox" name="doc_cust" value="${c}" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
            </div>
        </label>
    `).join('');
}

// 2. L·∫•y d·ªØ li·ªáu t√†i li·ªáu
function fetchDocs() {
    db.collection("documents").onSnapshot((snapshot) => {
        const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderDocs(docs);
    });
}

// 3. Hi·ªÉn th·ªã t√†i li·ªáu (ƒê√£ ·∫©n d√≤ng "Quy·ªÅn xem" ƒë·ªëi v·ªõi Viewer)
function renderDocs(docs) {
    const container = document.getElementById('doc_groups_container');
    let filtered = docs;

    if (AUTH.role === "VIEWER") {
        // L√†m s·∫°ch danh s√°ch kh√°ch h√†ng ƒë∆∞·ª£c ph√©p c·ªßa User
        const allowedList = (AUTH.access || "")
            .split(",")
            .map(s => s.trim())
            .filter(s => s !== "");

        filtered = docs.filter(d => {
            if (!d.customers || d.customers.length === 0) return true;
            return d.customers.some(c => allowedList.includes(c.trim()));
        });
    }

    const groups = {};
    if (filtered.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-muted);">B·∫°n kh√¥ng c√≥ quy·ªÅn xem t√†i li·ªáu n√†o ho·∫∑c ch∆∞a c√≥ t√†i li·ªáu.</div>`;
        return;
    }
    
    filtered.forEach(d => {
        const type = d.machineType || "KH√ÅC / CH∆ØA PH√ÇN LO·∫†I";
        if (!groups[type]) groups[type] = [];
        groups[type].push(d);
    });

    container.innerHTML = Object.keys(groups).sort().map(groupName => `
        <div class="doc-group-section" style="margin-bottom: 20px;">
            <div style="background: rgba(0, 210, 255, 0.1); padding: 8px 15px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid var(--primary);">
                <span style="color: var(--primary); font-weight: 600; font-size: 14px;">üì¶ NH√ìM: ${groupName}</span>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                ${groups[groupName].map(d => {
                    const custsAttr = encodeURIComponent(JSON.stringify(d.customers || []));
                    
                    // --- LOGIC M·ªöI: Ch·ªâ hi·ªÉn th·ªã d√≤ng Quy·ªÅn xem n·∫øu KH√îNG PH·∫¢I viewer ---
                    const accessInfoHtml = (AUTH.role !== "VIEWER") 
                        ? `<div style="font-size:11px; color:var(--text-muted); margin: 5px 0 10px 0;">
                               <span style="color:var(--primary)">üë§ Quy·ªÅn xem:</span> ${(!d.customers || d.customers.length === 0) ? 'T·∫•t c·∫£' : d.customers.join(', ')}
                           </div>`
                        : `<div style="margin-top: 15px;"></div>`; // Viewer s·∫Ω th·∫•y kho·∫£ng tr·ªëng s·∫°ch s·∫Ω

                    return `
                        <div class="meta-col" style="cursor:pointer;" onclick="handleDocClick('${d.id}', '${d.name}', '${d.link}', '${custsAttr}', '${d.machineType || ""}')">
                            <h4 style="border:none; margin:0; text-align:left; font-size:14px;">üìÑ ${d.name}</h4>
                            
                            ${accessInfoHtml}

                            <a href="${d.link}" target="_blank" onclick="event.stopPropagation()" 
                               style="background:var(--primary); color:var(--dark); text-decoration:none; padding:8px; border-radius:6px; text-align:center; font-weight:600; font-size:11px; text-transform:uppercase;">
                               XEM T√ÄI LI·ªÜU
                            </a>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `).join('');
}

// Th√™m tham s·ªë mType v√†o click
function handleDocClick(id, name, link, encodedCusts, mType) {
    if (AUTH.role === "VIEWER") return; 
    selectedDocId = id;
    document.getElementById('doc_name').value = name;
    document.getElementById('doc_link').value = link;
    document.getElementById('doc_machine_type').value = mType; // Load lo·∫°i m√°y
    
    // Load checkbox ph√¢n quy·ªÅn (Gi·ªØ nguy√™n logic c·ªßa b·∫°n)
    const custs = JSON.parse(decodeURIComponent(encodedCusts));
    const checks = document.querySelectorAll('input[name="doc_cust"]');
    checks.forEach(ch => {
        ch.checked = custs.includes(ch.value);
    });
    
    document.getElementById('btnUpdateDoc').style.display = 'block';
    document.getElementById('btnDeleteDoc').style.display = 'block';
    showToast("ƒêang s·ª≠a: " + name, "info");
}

// 4. L∆∞u t√†i li·ªáu m·ªõi (Bao g·ªìm c·∫£ Lo·∫°i m√°y v√† Danh s√°ch kh√°ch h√†ng)
async function addDoc() {
    const name = document.getElementById('doc_name').value.trim();
    const link = document.getElementById('doc_link').value.trim();
    const mType = document.getElementById('doc_machine_type').value;
    if (!name || !link) return showToast("Thi·∫øu t√™n ho·∫∑c link!", "error");

    const selectedCusts = Array.from(document.querySelectorAll('input[name="doc_cust"]:checked')).map(cb => cb.value);
    
    showLoading(true, "ƒêANG L∆ØU...");
    await db.collection("documents").add({
        name, link, machineType: mType, customers: selectedCusts, createdBy: AUTH.user, createdAt: firebase.firestore.FieldValue.serverTimestamp()
            
    });
    resetDocForm();
    showLoading(false);
}

// 5. C·∫≠p nh·∫≠t (Update) t∆∞∆°ng t·ª±
async function updateDoc() {
    const selectedCusts = Array.from(document.querySelectorAll('input[name="doc_cust"]:checked')).map(cb => cb.value);
    showLoading(true, "ƒêANG C·∫¨P NH·∫¨T...");
    await db.collection("documents").doc(selectedDocId).update({
        name: document.getElementById('doc_name').value,
        link: document.getElementById('doc_link').value,
        machineType: document.getElementById('doc_machine_type').value,
        customers: selectedCusts
    });
    resetDocForm();
    showLoading(false);
}
function resetDocForm() {
    selectedDocId = null;
    document.getElementById('doc_name').value = "";
    document.getElementById('doc_link').value = "";
    document.getElementById('doc_machine_type').value = ""; // Reset dropdown
    document.querySelectorAll('input[name="doc_cust"]').forEach(ch => ch.checked = false);
    document.getElementById('btnUpdateDoc').style.display = 'none';
    document.getElementById('btnDeleteDoc').style.display = 'none';
}


function deleteDoc() {
    const confirmHtml = `
        <div style="min-width: 200px;">
            <p style="margin: 0 0 12px 0; font-weight: 600;">‚ö†Ô∏è X√ìA T√ÄI LI·ªÜU N√ÄY?</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button id="btnNo" style="background: #475569; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">H·ª¶Y</button>
                <button id="btnYes" style="background: #ef4444; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">X√ìA NGAY</button>
            </div>
        </div>
    `;

    const t = showToast("", "info", confirmHtml);

    // X·ª≠ l√Ω s·ª± ki·ªán khi ng∆∞·ªùi d√πng b·∫•m n√∫t
    t.querySelector('#btnNo').onclick = () => t.remove();
    
    t.querySelector('#btnYes').onclick = async () => {
        t.remove(); // X√≥a h·ªôp tho·∫°i h·ªèi
        showLoading(true, "ƒêANG X√ìA...");
        try {
            await db.collection("documents").doc(selectedDocId).delete();
            showToast("ƒê√£ x√≥a t√†i li·ªáu!", "success");
            resetDocForm();
        } catch (e) {
            showToast("L·ªói: " + e.message, "error");
        }
        showLoading(false);
    };
}


function filterDocs() {
    const val = document.getElementById('searchDoc').value.toUpperCase();
    const cards = document.querySelectorAll('#doc_list .meta-col');
    cards.forEach(c => c.style.display = c.innerText.toUpperCase().includes(val) ? "" : "none");
}

// C·∫≠p nh·∫≠t h√†m applyPermissions ƒë·ªÉ hi·ªÉn th·ªã tab 5
const finalApplyPermissions = applyPermissions;
applyPermissions = function() {
    finalApplyPermissions();
    const currentRole = AUTH ? AUTH.role : USER_ROLE;
    // Tab t√†i li·ªáu hi·ªán v·ªõi t·∫•t c·∫£ m·ªçi ng∆∞·ªùi, nh∆∞ng Form th√™m x√≥a ch·ªâ hi·ªán v·ªõi Admin/Edit
    document.getElementById('btnTabDoc').style.display = "block"; 
    fetchDocs();
    
    // N·∫øu l√† Viewer, ·∫©n form nh·∫≠p t√†i li·ªáu
    const docForm = document.querySelector('#doc-tab > div:first-child');
    if(currentRole === "VIEWER") docForm.style.display = 'none';
    else docForm.style.display = 'block';
};

// C·∫≠p nh·∫≠t h√†m updateDropdowns ƒë·ªÉ load checkbox kh√°ch h√†ng
const originalUpdateDropdowns = updateDropdowns;
updateDropdowns = function(d) {
    originalUpdateDropdowns(d);
    if(d.customers) loadCustomerCheckboxes(d.customers);
    // TH√äM D√íNG N√ÄY:
	if(d.machineTypes) {
		const docMachineSelect = document.getElementById('doc_machine_type');
		const currentVal = docMachineSelect.value;
		docMachineSelect.innerHTML = '<option value="">-- Lo·∫°i m√°y --</option>' + 
		    d.machineTypes.map(m => `<option value="${m}">${m}</option>`).join('');
		docMachineSelect.value = currentVal;
	}
};

function loadUserAccessCheckboxes(customers) {
    const container = document.getElementById('u_access_checks');
    if (!container || !customers) return;
    
    container.innerHTML = customers.map(c => `
        <label style="display: flex; align-items: center; padding: 5px 15px; cursor: pointer;" class="cust-row">
            <input type="checkbox" name="user_cust" value="${c}" style="width: 16px; height: 16px; margin-right: 10px; accent-color: var(--primary);">
            <span style="font-size: 13px;">${c}</span>
        </label>
    `).join('');
}

// C·∫≠p nh·∫≠t l·∫°i h√†m updateDropdowns ƒë·ªÉ g·ªçi h√†m tr√™n
const oldUpdateDropdowns = updateDropdowns;
updateDropdowns = function(d) {
    oldUpdateDropdowns(d);
    if(d.customers) {
        loadCustomerCheckboxes(d.customers); // Cho Tab 5
        loadUserAccessCheckboxes(d.customers); // Cho Tab 4
    }
};


let charts = {}; // L∆∞u tr·ªØ c√°c ƒë·ªëi t∆∞·ª£ng bi·ªÉu ƒë·ªì ƒë·ªÉ reset khi d·ªØ li·ªáu ƒë·ªïi

function updateDashboard(logs) {
    const stats = {
        cust: {},
        machine: {},
        staff: {},
        support: {}
    };

    // Truy c·∫≠p theo ƒë√∫ng ch·ªâ m·ª•c (index) trong m·∫£ng logs ƒë√£ map ·ªü fetchData
    logs.forEach(log => {
        // log[2]: Kh√°ch h√†ng, log[3]: Lo·∫°i m√°y, log[4]: H·ªó tr·ª£, log[6]: K·ªπ thu·∫≠t
        const customer = log[2];
        const machine = log[3];
        const support = log[4];
        const staff = log[6];

        if (customer) stats.cust[customer] = (stats.cust[customer] || 0) + 1;
        if (machine) stats.machine[machine] = (stats.machine[machine] || 0) + 1;
        if (staff) stats.staff[staff] = (stats.staff[staff] || 0) + 1;
        if (support) stats.support[support] = (stats.support[support] || 0) + 1;
    });

    // V·∫Ω l·∫°i bi·ªÉu ƒë·ªì v·ªõi d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ƒë·∫øm ch√≠nh x√°c
    renderChart("chartCust", "S·ªë l·∫ßn theo Kh√°ch h√†ng", stats.cust, 'bar');
    renderChart("chartMachine", "S·ªë l·∫ßn theo Lo·∫°i m√°y", stats.machine, 'bar');
    renderChart("chartStaff", "S·ªë l·∫ßn theo K·ªπ thu·∫≠t", stats.staff, 'bar');
    renderChart("chartSupport", "S·ªë l·∫ßn theo Lo·∫°i h·ªó tr·ª£", stats.support, 'bar');
}

function renderChart(canvasId, label, dataObj, type) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (charts[canvasId]) charts[canvasId].destroy();

    const sortedEntries = Object.entries(dataObj).sort((a, b) => b[1] - a[1]);
    const labels = sortedEntries.map(el => el[0]);
    const values = sortedEntries.map(el => el[1]);

    const isCust = (canvasId === "chartCust" || canvasId === "chartMachine");

    charts[canvasId] = new Chart(ctx, {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: values,
                backgroundColor: 'rgba(0, 210, 255, 0.7)',
                borderColor: '#00d2ff',
                borderWidth: 1,
                borderRadius: 5,
                // ƒêi·ªÅu ch·ªânh ƒë·ªô r·ªông c·ªôt ·ªü ƒë√¢y
                barPercentage: 0.6, 
                categoryPercentage: 0.7,
                // Gi·ªõi h·∫°n ƒë·ªô d√†y t·ªëi ƒëa c·ªßa c·ªôt ƒë·ªÉ kh√¥ng b·ªã "d√†i ra" qu√° m·ª©c
                maxBarThickness: isCust ? 20 : 35 
            }]
        },
        options: {
            indexAxis: isCust ? 'y' : 'x',
            responsive: true,
            maintainAspectRatio: false, 
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { 
                        display: isCust ? false : true, 
                        color: 'rgba(255,255,255,0.05)' 
                    },
                    ticks: { 
                        color: '#94a3b8', 
                        font: { size: 10 },
                        stepSize: 1
                    }
                },
                x: {
                    beginAtZero: true,
                    grid: { 
                        display: isCust ? true : false, 
                        color: 'rgba(255,255,255,0.05)' 
                    },
                    ticks: { 
                        color: '#94a3b8', 
                        font: { size: 10 }
                    }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}


// T·ª± ƒë·ªông ch·∫°y m·ªói khi trang web ƒë∆∞·ª£c load ho·∫∑c F5
firebase.auth().onAuthStateChanged(async (user) => {
    if (user) {
        const email = user.email;
        try {
            const userDoc = await db.collection("users").doc(email).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                AUTH = { 
                    user: email, 
                    uid: user.uid,
                    role: userData.role, 
                    access: userData.access || "ALL"
                };
                
                showApp();
                fetchData();
                if(typeof fetchDocs === 'function') fetchDocs();
            }
        } catch (e) {
            console.error("L·ªói ƒë·ªìng b·ªô d·ªØ li·ªáu khi F5:", e);
        }
    } else {
        // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p, ƒë·∫£m b·∫£o hi·ªán m√†n h√¨nh kh√≥a
        const lockScreen = document.getElementById('lock-screen');
        const mainContent = document.getElementById('main-content');
        if (lockScreen) lockScreen.style.display = 'flex';
        if (mainContent) mainContent.style.display = 'none';
    }
});

</script>
<footer class="main-footer">
    <div class="footer-content">
        <div class="footer-section">
            <h3 class="footer-logo">üõ†Ô∏è TECH<span>LOG</span></h3>
            <p>H·ªá th·ªëng qu·∫£n l√Ω b√°o c√°o k·ªπ thu·∫≠t & th∆∞ vi·ªán t√†i li·ªáu.</p>
        </div>
        
        <div class="footer-section">
            <h4>LI√äN K·∫æT</h4>
            <div class="footer-links">
                <a href="#" onclick="switchTab('dashboard-tab', this)">T·ªïng quan</a>
                <a href="#" onclick="switchTab('doc-tab', this)">Th∆∞ vi·ªán</a>
            </div>
        </div>

        <div class="footer-section">
            <h4>H·ªñ TR·ª¢</h4>
            <p>üìû Hotline: 0971.64.64.03</p>
        </div>
    </div>
    
    <div class="footer-bottom">
        <p>&copy; 2026 Laser</p>
        <div class="status-indicator">
            <span class="dot"></span> H·ªá th·ªëng ƒëang tr·ª±c tuy·∫øn
        </div>
    </div>
</footer>

</body>
</html>
