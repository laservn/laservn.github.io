<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√ÅO C√ÅO K·ª∏ THU·∫¨T</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ†Ô∏è</text></svg>">
    <style>
        :root { 
            --primary: #00d2ff; 
            --secondary: #3a7bd5; 
            --dark: #0f172a; 
            --card: #1e293b; 
            --border: rgba(255,255,255,0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--dark); 
            color: var(--text-main); 
            margin: 0; 
            padding: 12px; 
            line-height: 1.5;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Tab Navigation */
        .tab-navigation { display: flex; gap: 10px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 12px; border: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: var(--text-muted); font-weight: 600; cursor: pointer; border-radius: 8px; transition: 0.3s; font-size: 12px; text-transform: uppercase; }
        .tab-btn.active { background: var(--primary); color: var(--dark); box-shadow: 0 0 15px rgba(0, 210, 255, 0.4); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Login Screen */
        #lock-screen { position: fixed; inset: 0; background: var(--dark); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .login-box { width: 320px; padding: 30px; background: var(--card); border-radius: 20px; border: 1px solid var(--border); text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        /* Container & Header */
        .container { max-width: 1000px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 20px; }
        
        /* Inputs */
        input, select, textarea { 
            background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; 
            border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 12px; outline: none; transition: 0.3s; font-size: 14px;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0, 210, 255, 0.2); }
        
        .btn-save { 
            background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border: none; 
            padding: 14px; border-radius: 10px; cursor: pointer; font-weight: 600; width: 100%; transition: transform 0.1s;
        }
        .btn-save:active { transform: scale(0.98); }
        .btn-save:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* Professional Table */
        .table-container { margin-top: 15px; border: 1px solid var(--border); border-radius: 12px; overflow-x: auto; background: var(--card); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 850px; }
        th { background: #111827; color: var(--text-muted); font-size: 11px; font-weight: 600; text-transform: uppercase; padding: 14px 12px; border-bottom: 2px solid var(--border); text-align: left; }
        td { padding: 14px 12px; border-bottom: 1px solid var(--border); font-size: 13px; cursor: pointer; transition: 0.2s; }
        tbody tr:hover td { background: rgba(0, 210, 255, 0.08); }

        .badge-tech, .badge-mec { background: rgba(58, 123, 213, 0.2); color: #93c5fd; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }

        /* Metadata Block Tab Style */
        .meta-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .meta-col { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; }
        .meta-col h4 { margin: 0 0 15px 0; color: var(--primary); font-size: 13px; text-align: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .meta-list { flex-grow: 1; min-height: 200px; max-height: 400px; overflow-y: auto; }
        .meta-item { background: rgba(0,0,0,0.2); margin-bottom: 5px; padding: 8px; border-radius: 6px; display: flex; gap: 5px; align-items: center; border: 1px solid transparent; }
        .meta-item input { margin-bottom: 0; padding: 6px; font-size: 12px; background: transparent; border: none; }
        .meta-item.editing { background: #0f172a; border-color: var(--primary); }
        .meta-item.editing input { background: #1e293b; border: 1px solid #334155; }
        .meta-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 15px; }
        .btn-meta { padding: 8px; border-radius: 6px; border: none; font-size: 11px; font-weight: 600; cursor: pointer; }
        .btn-edit-mode { background: rgba(0, 210, 255, 0.1); color: var(--primary); border: 1px solid var(--primary); }
        .btn-save-mode { background: var(--primary); color: var(--dark); }

        @media (max-width: 768px) { .meta-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 480px) { .meta-grid { grid-template-columns: 1fr; } }

        /* Modals & Loading */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); padding: 20px; }
        .modal-content { background: var(--card); width: 95%; max-width: 600px; border-radius: 20px; border: 1px solid var(--primary); padding: 25px; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); z-index: 4000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; pointer-events: none; }
        .toast { background: rgba(30, 41, 59, 0.95); color: white; padding: 16px 28px; border-radius: 12px; margin-bottom: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.1); animation: toastPop 0.3s forwards; }
        @keyframes toastPop { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .header-logo { height: 55px; filter: drop-shadow(0 0 15px var(--primary)) brightness(1.2); }
    </style>
</head>
<body>
    
<div id="toast-container"></div>
<div id="loading-overlay"><div class="spinner"></div><div id="loading-text" style="color:var(--primary); margin-top:10px;">ƒêANG X·ª¨ L√ù...</div></div>
    
<div id="lock-screen">
    <div class="login-box">
        <img src="https://lh3.googleusercontent.com/pw/AP1GczNyKJCNBen1I6WeBIOFBHnduEAc-raKjpQsiE-xMOPlkgBLUxSUPtPfnGUO-h_gVE4xbhoZyycDSfpCjJD_uk7EkCLQJEXeuBytxHxBTDS0NEIMKC7RqBA-GIxKhZed7ddwzYsTmKsh5fKxggPZvFM=w483-h154" alt="Logo" style="width: 250px; margin-bottom: 20px;">
        <h2 style="color:var(--primary); margin:0 0 20px 0;">B√ÅO C√ÅO K·ª∏ THU·∫¨T</h2>
        <input type="text" id="userInput" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="passInput" placeholder="M·∫≠t kh·∫©u">
        <button class="btn-save" onclick="unlock()">ƒêƒÇNG NH·∫¨P</button>
    </div>
</div>

<div class="container" id="main-content" style="display:none;">
    <div class="header">
        <img src="https://lh3.googleusercontent.com/pw/AP1GczNyKJCNBen1I6WeBIOFBHnduEAc-raKjpQsiE-xMOPlkgBLUxSUPtPfnGUO-h_gVE4xbhoZyycDSfpCjJD_uk7EkCLQJEXeuBytxHxBTDS0NEIMKC7RqBA-GIxKhZed7ddwzYsTmKsh5fKxggPZvFM=w483-h154" class="header-logo" alt="Logo">
        <div style="text-align: right">
            <span id="helloUser" style="color:var(--primary); font-size:13px; font-weight:600">---</span>
            <button onclick="logout()" style="color:#ef4444; background:none; border:none; cursor:pointer; margin-left:12px; font-size:12px; font-weight:bold">THO√ÅT</button>
            <small id="syncStatus" style="font-size:10px; color:var(--text-muted); display:block; margin-top:4px">ƒêang ƒë·ªìng b·ªô...</small>
        </div>
    </div>

    <div class="tab-navigation" id="tabBar" style="display:none;">
        <button class="tab-btn active" onclick="switchTab('data-tab', this)">üìä D·ªØ li·ªáu</button>
        <button class="tab-btn" onclick="switchTab('form-tab', this)">üìë B√°o c√°o m·ªõi</button>
        <button class="tab-btn" id="btnTabMeta" onclick="switchTab('meta-tab', this)">üß± Th√¥ng tin kh·ªëi</button>
    </div>

    <div id="data-tab" class="tab-content active">
        <input type="text" id="searchBox" onkeyup="filterTable()" placeholder="üîç T√¨m ki·∫øm nhanh...">
        <div class="table-container">
            <table>
                <thead><tr><th>Ng√†y l√†m</th><th>Kh√°ch h√†ng</th><th>Lo·∫°i m√°y</th><th>H·ªó tr·ª£</th><th>N·ªôi dung</th><th>K·ªπ thu·∫≠t</th><th>Ghi ch√∫</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="form-tab" class="tab-content">
        <div id="formContainer" style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary);">
            <input type="text" id="workDateDisplay" readonly onclick="document.getElementById('dateModal').style.display='flex'">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="customer"><option value="">T·∫£i kh√°ch h√†ng...</option></select>
                <select id="techName"><option value="">T·∫£i k·ªπ thu·∫≠t...</option></select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="machineType"><option value="">-- Lo·∫°i m√°y --</option></select>
                <select id="supportType"><option value="">-- H·ªó tr·ª£ --</option></select>
            </div>
            <textarea id="content" placeholder="M√¥ t·∫£ c√¥ng vi·ªác th·ª±c hi·ªán (B·∫Øt bu·ªôc)..." style="height:100px"></textarea>
            <input type="text" id="note" placeholder="Ghi ch√∫ th√™m...">
            <button class="btn-save" id="btnSave" onclick="saveData()">L∆ØU B√ÅO C√ÅO</button>
        </div>
    </div>

    <div id="meta-tab" class="tab-content">
        <div class="meta-grid">
            <div class="meta-col">
                <h4>KH√ÅCH H√ÄNG</h4>
                <div class="meta-list" id="list-customers"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('customers')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('customers')">L∆ØU</button>
                </div>
            </div>
            <div class="meta-col">
                <h4>LO·∫†I M√ÅY</h4>
                <div class="meta-list" id="list-machineTypes"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('machineTypes')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('machineTypes')">L∆ØU</button>
                </div>
            </div>
            <div class="meta-col">
                <h4>K·ª∏ THU·∫¨T</h4>
                <div class="meta-list" id="list-techs"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('techs')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('techs')">L∆ØU</button>
                </div>
            </div>
            <div class="meta-col">
                <h4>H·ªñ TR·ª¢</h4>
                <div class="meta-list" id="list-supports"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('supports')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('supports')">L∆ØU</button>
                </div>
            </div>
        </div>
        <p style="font-size: 11px; color: var(--text-muted); margin-top: 15px; text-align: center;">* ƒê·ªÉ x√≥a: X√≥a tr·∫Øng n·ªôi dung √¥ ƒë√≥ r·ªìi nh·∫•n L∆∞u. ƒê·ªÉ th√™m: Nh·∫•n S·ª≠a r·ªìi ƒëi·ªÅn v√†o c√°c √¥ tr·ªëng cu·ªëi danh s√°ch.</p>
    </div>
</div>

<div id="infoModal" class="modal" onclick="if(event.target==this) this.style.display='none'"><div class="modal-content"><h3 style="color:var(--primary); text-align:center;">CHI TI·∫æT üîé</h3><div id="modalBody"></div><button class="btn-save" style="margin-top:20px" onclick="document.getElementById('infoModal').style.display='none'">ƒê√ìNG</button></div></div>
<div id="dateModal" class="modal" onclick="if(event.target==this) this.style.display='none'"><div class="modal-content" style="text-align:center"><h4>CH·ªåN NG√ÄY L√ÄM VI·ªÜC</h4><input type="date" id="hiddenDate" onchange="confirmDate(this.value)"><button class="btn-save" onclick="document.getElementById('dateModal').style.display='none'">X√ÅC NH·∫¨N</button></div></div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC-WW6N3ZzmZ8gk_XypHWa3oW6VJMMGloM",
        authDomain: "data-260206.firebaseapp.com",
        projectId: "data-260206",
        storageBucket: "data-260206.firebasestorage.app",
        messagingSenderId: "992766098254",
        appId: "1:992766098254:web:8e9f5d3216541023d03c1f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let AUTH = JSON.parse(localStorage.getItem('tech_auth_v4')) || null;
    let RAW_METADATA = {}; // L∆∞u tr·ªØ d·ªØ li·ªáu g·ªëc t·ª´ Firestore

    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    document.addEventListener("DOMContentLoaded", () => {
        setInitialDate();
        checkSession();
    });

    function checkSession() {
        if (AUTH && AUTH.expire && new Date().getTime() < AUTH.expire) {
            showApp(); fetchData();
        } else {
            document.getElementById('lock-screen').style.display = 'flex';
        }
    }

    async function unlock() {
        const u = document.getElementById('userInput').value.trim();
        const p = document.getElementById('passInput').value.trim();
        showLoading(true, "X√ÅC TH·ª∞C...");
        try {
            const doc = await db.collection("users").doc(u).get();
            if (doc.exists && doc.data().pass === p) {
                AUTH = { user: u, role: doc.data().role, expire: new Date().getTime() + (24*60*60*1000) };
                localStorage.setItem('tech_auth_v4', JSON.stringify(AUTH));
                showApp(); fetchData();
            } else { showToast("Sai t√†i kho·∫£n!", "error"); }
        } catch (e) { showToast("L·ªói k·∫øt n·ªëi!", "error"); }
        showLoading(false);
    }

    function fetchData() {
        // L·∫•y Logs Real-time
        db.collection("logs").orderBy("createdAt", "desc").limit(100).onSnapshot(snap => {
            const logs = snap.docs.map(d => [d.id, d.data().workDate, d.data().customer, d.data().machineType, d.data().support, d.data().content, d.data().tech, d.data().createdBy, d.data().note]);
            renderTable(logs);
        });

        // L·∫•y Metadata (Dropdowns)
        db.collection("metadata").doc("dropdowns").onSnapshot(doc => {
            if (doc.exists) {
                RAW_METADATA = doc.data();
                updateDropdowns(RAW_METADATA);
                renderMetaBlock(RAW_METADATA);
            }
        });
        applyPermissions();
    }

    function renderTable(logs) {
        window.currentLogs = logs;
        document.getElementById('tableBody').innerHTML = logs.map((row, i) => `
            <tr onclick="openInfoModal(${i})">
                <td>${formatVN(row[1])}</td>
                <td><b>${row[2]}</b></td>
                <td><span class="badge-mec">${row[3]}</span></td>
                <td><small>${row[4]}</small></td>
                <td>${row[5].substring(0,25)}...</td>
                <td><span class="badge-tech">${row[6]}</span></td>
                <td><small>${row[8] || ''}</small></td>
            </tr>
        `).join('');
        document.getElementById('syncStatus').innerText = "C·∫≠p nh·∫≠t: " + new Date().toLocaleTimeString();
    }

    function updateDropdowns(d) {
        const setMap = (id, list, txt) => {
            const el = document.getElementById(id);
            el.innerHTML = `<option value="">-- ${txt} --</option>` + list.map(v => `<option value="${v}">${v}</option>`).join('');
        };
        setMap('customer', d.customers, 'Kh√°ch h√†ng');
        setMap('techName', d.techs, 'K·ªπ thu·∫≠t');
        setMap('machineType', d.machineTypes, 'Lo·∫°i m√°y');
        setMap('supportType', d.supports, 'H·ªó tr·ª£');
    }

    // --- TAB 3 LOGIC ---
    function renderMetaBlock(data) {
        const renderCol = (id, list) => {
            const container = document.getElementById('list-' + id);
            // Th√™m 3 √¥ tr·ªëng ·ªü cu·ªëi ƒë·ªÉ ng∆∞·ªùi d√πng th√™m m·ªõi d·ªÖ d√†ng
            const fullList = [...list, "", "", ""]; 
            container.innerHTML = fullList.map(v => `
                <div class="meta-item">
                    <input type="text" value="${v}" readonly>
                </div>
            `).join('');
        };
        renderCol('customers', data.customers || []);
        renderCol('machineTypes', data.machineTypes || []);
        renderCol('techs', data.techs || []);
        renderCol('supports', data.supports || []);
    }

    function enableMetaEdit(id) {
        const items = document.querySelectorAll(`#list-${id} .meta-item`);
        items.forEach(item => {
            item.classList.add('editing');
            item.querySelector('input').readOnly = false;
        });
        showToast("ƒê√£ m·ªü ch·∫ø ƒë·ªô s·ª≠a c·ªôt " + id, "info");
    }

    async function saveMetaData(id) {
        const inputs = document.querySelectorAll(`#list-${id} input`);
        // L·ªçc l·∫•y gi√° tr·ªã kh√¥ng r·ªóng v√† kh√¥ng tr√πng
        const newList = [...new Set(Array.from(inputs).map(i => i.value.trim()).filter(v => v !== ""))];
        
        showLoading(true, "ƒêANG C·∫¨P NH·∫¨T...");
        try {
            const updateObj = {};
            updateObj[id] = newList;
            await db.collection("metadata").doc("dropdowns").update(updateObj);
            showToast("ƒê√£ c·∫≠p nh·∫≠t Firestore!", "success");
        } catch (e) { showToast("L·ªói khi l∆∞u!", "error"); }
        showLoading(false);
    }

    // --- UTILS ---
    async function saveData() {
        const payload = {
            workDate: document.getElementById('hiddenDate').value,
            customer: document.getElementById('customer').value,
            tech: document.getElementById('techName').value,
            machineType: document.getElementById('machineType').value,
            support: document.getElementById('supportType').value,
            content: document.getElementById('content').value.trim(),
            note: document.getElementById('note').value.trim(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: AUTH.user
        };
        if(!payload.customer || !payload.content) return showToast("Thi·∫øu th√¥ng tin!", "error");
        showLoading(true);
        await db.collection("logs").add(payload);
        showLoading(false);
        showToast("ƒê√£ l∆∞u!", "success");
        document.getElementById('content').value = '';
        switchTab('data-tab', document.querySelector('.tab-btn'));
    }

    function applyPermissions() {
        if(AUTH.role !== "ADMIN") {
            document.getElementById('btnTabMeta').style.display = 'none';
        } else {
            document.getElementById('tabBar').style.display = 'flex';
        }
    }

    function showApp() { document.getElementById('lock-screen').style.display = 'none'; document.getElementById('main-content').style.display = 'block'; document.getElementById('helloUser').innerText = "Ch√†o, " + AUTH.user; }
    function logout() { localStorage.removeItem('tech_auth_v4'); location.reload(); }
    function setInitialDate() { const iso = new Date().toISOString().split('T')[0]; document.getElementById('hiddenDate').value = iso; document.getElementById('workDateDisplay').value = formatVN(iso); }
    function confirmDate(v) { document.getElementById('workDateDisplay').value = formatVN(v); document.getElementById('dateModal').style.display = 'none'; }
    function formatVN(s) { if(!s) return ''; const d = new Date(s); return d.getDate().toString().padStart(2,'0')+'/'+(d.getMonth()+1).toString().padStart(2,'0')+'/'+d.getFullYear(); }
    function filterTable() { const v = document.getElementById('searchBox').value.toUpperCase(); const rows = document.getElementById('tableBody').getElementsByTagName('tr'); for (let r of rows) r.style.display = r.innerText.toUpperCase().includes(v) ? "" : "none"; }
    function showLoading(s, t) { document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none'; if(t) document.getElementById('loading-text').innerText = t; }
    function showToast(m, type) { 
        const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = 'toast'; t.innerText = m; c.appendChild(t);
        setTimeout(() => t.remove(), 2500);
    }
    
    function openInfoModal(i) {
        const row = window.currentLogs[i];
        document.getElementById('modalBody').innerHTML = `<div style="font-size:14px; line-height:1.8">
            <b>Ng√†y:</b> ${formatVN(row[1])}<br><b>Kh√°ch:</b> ${row[2]}<br><b>M√°y:</b> ${row[3]}<br><b>H·ªó tr·ª£:</b> ${row[4]}<br><b>K·ªπ thu·∫≠t:</b> ${row[6]}<br>
            <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; margin-top:10px">${row[5]}</div>
            <div style="color:var(--primary); font-style:italic; margin-top:5px">Ghi ch√∫: ${row[8] || 'Kh√¥ng'}</div>
        </div>`;
        document.getElementById('infoModal').style.display = 'flex';
    }
</script>
</body>
</html>
