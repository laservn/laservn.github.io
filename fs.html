<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªÜ TH·ªêNG K·ª∏ THU·∫¨T V5</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #00d2ff; --secondary: #3a7bd5; --dark: #0f172a; 
            --card: #1e293b; --border: rgba(255,255,255,0.1);
            --text-main: #f8fafc; --text-muted: #94a3b8;
        }
        body { font-family: 'Inter', sans-serif; background: var(--dark); color: var(--text-main); margin: 0; padding: 12px; }
        .tab-navigation { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .tab-btn { background: #1e293b; color: var(--text-muted); border: 1px solid var(--border); padding: 10px 15px; border-radius: 8px; cursor: pointer; white-space: nowrap; font-size: 13px; }
        .tab-btn.active { background: var(--primary); color: var(--dark); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        input, select, textarea { background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 10px; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        .btn-save { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 600; width: 100%; }
        .table-container { overflow-x: auto; background: var(--card); border-radius: 12px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: rgba(0,0,0,0.3); color: var(--text-muted); font-size: 11px; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; }
        .cust-row { display: grid; grid-template-columns: 1fr 80px; align-items: center; padding: 8px 15px; border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer; }
        #lock-screen { position: fixed; inset: 0; background: var(--dark); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); z-index: 4000; display: none; justify-content: center; align-items: center; }
        .toast { position: fixed; top: 20px; right: 20px; background: var(--card); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary); z-index: 5000; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div id="loading-overlay"><div style="color:var(--primary)">ƒêANG X·ª¨ L√ù...</div></div>
<div id="toast-container"></div>

<div id="lock-screen">
    <div style="width: 300px; background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid var(--border);">
        <h2 style="color:var(--primary); text-align:center;">H·ªÜ TH·ªêNG V5</h2>
        <input type="text" id="userInput" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="passInput" placeholder="M·∫≠t kh·∫©u">
        <button class="btn-save" onclick="unlock()">ƒêƒÇNG NH·∫¨P</button>
    </div>
</div>

<div id="main-content" style="display:none;">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h4 id="helloUser" style="color:var(--primary); margin:0;"></h4>
        <button onclick="logout()" style="color:#ff4d4d; background:none; border:none; cursor:pointer; font-weight:bold;">THO√ÅT</button>
    </div>

    <div class="tab-navigation">
        <button class="tab-btn active" onclick="switchTab('data-tab', this)">üìä D·ªØ li·ªáu</button>
        <button class="tab-btn" id="btnTabForm" onclick="switchTab('form-tab', this)">üìë B√°o c√°o</button>
        <button class="tab-btn" id="btnTabMeta" onclick="switchTab('meta-tab', this)">üß± Kh·ªëi</button>
        <button class="tab-btn" id="btnTabUser" onclick="switchTab('user-tab', this)">üë• User</button>
        <button class="tab-btn" id="btnTabDoc" onclick="switchTab('doc-tab', this)">üìÇ T√†i li·ªáu</button>
    </div>

    <div id="data-tab" class="tab-content active">
        <input type="text" onkeyup="filterTable(this)" placeholder="üîç T√¨m ki·∫øm nhanh...">
        <div class="table-container">
            <table>
                <thead><tr><th>Ng√†y</th><th>Kh√°ch</th><th>M√°y</th><th>K·ªπ thu·∫≠t</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="form-tab" class="tab-content">
        <div style="background: var(--card); padding: 20px; border-radius: 15px;">
            <input type="date" id="workDate">
            <select id="customer"></select>
            <select id="techName"></select>
            <select id="machineType"></select>
            <textarea id="content" placeholder="N·ªôi dung c√¥ng vi·ªác..."></textarea>
            <button class="btn-save" onclick="saveData()">L∆ØU B√ÅO C√ÅO</button>
        </div>
    </div>

    <div id="user-tab" class="tab-content">
        <div style="background: var(--card); padding: 15px; border-radius: 10px;">
            <input type="text" id="u_id" placeholder="User ID">
            <input type="text" id="u_pass" placeholder="M·∫≠t kh·∫©u">
            <select id="u_role"><option value="VIEWER">VIEWER</option><option value="EDIT">EDIT</option><option value="ADMIN">ADMIN</option></select>
            <div style="border:1px solid var(--border); border-radius:8px; margin-top:10px;">
                <div style="display:grid; grid-template-columns: 1fr 80px; padding:8px; background:rgba(255,255,255,0.05); font-size:11px;"><div>KH√ÅCH H√ÄNG</div><div>CH·ªåN</div></div>
                <div id="user_cust_list" style="max-height:150px; overflow-y:auto;"></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <button class="btn-save" onclick="saveUser()">TH√äM/C·∫¨P NH·∫¨T</button>
                <button class="btn-save" onclick="deleteUser()" style="background:#7f1d1d">X√ìA</button>
            </div>
        </div>
        <div class="table-container" style="margin-top:15px;">
            <table><thead><tr><th>ID</th><th>Quy·ªÅn</th><th>Truy c·∫≠p</th></tr></thead><tbody id="userTableBody"></tbody></table>
        </div>
    </div>
    
    </div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC-WW6N3ZzmZ8gk_XypHWa3oW6VJMMGloM",
        authDomain: "data-260206.firebaseapp.com",
        projectId: "data-260206",
        storageBucket: "data-260206.firebasestorage.app",
        messagingSenderId: "992766098254",
        appId: "1:992766098254:web:8e9f5d3216541023d03c1f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    try { db.settings({ experimentalForceLongPolling: true }); } catch(e){}

    let AUTH = JSON.parse(localStorage.getItem('tech_auth_v5'));

    window.onload = () => {
        if (AUTH && new Date().getTime() < AUTH.expire) showApp();
        else logout(false); // logout kh√¥ng reload trang
    };

    async function unlock() {
        const u = document.getElementById('userInput').value.trim();
        const p = document.getElementById('passInput').value.trim();
        if(!u || !p) return;
        
        showLoading(true);
        try {
            const doc = await db.collection("users").doc(u).get();
            if (doc.exists && doc.data().pass === p) {
                const d = doc.data();
                AUTH = { user: u, role: d.role, access: d.access || "", expire: new Date().getTime() + 86400000 };
                localStorage.setItem('tech_auth_v5', JSON.stringify(AUTH));
                showApp();
            } else { alert("Sai t√†i kho·∫£n!"); }
        } catch(e) { alert("L·ªói k·∫øt n·ªëi!"); }
        showLoading(false);
    }

    function showApp() {
        document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('helloUser').innerText = `Xin ch√†o, ${AUTH.user}`;
        
        // Ph√¢n quy·ªÅn Tab
        const r = AUTH.role;
        document.getElementById('btnTabForm').style.display = (r !== 'VIEWER') ? 'block' : 'none';
        document.getElementById('btnTabMeta').style.display = (r === 'ADMIN') ? 'block' : 'none';
        document.getElementById('btnTabUser').style.display = (r === 'ADMIN') ? 'block' : 'none';

        fetchData();
        fetchMetadata();
        if(r === 'ADMIN') fetchUsers();
    }

    function logout(reload = true) {
        localStorage.removeItem('tech_auth_v5');
        document.getElementById('lock-screen').style.display = 'flex';
        document.getElementById('main-content').style.display = 'none';
        if(reload) location.reload();
    }

    function fetchData() {
        let query = db.collection("logs").orderBy("createdAt", "desc").limit(100);
        if (AUTH.role === "VIEWER" && AUTH.access) {
            const list = AUTH.access.split(",").map(s => s.trim());
            query = query.where("customer", "in", list);
        }
        query.onSnapshot(snap => {
            document.getElementById('tableBody').innerHTML = snap.docs.map(d => {
                const x = d.data();
                return `<tr><td>${x.workDate}</td><td><b>${x.customer}</b></td><td>${x.machineType}</td><td>${x.tech}</td></tr>`;
            }).join('');
        });
    }

    function fetchMetadata() {
        db.collection("metadata").doc("dropdowns").onSnapshot(doc => {
            if(!doc.exists) return;
            const d = doc.data();
            // Load dropdowns
            document.getElementById('customer').innerHTML = d.customers.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('techName').innerHTML = d.techs.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('machineType').innerHTML = d.machineTypes.map(c => `<option value="${c}">${c}</option>`).join('');
            
            // Load checkbox User (Tab 4)
            document.getElementById('user_cust_list').innerHTML = d.customers.map(c => `
                <label class="cust-row"><span>${c}</span><input type="checkbox" name="u_acc" value="${c}"></label>
            `).join('');
        });
    }

    // --- Qu·∫£n l√Ω User (ADMIN) ---
    function fetchUsers() {
        db.collection("users").onSnapshot(snap => {
            document.getElementById('userTableBody').innerHTML = snap.docs.map(d => {
                const u = d.data();
                return `<tr onclick="loadUser('${d.id}', '${u.pass}', '${u.role}', '${u.access||''}')"><td>${d.id}</td><td>${u.role}</td><td>${u.access||'ALL'}</td></tr>`;
            }).join('');
        });
    }

    async function saveUser() {
        const id = document.getElementById('u_id').value;
        const acc = Array.from(document.querySelectorAll('input[name="u_acc"]:checked')).map(c => c.value).join(",");
        await db.collection("users").doc(id).set({
            pass: document.getElementById('u_pass').value,
            role: document.getElementById('u_role').value,
            access: acc
        }, {merge: true});
        alert("Th√†nh c√¥ng!");
    }

    function loadUser(id, pass, role, access) {
        document.getElementById('u_id').value = id;
        document.getElementById('u_pass').value = pass;
        document.getElementById('u_role').value = role;
        const accs = access.split(",");
        document.querySelectorAll('input[name="u_acc"]').forEach(cb => cb.checked = accs.includes(cb.value));
    }

    function switchTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function showLoading(s) { document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none'; }
    function filterTable(input) {
        const v = input.value.toUpperCase();
        document.querySelectorAll('#tableBody tr').forEach(r => r.style.display = r.innerText.toUpperCase().includes(v) ? "" : "none");
    }
</script>
</body>
</html>
