<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªÜ TH·ªêNG K·ª∏ THU·∫¨T V5</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #00d2ff; --secondary: #3a7bd5; --dark: #0f172a; 
            --card: #1e293b; --border: rgba(255,255,255,0.1);
            --text-main: #f8fafc; --text-muted: #94a3b8;
        }

        body { font-family: 'Inter', sans-serif; background: var(--dark); color: var(--text-main); margin: 0; padding: 12px; }
        
        /* Navigation Tabs */
        .tab-navigation { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid var(--border); }
        .tab-btn { 
            background: #1e293b; color: var(--text-muted); border: 1px solid var(--border); 
            padding: 10px 15px; border-radius: 8px; cursor: pointer; white-space: nowrap; font-size: 13px;
        }
        .tab-btn.active { background: var(--primary); color: var(--dark); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Tables & UI Elements */
        .table-container { overflow-x: auto; background: var(--card); border-radius: 12px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #111827; color: var(--text-muted); font-size: 11px; padding: 12px; text-align: left; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; cursor: pointer; }
        tr:hover { background: rgba(0, 210, 255, 0.05); }

        input, select, textarea { background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 10px; width: 100%; margin-bottom: 10px; }
        .btn-save { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 600; width: 100%; }
        
        /* Grid cho b·∫£ng ch·ªçn kh√°ch h√†ng */
        .cust-grid-header { display: grid; grid-template-columns: 1fr 80px; background: rgba(255,255,255,0.05); padding: 8px 15px; font-size: 11px; font-weight: bold; }
        .cust-row { display: grid; grid-template-columns: 1fr 80px; align-items: center; padding: 8px 15px; border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer; }
        .cust-row:hover { background: rgba(0, 210, 255, 0.1); }

        /* Login & Overlays */
        #lock-screen { position: fixed; inset: 0; background: var(--dark); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); z-index: 4000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 5000; }
        .toast { background: var(--card); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

<div id="loading-overlay"><div class="spinner"></div><div id="loading-text" style="color:var(--primary)">ƒêANG X·ª¨ L√ù...</div></div>
<div id="toast-container"></div>

<div id="lock-screen">
    <div style="width: 300px; text-align: center; background: var(--card); padding: 30px; border-radius: 20px; border:1px solid var(--border);">
        <h2 style="color:var(--primary)">ƒêƒÇNG NH·∫¨P</h2>
        <input type="text" id="userInput" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="passInput" placeholder="M·∫≠t kh·∫©u">
        <button class="btn-save" onclick="unlock()">X√ÅC NH·∫¨N</button>
    </div>
</div>

<div class="container" id="main-content" style="display:none;">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="color:var(--primary); margin:0;">TECH SYSTEM V5</h3>
        <div style="text-align:right">
            <span id="helloUser" style="font-size:12px; font-weight:bold"></span>
            <button onclick="logout()" style="color:#ef4444; border:none; background:none; cursor:pointer; font-weight:bold">THO√ÅT</button>
        </div>
    </div>

    <div class="tab-navigation" id="tabBar">
        <button class="tab-btn active" onclick="switchTab('data-tab', this)">üìä D·ªØ li·ªáu</button>
        <button class="tab-btn" id="btnTabForm" onclick="switchTab('form-tab', this)">üìë B√°o c√°o</button>
        <button class="tab-btn" id="btnTabMeta" onclick="switchTab('meta-tab', this)">üß± Kh·ªëi</button>
        <button class="tab-btn" id="btnTabUser" onclick="switchTab('user-tab', this)">üë• User</button>
        <button class="tab-btn" id="btnTabDoc" onclick="switchTab('doc-tab', this)">üìÇ T√†i li·ªáu</button>
    </div>

    <div id="data-tab" class="tab-content active">
        <input type="text" id="searchBox" onkeyup="filterTable()" placeholder="üîç T√¨m ki·∫øm nhanh...">
        <div class="table-container">
            <table>
                <thead><tr><th>Ng√†y</th><th>Kh√°ch</th><th>M√°y</th><th>K·ªπ thu·∫≠t</th><th>N·ªôi dung</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="form-tab" class="tab-content">
        <div style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary);">
            <input type="date" id="workDate">
            <select id="customer"></select>
            <select id="techName"></select>
            <select id="machineType"></select>
            <select id="supportType"></select>
            <textarea id="content" placeholder="N·ªôi dung c√¥ng vi·ªác..."></textarea>
            <input type="text" id="note" placeholder="Ghi ch√∫...">
            <button class="btn-save" id="btnSaveReport" onclick="saveData()">L∆ØU B√ÅO C√ÅO</button>
        </div>
    </div>

    <div id="meta-tab" class="tab-content">
        <div id="meta-admin-zone"></div>
    </div>

    <div id="user-tab" class="tab-content">
        <div style="background: var(--card); padding: 15px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 15px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="text" id="u_id" placeholder="T√™n ƒëƒÉng nh·∫≠p">
                <input type="text" id="u_name" placeholder="T√™n hi·ªÉn th·ªã">
                <input type="text" id="u_pass" placeholder="M·∫≠t kh·∫©u">
                <select id="u_role"><option value="VIEWER">VIEWER</option><option value="EDIT">EDIT</option><option value="ADMIN">ADMIN</option></select>
            </div>
            <div style="margin-top:10px; border:1px solid var(--border); border-radius:8px; overflow:hidden;">
                <div class="cust-grid-header"><div>T√äN KH√ÅCH H√ÄNG</div><div style="text-align:center">CHO PH√âP</div></div>
                <div id="user_customer_checks" style="max-height:150px; overflow-y:auto;"></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px; margin-top:10px;">
                <button class="btn-save" onclick="addUser()" style="background:#065f46">TH√äM</button>
                <button class="btn-save" id="btnUpdateUser" onclick="updateUser()" style="background:#1e3a8a">L∆ØU</button>
                <button class="btn-save" onclick="deleteUser()" style="background:#7f1d1d">X√ìA</button>
                <button class="btn-save" onclick="resetUserForm()" style="background:#475569">M·ªöI</button>
            </div>
        </div>
        <div class="table-container">
            <table><thead><tr><th>User ID</th><th>T√™n</th><th>Quy·ªÅn</th><th>Truy c·∫≠p</th></tr></thead>
            <tbody id="userTableBody"></tbody></table>
        </div>
    </div>

    <div id="doc-tab" class="tab-content">
        <div id="doc-admin-form" style="background: var(--card); padding: 15px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 15px;">
            <input type="text" id="doc_name" placeholder="T√™n t√†i li·ªáu">
            <input type="text" id="doc_link" placeholder="Link t·∫£i (Drive/Web)">
            <div style="margin-top:10px; border:1px solid var(--border); border-radius:8px; overflow:hidden;">
                <div class="cust-grid-header"><div>D√ÄNH CHO KH√ÅCH H√ÄNG</div><div style="text-align:center">CH·ªåN</div></div>
                <div id="doc_customer_checks" style="max-height:150px; overflow-y:auto;"></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px; margin-top:10px;">
                <button class="btn-save" onclick="addDoc()" style="background:#065f46">TH√äM</button>
                <button class="btn-save" id="btnUpdateDoc" onclick="updateDoc()" style="background:#1e3a8a">L∆ØU</button>
                <button class="btn-save" onclick="deleteDoc()" style="background:#7f1d1d">X√ìA</button>
                <button class="btn-save" onclick="resetDocForm()" style="background:#475569">M·ªöI</button>
            </div>
        </div>
        <input type="text" id="docSearch" onkeyup="filterDocs()" placeholder="üîç T√¨m t√†i li·ªáu...">
        <div id="docList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:10px; margin-top:10px;"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
    // 1. FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyC-WW6N3ZzmZ8gk_XypHWa3oW6VJMMGloM",
        authDomain: "data-260206.firebaseapp.com",
        projectId: "data-260206",
        storageBucket: "data-260206.firebasestorage.app",
        messagingSenderId: "992766098254",
        appId: "1:992766098254:web:8e9f5d3216541023d03c1f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // FIX ERR_BLOCKED_BY_CLIENT & SETTINGS OVERRIDE
    try {
        db.settings({ experimentalForceLongPolling: true });
    } catch(e) { console.log("Settings already set"); }

    // 2. BI·∫æN TO√ÄN C·ª§C
    let AUTH = JSON.parse(localStorage.getItem('tech_auth_v5')) || null;
    let ALL_CUSTOMERS = [];
    let selectedUserId = null;
    let selectedDocId = null;

    // 3. KH·ªûI T·∫†O
    document.addEventListener("DOMContentLoaded", () => {
        if (AUTH && new Date().getTime() < AUTH.expire) {
            showApp();
        } else {
            logout();
        }
    });

    async function unlock() {
        const u = document.getElementById('userInput').value.trim();
        const p = document.getElementById('passInput').value.trim();
        showLoading(true);
        try {
            const userDoc = await db.collection("users").doc(u).get();
            if (userDoc.exists && userDoc.data().pass === p) {
                const data = userDoc.data();
                AUTH = { 
                    user: u, role: data.role, 
                    access: data.access || "", 
                    expire: new Date().getTime() + (24 * 60 * 60 * 1000) 
                };
                localStorage.setItem('tech_auth_v5', JSON.stringify(AUTH));
                showApp();
            } else { showToast("Sai t√†i kho·∫£n/m·∫≠t kh·∫©u!", "error"); }
        } catch (e) { showToast("L·ªói k·∫øt n·ªëi!", "error"); }
        showLoading(false);
    }

    function showApp() {
        document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('helloUser').innerText = `Ch√†o, ${AUTH.user} (${AUTH.role})`;
        document.getElementById('workDate').value = new Date().toISOString().split('T')[0];
        
        applyPermissions();
        fetchData();
        fetchMetadata();
        if(AUTH.role === "ADMIN") fetchUsers();
        fetchDocs();
    }

    function applyPermissions() {
        const r = AUTH.role;
        document.getElementById('btnTabForm').style.display = (r === "ADMIN" || r === "EDIT") ? "block" : "none";
        document.getElementById('btnTabMeta').style.display = (r === "ADMIN") ? "block" : "none";
        document.getElementById('btnTabUser').style.display = (r === "ADMIN") ? "block" : "none";
        document.getElementById('doc-admin-form').style.display = (r === "ADMIN" || r === "EDIT") ? "block" : "none";
    }

    // 4. LOGIC D·ªÆ LI·ªÜU CH√çNH
    function fetchData() {
        let query = db.collection("logs").orderBy("createdAt", "desc").limit(300);
        if (AUTH.role === "VIEWER") {
            const allowed = AUTH.access.split(",").map(s => s.trim()).filter(s => s !== "");
            if (allowed.length > 0) query = query.where("customer", "in", allowed);
            else { document.getElementById('tableBody').innerHTML = ""; return; }
        }

        query.onSnapshot(snap => {
            document.getElementById('tableBody').innerHTML = snap.docs.map(doc => {
                const d = doc.data();
                return `<tr onclick="alert('${d.content}')">
                    <td>${d.workDate}</td>
                    <td><b>${d.customer}</b></td>
                    <td>${d.machineType}</td>
                    <td>${d.tech}</td>
                    <td>${d.content.substring(0,30)}...</td>
                </tr>`;
            }).join('');
        });
    }

    // 5. LOGIC METADATA
    function fetchMetadata() {
        db.collection("metadata").doc("dropdowns").onSnapshot(doc => {
            if (!doc.exists) return;
            const d = doc.data();
            ALL_CUSTOMERS = d.customers || [];
            
            // Load dropdowns
            const loadSelect = (id, arr) => {
                document.getElementById(id).innerHTML = arr.map(v => `<option value="${v}">${v}</option>`).join('');
            };
            loadSelect('customer', ALL_CUSTOMERS);
            loadSelect('techName', d.techs || []);
            loadSelect('machineType', d.machineTypes || []);
            loadSelect('supportType', d.supports || []);

            // Load Checkboxes cho Tab 4 v√† 5
            loadCheckboxes('user_customer_checks', 'u_access_cust', ALL_CUSTOMERS);
            loadCheckboxes('doc_customer_checks', 'doc_cust', ALL_CUSTOMERS);
            
            if(AUTH.role === "ADMIN") renderMetaEditor(d);
        });
    }

    function loadCheckboxes(containerId, name, list) {
        const container = document.getElementById(containerId);
        container.innerHTML = list.map(c => `
            <label class="cust-row">
                <span>${c}</span>
                <input type="checkbox" name="${name}" value="${c}">
            </label>
        `).join('');
    }

    // 6. QU·∫¢N L√ù USER (TAB 4)
    function fetchUsers() {
        db.collection("users").onSnapshot(snap => {
            document.getElementById('userTableBody').innerHTML = snap.docs.map(doc => {
                const u = doc.data();
                return `<tr onclick="loadUserToForm('${doc.id}', '${u.name}', '${u.role}', '${u.pass}', '${u.access || ""}')">
                    <td>${doc.id}</td><td>${u.name}</td><td>${u.role}</td><td>${u.access || "ALL"}</td>
                </tr>`;
            }).join('');
        });
    }

    function loadUserToForm(id, name, role, pass, access) {
        selectedUserId = id;
        document.getElementById('u_id').value = id;
        document.getElementById('u_name').value = name;
        document.getElementById('u_role').value = role;
        document.getElementById('u_pass').value = pass;
        
        const allowed = access.split(",").map(s => s.trim());
        document.querySelectorAll('input[name="u_access_cust"]').forEach(ch => ch.checked = allowed.includes(ch.value));
    }

    async function addUser() {
        const id = document.getElementById('u_id').value.trim();
        const access = Array.from(document.querySelectorAll('input[name="u_access_cust"]:checked')).map(c => c.value).join(", ");
        await db.collection("users").doc(id).set({
            name: document.getElementById('u_name').value,
            role: document.getElementById('u_role').value,
            pass: document.getElementById('u_pass').value,
            access: access
        });
        showToast("ƒê√£ th√™m user");
        resetUserForm();
    }

    async function updateUser() {
        const id = document.getElementById('u_id').value;
        const access = Array.from(document.querySelectorAll('input[name="u_access_cust"]:checked')).map(c => c.value).join(", ");
        await db.collection("users").doc(id).update({
            name: document.getElementById('u_name').value,
            role: document.getElementById('u_role').value,
            pass: document.getElementById('u_pass').value,
            access: access
        });
        showToast("ƒê√£ c·∫≠p nh·∫≠t");
    }

    // 7. QU·∫¢N L√ù T√ÄI LI·ªÜU (TAB 5)
    function fetchDocs() {
        db.collection("documents").onSnapshot(snap => {
            const allDocs = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            let filtered = allDocs;
            
            if (AUTH.role === "VIEWER") {
                const myAccess = AUTH.access.split(",").map(s => s.trim());
                filtered = allDocs.filter(d => !d.customers || d.customers.length === 0 || d.customers.some(c => myAccess.includes(c)));
            }
            
            document.getElementById('docList').innerHTML = filtered.map(d => `
                <div style="background:var(--card); padding:15px; border-radius:12px; border:1px solid var(--border); cursor:pointer;" onclick="loadDocToForm('${d.id}','${d.name}','${d.link}',${JSON.stringify(d.customers||[])})">
                    <h4 style="margin:0; color:var(--primary)">üìÑ ${d.name}</h4>
                    <p style="font-size:11px; color:var(--text-muted)">Quy·ªÅn: ${(!d.customers || d.customers.length===0) ? "C√¥ng khai" : d.customers.join(", ")}</p>
                    <a href="${d.link}" target="_blank" style="display:block; background:var(--secondary); color:white; text-align:center; padding:8px; border-radius:5px; text-decoration:none; font-size:12px; margin-top:10px;">T·∫¢I V·ªÄ</a>
                </div>
            `).join('');
        });
    }

    function loadDocToForm(id, name, link, custs) {
        if(AUTH.role === "VIEWER") return;
        selectedDocId = id;
        document.getElementById('doc_name').value = name;
        document.getElementById('doc_link').value = link;
        document.querySelectorAll('input[name="doc_cust"]').forEach(ch => ch.checked = custs.includes(ch.value));
    }

    async function addDoc() {
        const custs = Array.from(document.querySelectorAll('input[name="doc_cust"]:checked')).map(c => c.value);
        await db.collection("documents").add({
            name: document.getElementById('doc_name').value,
            link: document.getElementById('doc_link').value,
            customers: custs
        });
        showToast("ƒê√£ th√™m t√†i li·ªáu");
        resetDocForm();
    }

    // UTILS
    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    function showToast(msg, type="info") {
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerText = msg;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    function showLoading(s) { document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none'; }
    
    function logout() { localStorage.removeItem('tech_auth_v5'); location.reload(); }

    function resetUserForm() {
        document.getElementById('u_id').value = ""; document.getElementById('u_name').value = "";
        document.getElementById('u_pass').value = "";
        document.querySelectorAll('input[name="u_access_cust"]').forEach(ch => ch.checked = false);
    }
    function resetDocForm() {
        document.getElementById('doc_name').value = ""; document.getElementById('doc_link').value = "";
        document.querySelectorAll('input[name="doc_cust"]').forEach(ch => ch.checked = false);
    }
</script>
</body>
</html>
