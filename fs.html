<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√ÅO C√ÅO K·ª∏ THU·∫¨T</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ†Ô∏è</text></svg>">
    <style>
        :root { 
            --primary: #00d2ff; 
            --secondary: #3a7bd5; 
            --dark: #0f172a; 
            --card: #1e293b; 
            --border: rgba(255,255,255,0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--dark); 
            color: var(--text-main); 
            margin: 0; 
            padding: 12px; 
            line-height: 1.5;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Tab Navigation Style */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.2);
            padding: 5px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: 0.3s;
            font-size: 13px;
            text-transform: uppercase;
        }
        .tab-btn.active {
            background: var(--primary);
            color: var(--dark);
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.4);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Login Screen */
        #lock-screen { position: fixed; inset: 0; background: var(--dark); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .login-box { width: 320px; padding: 30px; background: var(--card); border-radius: 20px; border: 1px solid var(--border); text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        /* Container & Header */
        .container { max-width: 1000px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 20px; }
        
        /* Inputs */
        input, select, textarea { 
            background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; 
            border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 12px; outline: none; transition: 0.3s; font-size: 14px;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0, 210, 255, 0.2); }
        
        .btn-save { 
            background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border: none; 
            padding: 14px; border-radius: 10px; cursor: pointer; font-weight: 600; width: 100%; transition: transform 0.1s;
        }
        .btn-save:active { transform: scale(0.98); }
        .btn-save:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* Professional Table */
        .table-container { 
            margin-top: 15px; border: 1px solid var(--border); border-radius: 12px; 
            overflow-x: auto; background: var(--card); box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 850px; }
        th { 
            background: #111827; color: var(--text-muted); font-size: 11px; font-weight: 600; 
            text-transform: uppercase; letter-spacing: 0.05em; padding: 14px 12px; border-bottom: 2px solid var(--border); text-align: left;
        }
        td { padding: 14px 12px; border-bottom: 1px solid var(--border); font-size: 13px; cursor: pointer; transition: 0.2s; }
        tbody tr:nth-child(even) { background: rgba(255, 255, 255, 0.02); }
        tbody tr:hover td { background: rgba(0, 210, 255, 0.08); }

        .badge-tech { background: rgba(58, 123, 213, 0.2); color: #93c5fd; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; white-space: nowrap; }
        .badge-mec { background: rgba(58, 123, 213, 0.2); color: #93c5ff; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; white-space: nowrap; }
        .badge-sup { background: rgba(58, 123, 213, 0.2); color: #93c5dd; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; white-space: nowrap; }
        .badge-user { color: var(--text-muted); font-size: 11px; font-family: monospace; }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); padding: 20px; }
        .modal-content { 
            background: var(--card); width: 95%; max-width: 600px; border-radius: 20px; border: 1px solid var(--primary); 
            padding: 25px; max-height: 85vh; display: flex; flex-direction: column;
        }
        #modalBody { overflow-y: auto; margin-top: 15px; padding-right: 5px; }

        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .detail-item { display: flex; align-items: center; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 6px 0; }
        .detail-label { color: var(--text-muted); width: 85px; flex-shrink: 0; }
        .detail-value { color: var(--primary); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        @media (max-width: 480px) { .detail-grid { grid-template-columns: 1fr; } .detail-value { white-space: normal; } }
        
        #workDateDisplay { background: rgba(0, 210, 255, 0.1); border: 1px solid var(--primary); color: var(--primary); font-weight: bold; cursor: pointer; text-align: center; }
        #searchBox { border: 1px solid var(--primary); background: rgba(0, 210, 255, 0.05); margin-top: 10px; }

        /* Progress & Loading */
        #top-progress { position: fixed; top: 0; left: 0; height: 3px; background: linear-gradient(to right, var(--primary), #fff); z-index: 9999; transition: width 0.3s; width: 0%; display: none; box-shadow: 0 0 10px var(--primary); }
        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(5px); z-index: 4000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toasts */
        #toast-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .toast { background: rgba(30, 41, 59, 0.95); color: white; padding: 16px 28px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; gap: 8px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); animation: toastPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; min-width: 200px; text-align: center; }
        .toast.error { border-bottom: 3px solid #ef4444; }
        .toast.success { border-bottom: 3px solid #10b981; }
        .toast.info { border-bottom: 3px solid var(--primary); }
        @keyframes toastPop { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes toastFadeOut { to { transform: scale(0.8); opacity: 0; } }

        /* Logos */
        .login-box img { filter: drop-shadow(0 0 15px var(--primary)) brightness(1.2); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: block; margin: 0 auto 25px auto; max-width: 250px; }
        .login-box img:hover { transform: scale(1.1) rotate(2deg); filter: drop-shadow(0 0 25px var(--primary)) brightness(1.2); }
        .header-logo { height: 55px; filter: drop-shadow(0 0 15px var(--primary)) brightness(1.2); transition: 0.3s; vertical-align: middle; }
        .header-logo:hover { filter: drop-shadow(0 0 25px var(--primary)) brightness(1.2); }
    </style>
</head>
<body>
    
<div id="toast-container"></div>
<div id="top-progress"></div>
<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text" style="color:var(--primary); font-weight:600; font-size:14px;">ƒêANG X·ª¨ L√ù...</div>
</div>
    
<div id="lock-screen">
    <div class="login-box">
        <img src="https://lh3.googleusercontent.com/pw/AP1GczNyKJCNBen1I6WeBIOFBHnduEAc-raKjpQsiE-xMOPlkgBLUxSUPtPfnGUO-h_gVE4xbhoZyycDSfpCjJD_uk7EkCLQJEXeuBytxHxBTDS0NEIMKC7RqBA-GIxKhZed7ddwzYsTmKsh5fKxggPZvFM=w483-h154" alt="Logo">
        <h2 style="color:var(--primary); margin:0 0 20px 0;">B√ÅO C√ÅO K·ª∏ THU·∫¨T</h2>
        <input type="text" id="userInput" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="passInput" placeholder="M·∫≠t kh·∫©u">
        <button class="btn-save" id="btnLogin" onclick="unlock()">ƒêƒÇNG NH·∫¨P</button>
    </div>
</div>

<div class="container" id="main-content" style="display:none;">
    <div class="header">
        <div style="display: flex; align-items: center; gap: 12px;">
           <img src="https://lh3.googleusercontent.com/pw/AP1GczNyKJCNBen1I6WeBIOFBHnduEAc-raKjpQsiE-xMOPlkgBLUxSUPtPfnGUO-h_gVE4xbhoZyycDSfpCjJD_uk7EkCLQJEXeuBytxHxBTDS0NEIMKC7RqBA-GIxKhZed7ddwzYsTmKsh5fKxggPZvFM=w483-h154" class="header-logo" alt="Logo">
        </div>
        <div style="text-align: right">
            <span id="helloUser" style="color:var(--primary); font-size:13px; font-weight:600">---</span>
            <button onclick="logout()" style="color:#ef4444; background:none; border:none; cursor:pointer; margin-left:12px; font-size:12px; font-weight:bold">THO√ÅT</button>
            <small id="syncStatus" style="font-size:10px; color:var(--text-muted); display:block; margin-top:4px">ƒêang ƒë·ªìng b·ªô...</small>
        </div>
    </div>

    <div class="tab-navigation" id="tabBar" style="display:none;">
        <button class="tab-btn active" id="btnTabData" onclick="switchTab('data-tab', this)">üìä B·∫£ng D·ªØ Li·ªáu</button>
        <button class="tab-btn" id="btnTabForm" onclick="switchTab('form-tab', this)">üìë B√°o C√°o M·ªõi</button>
    </div>

    <div id="data-tab" class="tab-content active">
        <input type="text" id="searchBox" onkeyup="filterTable()" placeholder="üîç T√¨m ki·∫øm nhanh (M√°y, kh√°ch, n·ªôi dung...)">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Ng√†y l√†m</th>
                        <th>Kh√°ch h√†ng</th>
                        <th>Lo·∫°i m√°y</th>
                        <th>H·ªó tr·ª£</th>
                        <th>N·ªôi dung</th>
                        <th>K·ªπ thu·∫≠t</th>
                        <th>Ghi ch√∫</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="form-tab" class="tab-content">
        <div id="formContainer" style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px;">
            <input type="text" id="workDateDisplay" readonly onclick="document.getElementById('dateModal').style.display='flex'">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="customer"><option value="">T·∫£i kh√°ch h√†ng...</option></select>
                <select id="techName"><option value="">T·∫£i k·ªπ thu·∫≠t...</option></select>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="machineType"><option value="">-- Lo·∫°i m√°y --</option></select>
                <select id="supportType"><option value="">-- H·ªó tr·ª£ --</option></select>
            </div>

            <textarea id="content" placeholder="M√¥ t·∫£ c√¥ng vi·ªác th·ª±c hi·ªán (B·∫Øt bu·ªôc)..." style="height:100px"></textarea>
            <input type="text" id="note" placeholder="Ghi ch√∫ th√™m (Kh√¥ng b·∫Øt bu·ªôc)...">
            
            <button class="btn-save" id="btnSave" onclick="saveData()">L∆ØU B√ÅO C√ÅO</button>
        </div>
    </div>
</div>

<div id="infoModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content">
        <h3 style="color:var(--primary); text-align:center; margin:0 0 20px 0">CHI TI·∫æT üîé</h3>
        <div id="modalBody"></div>
        <button class="btn-save" style="margin-top:25px" onclick="document.getElementById('infoModal').style.display='none'">ƒê√ìNG</button>
    </div>
</div>

<div id="dateModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content" style="text-align:center">
        <h4 style="margin:0 0 15px 0">CH·ªåN NG√ÄY L√ÄM VI·ªÜC</h4>
        <input type="date" id="hiddenDate" onchange="confirmDate(this.value)">
        <button class="btn-save" onclick="document.getElementById('dateModal').style.display='none'">X√ÅC NH·∫¨N</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
    // --- 1. FIREBASE CONFIG (ORIGINAL) ---
    const firebaseConfig = {
        apiKey: "AIzaSyC-WW6N3ZzmZ8gk_XypHWa3oW6VJMMGloM",
        authDomain: "data-260206.firebaseapp.com",
        projectId: "data-260206",
        storageBucket: "data-260206.firebasestorage.app",
        messagingSenderId: "992766098254",
        appId: "1:992766098254:web:8e9f5d3216541023d03c1f",
        measurementId: "G-E08TFMWZLE"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2. GLOBAL VARIABLES (ORIGINAL) ---
    let AUTH = JSON.parse(localStorage.getItem('tech_auth_v4')) || null;
    let USER_ROLE = "VIEWER"; 
    window.currentLogs = [];

    // --- NEW TAB LOGIC ---
    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
        
        // Reset save button state if returning from edit
        if(tabId === 'form-tab' && document.getElementById('btnSave').innerHTML.includes('C·∫¨P NH·∫¨T')) {
            // keep edit state if user is editing
        } else if (tabId === 'data-tab') {
            resetSaveButton();
        }
    }

    // --- 3. INITIALIZATION (ORIGINAL) ---
    document.addEventListener("DOMContentLoaded", () => {
        setInitialDate();
        checkSession();
        document.getElementById('passInput').addEventListener("keypress", (e) => { if(e.key === "Enter") unlock(); });
    });

    function checkSession() {
        const now = new Date().getTime();
        if (AUTH && AUTH.expire && now < AUTH.expire) {
            USER_ROLE = AUTH.role;
            showApp();
            fetchData();
            showToast(`Ch√†o ${AUTH.user}! H·ªá th·ªëng ƒë√£ s·∫µn s√†ng`, "success");
        } else {
            localStorage.removeItem('tech_auth_v4');
            AUTH = null;
            document.getElementById('lock-screen').style.display = 'flex';
        }
    }

    // --- 4. AUTH & FETCH (ORIGINAL LOGIC) ---
    async function unlock() {
        const u = document.getElementById('userInput').value.trim();
        const p = document.getElementById('passInput').value.trim();
        if(!u || !p) return showToast("Nh·∫≠p ƒë·ªß t√†i kho·∫£n/m·∫≠t kh·∫©u!", "error");
        showLoading(true, "ƒêANG X√ÅC TH·ª∞C...");
        try {
            const userDoc = await db.collection("users").doc(u).get();
            if (!userDoc.exists) { showLoading(false); return showToast("T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i!", "error"); }
            const userData = userDoc.data();
            if (userData.pass !== p) { showLoading(false); return showToast("Sai m·∫≠t kh·∫©u!", "error"); }
            USER_ROLE = userData.role;
            AUTH = { user: u, role: USER_ROLE, access: userData.access || "", expire: new Date().getTime() + (24 * 60 * 60 * 1000) };
            localStorage.setItem('tech_auth_v4', JSON.stringify(AUTH));
            showApp(); fetchData();
            showToast(`Ch√†o m·ª´ng ${u}!`, "welcome");
        } catch (e) { showLoading(false); showToast("L·ªói k·∫øt n·ªëi Firestore!", "error"); }
    }

    function fetchData() {
        if (!AUTH) return;
        let query = db.collection("logs").orderBy("createdAt", "desc").limit(500);
        if (AUTH.role === "VIEWER" && AUTH.access) {
            const allowedList = AUTH.access.split(",").map(s => s.trim());
            if (allowedList.length > 0) query = query.where("customer", "in", allowedList);
        }      
        query.onSnapshot((snapshot) => {
            const logs = snapshot.docs.map(doc => {
                const d = doc.data();
                return [doc.id, d.workDate, d.customer, d.machineType, d.support, d.content, d.tech, d.createdBy || "", d.note || ""];
            });
            renderData({ logs: [["Header"], ...logs], role: AUTH.role });
            applyPermissions();
        });

        if (AUTH.role === "ADMIN" || AUTH.role === "EDIT") {
            db.collection("metadata").doc("dropdowns").onSnapshot((doc) => {
                if (doc.exists) {
                    const d = doc.data();
                    renderData({ 
                        logs: [["Header"], ...window.currentLogs], 
                        role: AUTH.role,
                        customers: d.customers, techs: d.techs, machineTypes: d.machineTypes, supports: d.supports
                    });
                }
            });
        }
    }

    // --- 6. SAVE & UPDATE (ORIGINAL LOGIC) ---
    async function saveData() {
        const d = document.getElementById('hiddenDate').value;
        const c = document.getElementById('customer').value;
        const t = document.getElementById('techName').value;
        const m = document.getElementById('machineType').value;
        const s = document.getElementById('supportType').value;
        const n = document.getElementById('content').value.trim();
        const note = document.getElementById('note').value.trim();

        if (!c || !n || !t || !m || !s) return showToast("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin!", "error");
        const btn = document.getElementById('btnSave');
        btn.disabled = true;
        showLoading(true, "ƒêANG L∆ØU...");
        try {
            await db.collection("logs").add({
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                workDate: d, customer: c, tech: t, machineType: m, support: s, content: n, note: note, createdBy: AUTH.user
            });
            showLoading(false);
            showToast("ƒê√£ l∆∞u th√†nh c√¥ng!", "success");
            document.getElementById('content').value = '';
            document.getElementById('note').value = '';
            btn.disabled = false;
            switchTab('data-tab', document.getElementById('btnTabData'));
        } catch (e) { showLoading(false); btn.disabled = false; showToast("L·ªói khi l∆∞u d·ªØ li·ªáu!", "error"); }
    }

    // --- 7. UI LOGIC (ORIGINAL LOGIC) ---
    function renderData(data) {
        if (data.role !== "VIEWER") {
            const updateDropdown = (id, newData, defaultText) => {
                const select = document.getElementById(id);
                if (!select || !newData) return;
                const currentValue = select.value;
                const newHtml = `<option value="">-- ${defaultText} --</option>` + newData.map(item => `<option value="${item}">${item}</option>`).join('');
                if (select.innerHTML !== newHtml) {
                    select.innerHTML = newHtml;
                    if ([...select.options].some(opt => opt.value === currentValue)) select.value = currentValue;
                }
            };
            if (data.customers) updateDropdown('customer', data.customers, 'Kh√°ch h√†ng');
            if (data.techs) updateDropdown('techName', data.techs, 'K·ªπ thu·∫≠t');
            if (data.machineTypes) updateDropdown('machineType', data.machineTypes, 'Lo·∫°i m√°y');
            if (data.supports) updateDropdown('supportType', data.supports, 'H·ªó tr·ª£');
        }

        window.currentLogs = data.logs.slice(1);
        const html = window.currentLogs.map((row, index) => `
            <tr onclick="openInfoModal(${index})">
                <td style="color:var(--text-muted)">${formatVN(row[1])}</td>
                <td><b style="color:var(--primary)">${row[2] || ''}</b></td>
                <td style="font-size:11px"><span class="badge-mec">${row[3] || ''}</span></td>
                <td><small>${row[4] || ''}</small></td>
                <td style="color:#cbd5e1">${(row[5]||"").substring(0,30)}${(row[5]||"").length>30?'...':''}</td>
                <td><span class="badge-tech">${row[6] || ''}</span></td>
                <td style="font-style:italic; color:var(--text-muted); font-size:12px">
                    ${(row[8] || '').substring(0,15)}${(row[8]||'').length > 15 ? '...' : ''}
                </td>
            </tr>
        `).join('');
        document.getElementById('tableBody').innerHTML = html;
        document.getElementById('syncStatus').innerText = "ƒê·ªìng b·ªô Real-time: " + new Date().toLocaleTimeString();
        showLoading(false);
    }

    function applyPermissions() {
        const tabBar = document.getElementById('tabBar');
        const currentRole = AUTH ? AUTH.role : USER_ROLE;
        if (currentRole === "VIEWER") {
            tabBar.style.display = "none";
        } else {
            tabBar.style.display = "flex";
        }
    }

    function openInfoModal(index) {
        const row = window.currentLogs[index];
        if(!row) return;
        const isAdmin = (AUTH && AUTH.role === "ADMIN");
        let modalHtml = `
            <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; border:1px solid var(--border)">
                <div class="detail-grid">
                    <div class="detail-item"><span class="detail-label">üóìÔ∏è Ng√†y l√†m:</span><span class="detail-value">${formatVN(row[1])}</span></div>
                    <div class="detail-item"><span class="detail-label">üïµÔ∏è‚Äç‚ôÇÔ∏è Kh√°ch:</span><span class="detail-value">${row[2]}</span></div>
                    <div class="detail-item"><span class="detail-label">‚öôÔ∏è Lo·∫°i m√°y:</span><span class="detail-value">${row[3] || '---'}</span></div>
                    <div class="detail-item"><span class="detail-label">üìå H·ªó tr·ª£:</span><span class="detail-value">${row[4] || '---'}</span></div>
                    <div class="detail-item"><span class="detail-label">üë∑‚Äç‚ôÇÔ∏è K·ªπ thu·∫≠t:</span><span class="detail-value">${row[6]}</span></div>
                    <div class="detail-item"><span class="detail-label">ü™™ User:</span><span class="detail-value">${row[7] || '---'}</span></div>
                </div>
                <div style="margin-top:10px; border-top:1px solid var(--border); padding-top:10px">
                    <p style="margin:0 0 5px 0; color:var(--text-muted); font-size:11px; font-weight:600">üìù N·ªòI DUNG:</p>
                    <div style="white-space:pre-wrap; color:#fff; background:rgba(0,0,0,0.3); padding:12px; border-radius:10px; font-size:14px;">${row[5]}</div>
                </div>
                <div style="margin-top:10px">
                    <p style="margin:0 0 5px 0; color:var(--text-muted); font-size:11px; font-weight:600">üóíÔ∏è GHI CH√ö:</p>
                    <div style="color:var(--primary); font-style:italic; font-size:13px">${row[8] || 'Kh√¥ng c√≥ ghi ch√∫.'}</div>
                </div>
            </div>
        `;
        if (isAdmin) {
            modalHtml += `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px">
                    <button onclick="deleteLog('${row[0]}')" style="background:#450a0a; color:#f87171; border:1px solid #7f1d1d; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold">üóëÔ∏è X√ìA B·ªé</button>
                    <button onclick="editLog(${index})" style="background:#1e1b4b; color:#818cf8; border:1px solid #312e81; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold">‚úèÔ∏è CH·ªàNH S·ª¨A</button>
                </div>
            `;
        }   
        document.getElementById('modalBody').innerHTML = modalHtml;
        document.getElementById('infoModal').style.display = 'flex';
    }

    async function deleteLog(docId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA b√°o c√°o n√†y kh√¥ng?")) return;
        showLoading(true, "ƒêANG X√ìA...");
        try {
            await db.collection("logs").doc(docId).delete();
            document.getElementById('infoModal').style.display = 'none';
            showToast("ƒê√£ x√≥a b√°o c√°o th√†nh c√¥ng", "success");
        } catch (e) { showToast("L·ªói khi x√≥a d·ªØ li·ªáu", "error"); } finally { showLoading(false); }
    }

    function editLog(index) {
        const row = window.currentLogs[index];
        document.getElementById('infoModal').style.display = 'none';
        switchTab('form-tab', document.getElementById('btnTabForm'));
        document.getElementById('hiddenDate').value = row[1];
        document.getElementById('workDateDisplay').value = formatVN(row[1]);
        document.getElementById('customer').value = row[2];
        document.getElementById('machineType').value = row[3];
        document.getElementById('supportType').value = row[4];
        document.getElementById('content').value = row[5];
        document.getElementById('techName').value = row[6];
        document.getElementById('note').value = row[8] || "";
        const btnSave = document.getElementById('btnSave');
        btnSave.innerHTML = "üíæ C·∫¨P NH·∫¨T THAY ƒê·ªîI";
        btnSave.onclick = function() { updateLog(row[0]); };
    }

    async function updateLog(docId) {
        showLoading(true, "ƒêANG C·∫¨P NH·∫¨T...");
        try {
            await db.collection("logs").doc(docId).update({
                workDate: document.getElementById('hiddenDate').value,
                customer: document.getElementById('customer').value,
                tech: document.getElementById('techName').value,
                machineType: document.getElementById('machineType').value,
                support: document.getElementById('supportType').value,
                content: document.getElementById('content').value.trim(),
                note: document.getElementById('note').value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showToast("C·∫≠p nh·∫≠t th√†nh c√¥ng!", "success");
            resetSaveButton();
            switchTab('data-tab', document.getElementById('btnTabData'));
        } catch (e) { showToast("L·ªói c·∫≠p nh·∫≠t", "error"); } finally { showLoading(false); }
    }

    function resetSaveButton() {
        const btn = document.getElementById('btnSave');
        btn.innerHTML = "L∆ØU B√ÅO C√ÅO";
        btn.onclick = saveData;
        document.getElementById('content').value = '';
        document.getElementById('note').value = '';
    }

    // --- OTHER HELPERS (ORIGINAL) ---
    function showApp() { document.getElementById('lock-screen').style.display = 'none'; document.getElementById('main-content').style.display = 'block'; document.getElementById('helloUser').innerText = "Ch√†o, " + AUTH.user; }
    function logout() { showToast("ƒê√£ ƒëƒÉng xu·∫•t", "info"); localStorage.removeItem('tech_auth_v4'); setTimeout(() => location.reload(), 500); }
    function setInitialDate() { const iso = new Date().toISOString().split('T')[0]; document.getElementById('hiddenDate').value = iso; document.getElementById('workDateDisplay').value = formatVN(iso); }
    function confirmDate(v) { document.getElementById('workDateDisplay').value = formatVN(v); document.getElementById('dateModal').style.display = 'none'; }
    function formatVN(dStr) { if (!dStr) return ''; const d = new Date(dStr); return isNaN(d) ? dStr : d.getDate().toString().padStart(2,'0') + '/' + (d.getMonth()+1).toString().padStart(2,'0') + '/' + d.getFullYear(); }
    function filterTable() { const v = document.getElementById('searchBox').value.toUpperCase(); const rows = document.getElementById('tableBody').getElementsByTagName('tr'); for (let r of rows) { r.style.display = r.innerText.toUpperCase().includes(v) ? "" : "none"; } }
    function showLoading(status, text = "ƒêANG X·ª¨ L√ù...") { const overlay = document.getElementById('loading-overlay'); const bar = document.getElementById('top-progress'); document.getElementById('loading-text').innerText = text; if(status) { overlay.style.display = 'flex'; bar.style.display = 'block'; bar.style.width = '70%'; } else { bar.style.width = '100%'; setTimeout(() => { overlay.style.display = 'none'; bar.style.display = 'none'; }, 300); } }
    function showToast(message, type = 'info') { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast ${type}`; let icon = '‚ÑπÔ∏è'; if(type === 'error') icon = '‚ö†Ô∏è'; if(type === 'success') icon = '‚úÖ'; if(type === 'welcome') icon = 'üéâ'; toast.innerHTML = `<div style="font-size: 30px; margin-bottom: 5px;">${icon}</div><div style="font-size: 14px; font-weight: 600;">${message.toUpperCase()}</div>`; container.appendChild(toast); setTimeout(() => { toast.style.animation = 'toastFadeOut 0.2s forwards'; setTimeout(() => toast.remove(), 200); }, 2500); }
</script>
</body>
</html>
