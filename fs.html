<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªÜ TH·ªêNG K·ª∏ THU·∫¨T V5</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #00d2ff; --secondary: #3a7bd5; --dark: #0f172a; 
            --card: #1e293b; --border: rgba(255,255,255,0.1);
            --text-main: #f8fafc; --text-muted: #94a3b8;
        }

        body { font-family: 'Inter', sans-serif; background: var(--dark); color: var(--text-main); margin: 0; padding: 12px; line-height: 1.5; }
        
        /* Navigation Tabs */
        .tab-navigation { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid var(--border); sticky; top: 0; z-index: 100; background: var(--dark); }
        .tab-btn { 
            background: #1e293b; color: var(--text-muted); border: 1px solid var(--border); 
            padding: 10px 18px; border-radius: 8px; cursor: pointer; white-space: nowrap; font-size: 13px; font-weight: 600; transition: 0.3s;
        }
        .tab-btn.active { background: var(--primary); color: var(--dark); border-color: var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        /* Tables */
        .table-container { overflow-x: auto; background: var(--card); border-radius: 12px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: rgba(0,0,0,0.2); color: var(--text-muted); font-size: 11px; padding: 12px; text-align: left; text-transform: uppercase; letter-spacing: 1px; }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; }
        tr:hover { background: rgba(0, 210, 255, 0.05); cursor: pointer; }

        /* Forms */
        input, select, textarea { background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 10px; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; }
        .btn-save { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.3s; }
        .btn-save:active { transform: scale(0.98); }

        /* Grid Selection B·∫£ng ch·ªçn kh√°ch h√†ng */
        .cust-selection-box { background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 15px; }
        .cust-header { display: grid; grid-template-columns: 1fr 80px; background: rgba(255,255,255,0.05); padding: 8px 15px; font-size: 11px; font-weight: bold; color: var(--text-muted); }
        .cust-row { display: grid; grid-template-columns: 1fr 80px; align-items: center; padding: 8px 15px; border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer; }
        .cust-row:hover { background: rgba(0, 210, 255, 0.1); }
        
        /* Overlays */
        #lock-screen { position: fixed; inset: 0; background: var(--dark); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 4000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Toast */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 5000; }
        .toast { background: var(--card); color: white; padding: 15px 25px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.3); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

<div id="loading-overlay"><div style="color:var(--primary); font-weight:bold;" id="loading-text">ƒêANG X·ª¨ L√ù...</div></div>
<div id="toast-container"></div>

<div id="lock-screen">
    <div style="width: 320px; background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
        <h2 style="color:var(--primary); text-align:center; margin-top:0;">H·ªÜ TH·ªêNG K·ª∏ THU·∫¨T</h2>
        <input type="text" id="userInput" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="passInput" placeholder="M·∫≠t kh·∫©u">
        <button class="btn-save" onclick="unlock()">ƒêƒÇNG NH·∫¨P</button>
    </div>
</div>

<div id="main-content" style="display:none;">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="color:var(--primary); margin:0;">TECH SYSTEM V5</h3>
        <button onclick="logout()" style="color:#ef4444; background:none; border:none; font-weight:bold; cursor:pointer;">THO√ÅT</button>
    </div>

    <div class="tab-navigation" id="tabBar">
        <button class="tab-btn active" onclick="switchTab('data-tab', this)">üìä D·ªØ li·ªáu</button>
        <button class="tab-btn" id="btnTabForm" onclick="switchTab('form-tab', this)">üìë B√°o c√°o</button>
        <button class="tab-btn" id="btnTabMeta" onclick="switchTab('meta-tab', this)">üß± Kh·ªëi</button>
        <button class="tab-btn" id="btnTabUser" onclick="switchTab('user-tab', this)">üë• User</button>
        <button class="tab-btn" id="btnTabDoc" onclick="switchTab('doc-tab', this)">üìÇ T√†i li·ªáu</button>
    </div>

    <div id="data-tab" class="tab-content active">
        <input type="text" id="searchBox" onkeyup="filterTable()" placeholder="üîç T√¨m ki·∫øm nhanh kh√°ch h√†ng, n·ªôi dung...">
        <div class="table-container">
            <table>
                <thead><tr><th>Ng√†y</th><th>Kh√°ch h√†ng</th><th>M√°y</th><th>K·ªπ thu·∫≠t</th><th>N·ªôi dung</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="form-tab" class="tab-content">
        <div style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary);">
            <input type="date" id="workDate">
            <select id="customer"></select>
            <select id="techName"></select>
            <select id="machineType"></select>
            <select id="supportType"></select>
            <textarea id="content" rows="4" placeholder="N·ªôi dung chi ti·∫øt c√¥ng vi·ªác..."></textarea>
            <input type="text" id="note" placeholder="Ghi ch√∫ th√™m...">
            <button class="btn-save" onclick="saveData()">L∆ØU B√ÅO C√ÅO</button>
        </div>
    </div>

    <div id="meta-tab" class="tab-content">
        <div id="meta-container"></div>
    </div>

    <div id="user-tab" class="tab-content">
        <div style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="text" id="u_id" placeholder="T√™n ƒëƒÉng nh·∫≠p">
                <input type="text" id="u_name" placeholder="H·ªç t√™n">
                <input type="text" id="u_pass" placeholder="M·∫≠t kh·∫©u">
                <select id="u_role"><option value="VIEWER">VIEWER</option><option value="EDIT">EDIT</option><option value="ADMIN">ADMIN</option></select>
            </div>
            <p style="font-size:12px; color:var(--primary); margin:5px 0;">Quy·ªÅn xem kh√°ch h√†ng:</p>
            <div class="cust-selection-box">
                <div class="cust-header"><div>T√äN KH√ÅCH H√ÄNG</div><div style="text-align:center">CHO PH√âP</div></div>
                <div id="user_customer_checks" style="max-height:150px; overflow-y:auto;"></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px;">
                <button class="btn-save" onclick="saveUser(false)" style="background:#065f46">TH√äM</button>
                <button class="btn-save" onclick="saveUser(true)" style="background:#1e3a8a">L∆ØU</button>
                <button class="btn-save" onclick="deleteUser()" style="background:#7f1d1d">X√ìA</button>
                <button class="btn-save" onclick="resetUserForm()" style="background:#475569">M·ªöI</button>
            </div>
        </div>
        <div class="table-container">
            <table><thead><tr><th>ID</th><th>T√™n</th><th>Quy·ªÅn</th><th>Truy c·∫≠p</th></tr></thead><tbody id="userTableBody"></tbody></table>
        </div>
    </div>

    <div id="doc-tab" class="tab-content">
        <div id="doc-admin-panel" style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px;">
            <input type="text" id="doc_name" placeholder="T√™n t√†i li·ªáu">
            <input type="text" id="doc_link" placeholder="Link t·∫£i t√†i li·ªáu">
            <p style="font-size:12px; color:var(--primary); margin:5px 0;">Hi·ªÉn th·ªã cho kh√°ch h√†ng:</p>
            <div class="cust-selection-box">
                <div class="cust-header"><div>T√äN KH√ÅCH H√ÄNG</div><div style="text-align:center">CH·ªåN</div></div>
                <div id="doc_customer_checks" style="max-height:150px; overflow-y:auto;"></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px;">
                <button class="btn-save" onclick="handleDoc(false)" style="background:#065f46">TH√äM</button>
                <button class="btn-save" onclick="handleDoc(true)" style="background:#1e3a8a">L∆ØU</button>
                <button class="btn-save" onclick="deleteDoc()" style="background:#7f1d1d">X√ìA</button>
                <button class="btn-save" onclick="resetDocForm()" style="background:#475569">M·ªöI</button>
            </div>
        </div>
        <div id="doc_display_list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:15px;"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
    // --- C·∫§U H√åNH FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyC-WW6N3ZzmZ8gk_XypHWa3oW6VJMMGloM",
        authDomain: "data-260206.firebaseapp.com",
        projectId: "data-260206",
        storageBucket: "data-260206.firebasestorage.app",
        messagingSenderId: "992766098254",
        appId: "1:992766098254:web:8e9f5d3216541023d03c1f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Fix l·ªói settings l·∫∑p l·∫°i
    try {
        db.settings({ experimentalForceLongPolling: true });
    } catch(e) {}

    let AUTH = JSON.parse(localStorage.getItem('tech_auth_v5')) || null;
    let selectedUserId = null;
    let selectedDocId = null;

    // --- KH·ªûI CH·∫†Y ---
    window.onload = () => {
        if (AUTH && new Date().getTime() < AUTH.expire) showApp();
        else logout();
    };

    // --- X√ÅC TH·ª∞C ---
    async function unlock() {
        const u = document.getElementById('userInput').value.trim();
        const p = document.getElementById('passInput').value.trim();
        showLoading(true);
        try {
            const userDoc = await db.collection("users").doc(u).get();
            if (userDoc.exists && userDoc.data().pass === p) {
                const d = userDoc.data();
                AUTH = { 
                    user: u, role: d.role, 
                    access: d.access || "", 
                    expire: new Date().getTime() + (24*60*60*1000) 
                };
                localStorage.setItem('tech_auth_v5', JSON.stringify(AUTH));
                showApp();
            } else { showToast("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!", "error"); }
        } catch(e) { showToast("L·ªói k·∫øt n·ªëi!", "error"); }
        showLoading(false);
    }

    function showApp() {
        document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        
        applyPermissions();
        fetchData();
        fetchMetadata();
        if(AUTH.role === "ADMIN") fetchUsers();
        fetchDocs();
    }

    function applyPermissions() {
        const r = AUTH.role;
        document.getElementById('btnTabForm').style.display = (r === 'ADMIN' || r === 'EDIT') ? 'block' : 'none';
        document.getElementById('btnTabMeta').style.display = (r === 'ADMIN') ? 'block' : 'none';
        document.getElementById('btnTabUser').style.display = (r === 'ADMIN') ? 'block' : 'none';
        document.getElementById('doc-admin-panel').style.display = (r === 'ADMIN' || r === 'EDIT') ? 'block' : 'none';
    }

    // --- D·ªÆ LI·ªÜU B√ÅO C√ÅO (TAB 1) ---
    function fetchData() {
        let query = db.collection("logs").orderBy("createdAt", "desc").limit(200);
        if (AUTH.role === "VIEWER") {
            const allowed = AUTH.access.split(",").map(s => s.trim()).filter(s => s !== "");
            if (allowed.length > 0) query = query.where("customer", "in", allowed);
            else { document.getElementById('tableBody').innerHTML = ""; return; }
        }

        query.onSnapshot(snap => {
            document.getElementById('tableBody').innerHTML = snap.docs.map(doc => {
                const d = doc.data();
                return `<tr onclick="alert('${d.content}')">
                    <td>${d.workDate}</td>
                    <td><b>${d.customer}</b></td>
                    <td>${d.machineType}</td>
                    <td>${d.tech}</td>
                    <td style="color:var(--text-muted)">${d.content.substring(0,40)}...</td>
                </tr>`;
            }).join('');
        });
    }

    async function saveData() {
        const data = {
            workDate: document.getElementById('workDate').value,
            customer: document.getElementById('customer').value,
            tech: document.getElementById('techName').value,
            machineType: document.getElementById('machineType').value,
            support: document.getElementById('supportType').value,
            content: document.getElementById('content').value,
            note: document.getElementById('note').value,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: AUTH.user
        };
        showLoading(true);
        await db.collection("logs").add(data);
        showToast("ƒê√£ l∆∞u b√°o c√°o th√†nh c√¥ng!", "success");
        switchTab('data-tab', document.querySelector('.tab-btn'));
        showLoading(false);
    }

    // --- QU·∫¢N L√ù KH·ªêI (TAB 3) ---
    function fetchMetadata() {
        db.collection("metadata").doc("dropdowns").onSnapshot(doc => {
            if (!doc.exists) return;
            const d = doc.data();
            const custs = d.customers || [];
            
            // Load dropdowns tab b√°o c√°o
            const updateSelect = (id, list) => {
                document.getElementById(id).innerHTML = list.map(v => `<option value="${v}">${v}</option>`).join('');
            };
            updateSelect('customer', custs);
            updateSelect('techName', d.techs || []);
            updateSelect('machineType', d.machineTypes || []);
            updateSelect('supportType', d.supports || []);

            // Load Checkbox b·∫£ng ch·ªçn (Tab 4 & 5)
            const fillChecks = (containerId, name) => {
                document.getElementById(containerId).innerHTML = custs.map(c => `
                    <label class="cust-row">
                        <span>${c}</span>
                        <input type="checkbox" name="${name}" value="${c}">
                    </label>
                `).join('');
            };
            fillChecks('user_customer_checks', 'u_access_cust');
            fillChecks('doc_customer_checks', 'doc_cust');
            
            if(AUTH.role === "ADMIN") renderMetaAdmin(d);
        });
    }

    // --- QU·∫¢N L√ù T√ÄI KHO·∫¢N (TAB 4) ---
    function fetchUsers() {
        db.collection("users").onSnapshot(snap => {
            document.getElementById('userTableBody').innerHTML = snap.docs.map(doc => {
                const u = doc.data();
                return `<tr onclick="loadUserToForm('${doc.id}', '${u.name}', '${u.role}', '${u.pass}', '${u.access || ""}')">
                    <td><b>${doc.id}</b></td><td>${u.name}</td><td>${u.role}</td><td>${u.access || "ALL"}</td>
                </tr>`;
            }).join('');
        });
    }

    function loadUserToForm(id, name, role, pass, access) {
        selectedUserId = id;
        document.getElementById('u_id').value = id;
        document.getElementById('u_name').value = name;
        document.getElementById('u_role').value = role;
        document.getElementById('u_pass').value = pass;
        const allowed = access.split(",").map(s => s.trim());
        document.querySelectorAll('input[name="u_access_cust"]').forEach(ch => ch.checked = allowed.includes(ch.value));
    }

    async function saveUser(isUpdate) {
        const id = document.getElementById('u_id').value.trim();
        const access = Array.from(document.querySelectorAll('input[name="u_access_cust"]:checked')).map(c => c.value).join(", ");
        const data = {
            name: document.getElementById('u_name').value,
            role: document.getElementById('u_role').value,
            pass: document.getElementById('u_pass').value,
            access: access
        };
        showLoading(true);
        if(isUpdate) await db.collection("users").doc(id).update(data);
        else await db.collection("users").doc(id).set(data);
        showToast("Thao t√°c t√†i kho·∫£n th√†nh c√¥ng!");
        resetUserForm();
        showLoading(false);
    }

    // --- QU·∫¢N L√ù T√ÄI LI·ªÜU (TAB 5) ---
    function fetchDocs() {
        db.collection("documents").onSnapshot(snap => {
            const allDocs = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            let filtered = allDocs;
            if(AUTH.role === "VIEWER") {
                const myAccess = AUTH.access.split(",").map(s => s.trim());
                filtered = allDocs.filter(d => !d.customers || d.customers.length === 0 || d.customers.some(c => myAccess.includes(c)));
            }
            
            document.getElementById('doc_display_list').innerHTML = filtered.map(d => `
                <div style="background:var(--card); padding:15px; border-radius:12px; border:1px solid var(--border); position:relative;" onclick="loadDocToForm('${d.id}','${d.name}','${d.link}',${JSON.stringify(d.customers||[])})">
                    <h4 style="margin:0; color:var(--primary)">üìÑ ${d.name}</h4>
                    <p style="font-size:11px; color:var(--text-muted); margin:5px 0;">Quy·ªÅn: ${(!d.customers || d.customers.length===0) ? "C√¥ng khai" : d.customers.join(", ")}</p>
                    <a href="${d.link}" target="_blank" style="display:block; background:var(--secondary); color:white; text-align:center; padding:10px; border-radius:8px; text-decoration:none; margin-top:10px; font-weight:600;">T·∫¢I T√ÄI LI·ªÜU</a>
                </div>
            `).join('');
        });
    }

    async function handleDoc(isUpdate) {
        const custs = Array.from(document.querySelectorAll('input[name="doc_cust"]:checked')).map(c => c.value);
        const data = {
            name: document.getElementById('doc_name').value,
            link: document.getElementById('doc_link').value,
            customers: custs
        };
        showLoading(true);
        if(isUpdate) await db.collection("documents").doc(selectedDocId).update(data);
        else await db.collection("documents").add(data);
        showToast("L∆∞u t√†i li·ªáu th√†nh c√¥ng!");
        resetDocForm();
        showLoading(false);
    }

    function loadDocToForm(id, name, link, custs) {
        if(AUTH.role === "VIEWER") return;
        selectedDocId = id;
        document.getElementById('doc_name').value = name;
        document.getElementById('doc_link').value = link;
        document.querySelectorAll('input[name="doc_cust"]').forEach(ch => ch.checked = custs.includes(ch.value));
    }

    // --- TI·ªÜN √çCH ---
    function switchTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function showToast(m, type="success") {
        const t = document.createElement('div');
        t.className = 'toast';
        t.style.borderLeftColor = type === "error" ? "#ef4444" : "#00d2ff";
        t.innerText = m;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    function showLoading(s) { document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none'; }
    function logout() { localStorage.removeItem('tech_auth_v5'); location.reload(); }
    function filterTable() {
        const v = document.getElementById('searchBox').value.toUpperCase();
        document.querySelectorAll('#tableBody tr').forEach(tr => {
            tr.style.display = tr.innerText.toUpperCase().includes(v) ? "" : "none";
        });
    }
    function resetUserForm() {
        document.getElementById('u_id').value = ""; document.getElementById('u_name').value = "";
        document.querySelectorAll('input[name="u_access_cust"]').forEach(ch => ch.checked = false);
    }
    function resetDocForm() {
        document.getElementById('doc_name').value = ""; document.getElementById('doc_link').value = "";
        document.querySelectorAll('input[name="doc_cust"]').forEach(ch => ch.checked = false);
    }

    // Render Editor cho Admin ·ªü Tab 3
    function renderMetaAdmin(d) {
        const container = document.getElementById('meta-container');
        const keys = [
            {k:'customers', n:'KH√ÅCH H√ÄNG'}, {k:'techs', n:'K·ª∏ THU·∫¨T'}, 
            {k:'machineTypes', n:'LO·∫†I M√ÅY'}, {k:'supports', n:'H·ªñ TR·ª¢'}
        ];
        container.innerHTML = keys.map(obj => `
            <div style="background:var(--card); padding:15px; border-radius:12px; border:1px solid var(--border); margin-bottom:15px;">
                <h4 style="margin:0 0 10px 0; color:var(--primary)">${obj.n}</h4>
                <textarea id="meta_${obj.k}" rows="3">${(d[obj.k] || []).join(', ')}</textarea>
                <button class="btn-save" style="padding:8px;" onclick="saveMeta('${obj.k}')">C·∫¨P NH·∫¨T ${obj.n}</button>
            </div>
        `).join('');
    }

    async function saveMeta(key) {
        const val = document.getElementById(`meta_${key}`).value.split(',').map(s => s.trim()).filter(s => s !== "");
        showLoading(true);
        await db.collection("metadata").doc("dropdowns").update({ [key]: val });
        showToast("ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu kh·ªëi!");
        showLoading(false);
    }
</script>
</body>
</html>
