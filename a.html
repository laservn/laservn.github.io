<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="color-scheme" content="light dark">
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <script>
            var domainChinh = "tech.laser.info.vn";
            if (window.location.hostname !== domainChinh && window.location.hostname !== "localhost" && window.location.protocol !== "file:") {
               //  window.location.replace("https://tech.laser.info.vn" + window.location.pathname + window.location.search);
            }
        </script>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>B√ÅO C√ÅO K·ª∏ THU·∫¨T</title>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ†Ô∏è</text></svg>">
        <style>
            :root {
                --primary: #00d2ff;
                --secondary: #3a7bd5;
                --dark: #0f172a;
                --card: #1e293b;
                --border: rgba(255, 255, 255, 0.1);
                --text-main: #f8fafc;
                --text-muted: #94a3b8;
                --success: #10b981;
                --warning: #f59e0b;
            }

            body {
                font-family: 'Inter', sans-serif;
                background: var(--dark);
                color: var(--text-main);
                margin: 0;
                padding: 12px;
                line-height: 1.5;
                -webkit-tap-highlight-color: transparent;
            }

            /* Tab Navigation */
            .tab-navigation {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                background: rgba(0, 0, 0, 0.2);
                padding: 5px;
                border-radius: 12px;
                border: 1px solid var(--border);
            }

            .tab-btn {
                flex: 1;
                padding: 12px;
                border: none;
                background: none;
                color: var(--text-muted);
                font-weight: 600;
                cursor: pointer;
                border-radius: 8px;
                transition: 0.3s;
                font-size: 13px;
                text-transform: uppercase;
            }

            .tab-btn.active {
                background: var(--primary);
                color: var(--dark);
                box-shadow: 0 0 15px rgba(0, 210, 255, 0.4);
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            /* Login Screen */
            #lock-screen {
                position: fixed;
                inset: 0;
                background: var(--dark);
                z-index: 3000;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .login-box {
                width: 320px;
                padding: 30px;
                background: var(--card);
                border-radius: 20px;
                border: 1px solid var(--border);
                text-align: center;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            }

            .login-box img {
                filter: drop-shadow(0 0 15px var(--primary)) brightness(1.2);
            }


            /* Container & Header */
            .container {
                max-width: 1000px;
                margin: auto;
            }

            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid var(--border);
                padding-bottom: 12px;
                margin-bottom: 20px;
            }

            /* Inputs */
            input, select, textarea {
                background: #0f172a;
                border: 1px solid #334155;
                color: white;
                padding: 12px;
                border-radius: 10px;
                width: 100%;
                box-sizing: border-box;
                margin-bottom: 12px;
                outline: none;
                transition: 0.3s;
                font-size: 14px;
            }

            input:focus, select:focus, textarea:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 2px rgba(0, 210, 255, 0.2);
            }

            .btn-save {
                background: linear-gradient(45deg, var(--primary), var(--secondary));
                color: white;
                border: none;
                padding: 14px;
                border-radius: 10px;
                cursor: pointer;
                font-weight: 600;
                width: 100%;
                transition: transform 0.1s;
            }

            .btn-save:active {
                transform: scale(0.98);
            }

            .btn-save:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            /* Professional Table */
            .table-container {
                margin-top: 15px;
                border: 1px solid var(--border);
                border-radius: 12px;
                overflow-x: auto;
                background: var(--card);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }

            table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                min-width: 850px;
            }

            th {
                background: #111827;
                color: var(--text-muted);
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                padding: 14px 12px;
                border-bottom: 2px solid var(--border);
                text-align: left;
            }

            td {
                padding: 14px 12px;
                border-bottom: 1px solid var(--border);
                font-size: 13px;
                cursor: pointer;
                transition: 0.2s;
            }

            tbody tr:nth-child(even) {
                background: rgba(255, 255, 255, 0.02);
            }

            tbody tr:hover td {
                background: rgba(0, 210, 255, 0.08);
            }

            .badge-tech {
                background: rgba(58, 123, 213, 0.2);
                color: #93c5fd;
                padding: 4px 8px;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 600;
                white-space: nowrap;
            }

            .badge-mec {
                background: rgba(58, 123, 213, 0.2);
                color: #93c5ff;
                padding: 4px 8px;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 600;
                white-space: nowrap;
            }

            .badge-sup {
                background: rgba(58, 123, 213, 0.2);
                color: #93c5dd;
                padding: 4px 8px;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 600;
                white-space: nowrap;
            }

            /* Popup Modals */
            .modal {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.85);
                z-index: 2000;
                justify-content: center;
                align-items: center;
                backdrop-filter: blur(4px);
                padding: 20px;
            }

            .modal-content {
                background: var(--card);
                width: 95%;
                max-width: 600px;
                border-radius: 20px;
                border: 1px solid var(--primary);
                padding: 25px;
                max-height: 85vh;
                display: flex;
                flex-direction: column;
            }

            #modalBody {
                overflow-y: auto;
                margin-top: 15px;
                padding-right: 5px;
            }

            .detail-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 7px;
                margin-bottom: 15px;
            }

            .detail-item {
                display: flex;
                align-items: center;
                font-size: 13px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                padding: 3px 0;
            }

            .detail-label {
                color: var(--text-muted);
                width: 100px;
                flex-shrink: 0;
            }

            .detail-value {
                color: var(--primary);
                font-weight: 600;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Metadata Block Style (Tab 3) */
            .meta-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                margin-top: 10px;
            }

            .meta-col {
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 15px;
                display: flex;
                flex-direction: column;
            }

            .meta-col h4 {
                margin: 0 0 12px 0;
                color: var(--primary);
                font-size: 12px;
                text-align: center;
                border-bottom: 1px solid var(--border);
                padding-bottom: 8px;
            }

            .meta-list {
                flex-grow: 1;
                min-height: 250px;
                max-height: 400px;
                overflow-y: auto;
            }

            .meta-item {
                background: rgba(0, 0, 0, 0.2);
                margin-bottom: 4px;
                border-radius: 6px;
                border: 1px solid transparent;
            }

            .meta-item input {
                margin-bottom: 0;
                padding: 8px;
                font-size: 12px;
                background: transparent;
                border: none;
                color: #fff;
            }

            .meta-item.editing {
                background: #0f172a;
                border-color: var(--primary);
            }

            .meta-item.editing input {
                background: #1e293b;
            }

            .meta-actions {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 5px;
                margin-top: 12px;
            }

            .btn-meta {
                padding: 8px;
                border-radius: 6px;
                border: none;
                font-size: 11px;
                font-weight: 600;
                cursor: pointer;
                text-transform: uppercase;
            }

            .btn-edit-mode {
                background: rgba(0, 210, 255, 0.1);
                color: var(--primary);
                border: 1px solid var(--primary);
            }

            .btn-save-mode {
                background: var(--primary);
                color: var(--dark);
            }

            @media (max-width: 480px) {
                .meta-grid {
                    grid-template-columns: 1fr;
                }

                .detail-grid {
                    grid-template-columns: 1fr;
                }
            }

            #workDateDisplay {
                background: rgba(0, 210, 255, 0.1);
                border: 1px solid var(--primary);
                color: var(--primary);
                font-weight: bold;
                cursor: pointer;
                text-align: center;
            }

            #searchBox {
                border: 1px solid var(--primary);
                background: rgba(0, 210, 255, 0.05);
                margin-top: 10px;
            }

            /* Progress & Loading */
            #top-progress {
                position: fixed;
                top: 0;
                left: 0;
                height: 3px;
                background: linear-gradient(to right, var(--primary), #fff);
                z-index: 9999;
                transition: width 0.3s;
                width: 0%;
                display: none;
            }

            #loading-overlay {
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.8);
                backdrop-filter: blur(5px);
                z-index: 4000;
                display: none;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid rgba(255, 255, 255, 0.1);
                border-top: 4px solid var(--primary);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            /* Toasts */
            #toast-container {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 10000;
                display: flex;
                flex-direction: column;
                align-items: center;
                pointer-events: none;
            }

            .toast {
                background: rgba(30, 41, 59, 0.95);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                margin-bottom: 10px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                text-align: center;
                border: 1px solid rgba(255, 255, 255, 0.1);
                animation: toastPop 0.3s forwards;
                min-width: 300px;
                max-width: 90vw;
            }

            @keyframes toastPop {
                from {
                    transform: scale(0.5);
                    opacity: 0;
                }
                to {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            .header-logo {
                height: 55px;
                filter: drop-shadow(0 0 15px var(--primary)) brightness(1.2);
            }

            .cust-row:hover {
                background: rgba(0, 210, 255, 0.1);
            }

            .card {
                height: 200px;
                position: relative;
                margin-bottom: 20px;
            }

            .main-footer {
                border-top: 1px solid var(--border);
                padding: 40px 20px 20px 20px;
                margin-top: 50px;
            }

            .footer-content {
                max-width: 1200px;
                margin: 0 auto;
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 40px;
            }

            .footer-section h3 {
                font-size: 22px;
                letter-spacing: 1px;
                margin-bottom: 15px;
            }

            .footer-logo span {
                color: var(--primary);
            }

            .footer-section h4 {
                color: var(--primary);
                font-size: 14px;
                text-transform: uppercase;
                margin-bottom: 20px;
                letter-spacing: 2px;
            }

            .footer-section p {
                color: var(--text-muted);
                font-size: 14px;
                line-height: 1.6;
            }

            .footer-links {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .footer-links a {
                color: var(--text-muted);
                text-decoration: none;
                font-size: 14px;
                transition: 0.3s;
            }

            .footer-links a:hover {
                color: var(--primary);
                padding-left: 5px;
            }

            .footer-bottom {
                max-width: 1200px;
                margin: 40px auto 0 auto;
                padding-top: 10px;
                border-top: 1px solid rgba(255, 255, 255, 0.05);
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 15px;
                justify-content: center;
                align-items: center;
                text-align: center;
                flex-direction: column;
            }

            .footer-bottom p {
                color: var(--text-muted);
                font-size: 12px;
            }

            .status-indicator {
                font-size: 12px;
                color: #10b981;
                display: flex;
                align-items: center;
                gap: 8px;
                background: rgba(16, 185, 129, 0.1);
                padding: 5px 12px;
                border-radius: 20px;
                float: right;
            }

            .status-indicator .dot {
                width: 8px;
                height: 8px;
                background: #10b981;
                border-radius: 50%;
                box-shadow: 0 0 10px #10b981;
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.4;
                }
                100% {
                    opacity: 1;
                }
            }

            @media (max-width: 768px) {
                .footer-bottom {
                    justify-content: center;
                    text-align: center;
                }
            }

            .status-indicator.offline {
                color: #ef4444;
                background: rgba(239, 68, 68, 0.1);
            }

            .status-indicator.offline .dot {
                background: #ef4444;
                box-shadow: none;
                animation: none;
            }

            .footer-links a::after {
                content: " ‚Üó";
                font-size: 10px;
                opacity: 0.5;
                transition: 0.3s;
            }

            .footer-links a:hover::after {
                opacity: 1;
                margin-left: 5px;
            }

            @media (min-width: 769px) {
                .tab-navigation {
                    width: 100px;
                    position: fixed;
                    left: 0;
                    top: 0;
                    height: 100vh;
                    flex-direction: column;
                    padding: 10px;
                    z-index: 1000;
                    background: #0f172a;
                    border-right: 1px solid var(--border);
                    display: flex;
                    box-sizing: border-box;
                }

                .tab-btn {
                    flex: 1;
                    max-height: 15vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 3vw !important;
                    padding: 5px !important;
                    margin: 2px 0;
                }

                .container {
                    margin-left: 120px !important;
                    max-width: calc(100% - 140px) !important;
                }
            }

            @media (max-width: 768px) {
                .tab-navigation {
                    position: fixed;
                    bottom: 0; left: 0; right: 0;
                    height: 40px;
                    flex-direction: row;
                    z-index: 1000;
                    background: #0f172a;
                    margin-bottom: 0;
                }

                .container {
                    margin-bottom: 80px !important;
                }

                .tab-btn {
                    font-size: 22px !important;
                    padding: 2px !important;
                }
            }

            .input-group {
                position: relative;
                margin-bottom: 15px;
                text-align: left;
            }

            .input-group i {
                position: absolute;
                left: 15px;
                top: 14px;
                color: var(--primary);
            }

            .input-group input {
                padding: 12px 15px 12px 45px !important;
                margin-bottom: 0;
                background: rgba(15, 23, 42, 0.5);
                border: 1px solid var(--border);
            }

            /* PROCESS BAR STYLE */
            .process-progress-container {
                background: var(--card);
                padding: 15px;
                border-radius: 12px;
                border: 1px solid var(--border);
                margin-bottom: 20px;
            }
            .progress-track {
                height: 20px;
                background: #334155;
                border-radius: 10px;
                overflow: hidden;
                position: relative;
                margin-top: 10px;
            }
            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #10b981, #34d399);
                width: 0%;
                transition: width 0.5s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #064e3b;
                font-size: 10px;
                font-weight: bold;
            }
            .progress-labels {
                display: flex;
                justify-content: space-between;
                font-size: 11px;
                color: var(--text-muted);
                margin-bottom: 5px;
            }
        </style>
    </head>
<body>

<div id="toast-container"></div>
<div id="top-progress"></div>
<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text" style="color:var(--primary); font-weight:600; margin-top:10px;">ƒêANG X·ª¨ L√ù...</div>
</div>

<form id="lock-screen" onsubmit="handleLogin(event)">
    <div class="login-box">
        <img src="https://lh3.googleusercontent.com/pw/AP1GczNyKJCNBen1I6WeBIOFBHnduEAc-raKjpQsiE-xMOPlkgBLUxSUPtPfnGUO-h_gVE4xbhoZyycDSfpCjJD_uk7EkCLQJEXeuBytxHxBTDS0NEIMKC7RqBA-GIxKhZed7ddwzYsTmKsh5fKxggPZvFM=w483-h154" alt="Logo" style="width: 250px; margin-bottom: 20px;">
        <h2 style="color:var(--primary); margin:0;">B√ÅO C√ÅO K·ª∏ THU·∫¨T</h2>
        <p style="margin-top: 5px; font-size: 0.75rem; color: var(--text-muted);">H·ªá th·ªëng qu·∫£n l√Ω b√°o c√°o c√¥ng vi·ªác</p>
        <div class="input-group">
            <i class="fas fa-user"></i>
            <input type="text" id="userInput" spellcheck="false" placeholder="T√™n ƒëƒÉng nh·∫≠p" required autocomplete="username">
        </div>
        <div class="input-group">
            <i class="fas fa-lock"></i>
            <input type="password" id="passInput" spellcheck="false" placeholder="M·∫≠t kh·∫©u" required autocomplete="current-password">
        </div>
        <button type="submit" class="btn-save" style="margin-top:10px">
            <span>ƒêƒÇNG NH·∫¨P</span>
            <i class="fas fa-sign-in-alt" style="margin-left:8px"></i>
        </button>
        <div style="margin-top: 25px; font-size: 0.75rem; color: var(--text-muted);">
            ¬© 2026 B·∫£n quy·ªÅn thu·ªôc b·ªô ph·∫≠n K·ªπ thu·∫≠t
        </div>

    </div>
</form>

<div class="container" id="main-content" style="display:none;">
    <div class="header">
        <img src="https://lh3.googleusercontent.com/pw/AP1GczNyKJCNBen1I6WeBIOFBHnduEAc-raKjpQsiE-xMOPlkgBLUxSUPtPfnGUO-h_gVE4xbhoZyycDSfpCjJD_uk7EkCLQJEXeuBytxHxBTDS0NEIMKC7RqBA-GIxKhZed7ddwzYsTmKsh5fKxggPZvFM=w483-h154" class="header-logo" alt="Logo">
        <div style="text-align: right">
            <span id="helloUser" style="color:var(--primary); font-size:13px; font-weight:600">---</span>
            <button onclick="signOut()"
                    style="color:#ef4444; background:none; border:none; cursor:pointer; margin-left:12px; font-size:12px; font-weight:bold">
                THO√ÅT
            </button>
            <small id="syncStatus" style="font-size:10px; color:var(--text-muted); display:block; margin-top:4px">ƒêang
                ƒë·ªìng b·ªô...</small>
            <div class="status-indicator" id="network-status-container">
                <span class="dot" id="status-dot"></span>
                <span id="status-text">H·ªá th·ªëng ƒëang tr·ª±c tuy·∫øn</span>
            </div>
        </div>
    </div>

    <div class="tab-navigation" id="tabBar" style="display:none;">
        <button class="tab-btn active" onclick="switchTab('dashboard', this)" style="font-size: 40px;">üè†</button>
        <button class="tab-btn" onclick="switchTab('data-tab', this)" style="font-size: 40px;">üìë</button>
        <button class="tab-btn" id="btnTabForm" onclick="switchTab('form-tab', this)" style="font-size: 40px;">üìù</button>
        <button class="tab-btn" id="btnTabProcess" onclick="switchTab('process-tab', this)" style="font-size: 40px;">üöÄ</button>
        
        <button class="tab-btn" id="btnTabMeta" onclick="switchTab('meta-tab', this)" style="font-size: 40px;">‚öôÔ∏è</button>
        <button class="tab-btn" id="btnTabUser" onclick="switchTab('user-tab', this)" style="font-size: 40px;">üë®‚Äçüîß</button>
        <button class="tab-btn" id="btnTabDoc" onclick="switchTab('doc-tab', this)" style="font-size: 40px;">üìÇ</button>
    </div>

    <div id="dashboard" class="tab-content active">
        <div id="dash-progress-container" class="process-progress-container" style="display:none;">
             <div class="progress-labels">
                <span><i class="fas fa-tasks"></i> TI·∫æN TR√åNH C√îNG VI·ªÜC D·ª∞ KI·∫æN</span>
                <span id="dash-progress-text">0% Ho√†n th√†nh</span>
            </div>
            <div class="progress-track">
                <div id="dash-progress-fill" class="progress-fill"></div>
            </div>
             <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:11px;">
                <span style="color:var(--text-muted)">T·ªïng: <b id="dash-total" style="color:white">0</b></span>
                <span style="color:#10b981">Xong: <b id="dash-done">0</b></span>
                <span style="color:#f59e0b">Ch∆∞a: <b id="dash-pending">0</b></span>
            </div>
        </div>

        <div class="inner-filter-box"
             style="background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
            <div style="flex: 1; min-width: 150px;">
                <label style="font-size: 11px; color: var(--primary); font-weight: bold; display: block; margin-bottom: 5px;">TH·ªúI
                    GIAN</label>
                <select class="timePreset" onchange="handlePresetChange(this)"
                        style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
                    <option value="7days" selected>7 ng√†y qua</option>
                    <option value="all">T·∫•t c·∫£ th·ªùi gian</option>
                    <option value="today">H√¥m nay</option>
                    <option value="thisMonth">Th√°ng n√†y</option>
                    <option value="custom">T√πy ch·ªçn...</option>
                </select>
            </div>

            <div class="customDateGroup" style="display: none; gap: 10px; flex: 2; min-width: 250px;">
                <div style="flex:1">
                    <input type="date" class="filterFrom" onchange="syncAndFilter(this)"
                           style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
                </div>
                <div style="flex:1">
                    <input type="date" class="filterTo" onchange="syncAndFilter(this)"
                           style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
                </div>
            </div>

            <div style="flex: 1; min-width: 150px;">
                <label style="font-size: 11px; color: var(--primary); font-weight: bold; display: block; margin-bottom: 5px;">KH√ÅCH
                    H√ÄNG</label>
                <select class="filterCust" onchange="syncAndFilter(this)"
                        style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
                    <option value="ALL">T·∫•t c·∫£ kh√°ch h√†ng</option>
                </select>
            </div>
        </div>

        <div class="card" style="position: relative; padding:15px; height: 400px; width: 100%;">
            <h4 style="margin-top:0; color:var(--primary); ">üïµÔ∏è‚Äç‚ôÇÔ∏è Kh√°ch H√†ng</h4>
            <canvas id="chartCust"></canvas>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top:40px">
            <div class="card" style="padding:15px;">
                <h4 style="margin-top:0; color:var(--primary);">‚öôÔ∏è Lo·∫°i M√°y</h4>
                <canvas id="chartMachine"></canvas>
            </div>
            <div class="card" style="padding:15px;">
                <h4 style="margin-top:0; color:var(--primary);">üë®‚Äçüîß K·ªπ Thu·∫≠t Vi√™n</h4>
                <canvas id="chartStaff"></canvas>
            </div>
            <div class="card" style="padding:15px;">
                <h4 style="margin-top:0; color:var(--primary);">ü§ù Lo·∫°i H·ªó Tr·ª£</h4>
                <canvas id="chartSupport"></canvas>
            </div>
        </div>
    </div>

    <div id="data-tab" class="tab-content">

        <div class="inner-filter-box"
             style="background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
            <div style="flex: 1; min-width: 150px;">
                <label style="font-size: 11px; color: var(--primary); font-weight: bold; display: block; margin-bottom: 5px;">TH·ªúI
                    GIAN</label>
                <select class="timePreset" onchange="handlePresetChange(this)"
                        style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
                    <option value="7days" selected>7 ng√†y qua</option>
                    <option value="all">T·∫•t c·∫£ th·ªùi gian</option>
                    <option value="today">H√¥m nay</option>
                    <option value="thisMonth">Th√°ng n√†y</option>
                    <option value="custom">T√πy ch·ªçn...</option>
                </select>
            </div>

            <div class="customDateGroup" style="display: none; gap: 10px; flex: 2; min-width: 250px;">
                <div style="flex:1">
                    <input type="date" class="filterFrom" onchange="syncAndFilter(this)"
                           style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
                </div>
                <div style="flex:1">
                    <input type="date" class="filterTo" onchange="syncAndFilter(this)"
                           style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
                </div>
            </div>

            <div style="flex: 1; min-width: 150px;">
                <label style="font-size: 11px; color: var(--primary); font-weight: bold; display: block; margin-bottom: 5px;">KH√ÅCH
                    H√ÄNG</label>
                <select class="filterCust" onchange="syncAndFilter(this)"
                        style="width:100%; padding:8px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
                    <option value="ALL">T·∫•t c·∫£ kh√°ch h√†ng</option>
                </select>
            </div>
        </div>

        <input type="text" id="searchBox" onkeyup="filterTable()"
               spellcheck="false" placeholder="üîç T√¨m ki·∫øm nhanh (M√°y, kh√°ch, n·ªôi dung...)">
        <div class="table-container">
            <table>
                <thead>
                <tr>
                    <th>Ng√†y l√†m</th>
                    <th>Kh√°ch h√†ng</th>
                    <th>Lo·∫°i m√°y</th>
                    <th>H·ªó tr·ª£</th>
                    <th>N·ªôi dung</th>
                    <th>K·ªπ thu·∫≠t</th>
                    <th>Ghi ch√∫</th>
                </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="form-tab" class="tab-content">
        <div id="formContainer"
             style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px;">
            <input type="text" id="workDateDisplay" readonly
                   onclick="document.getElementById('dateModal').style.display='flex'">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="customer"><option value="">T·∫£i kh√°ch h√†ng...</option></select>
                <select id="techName"><option value="">T·∫£i k·ªπ thu·∫≠t...</option></select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="machineType"><option value="">-- Lo·∫°i m√°y --</option></select>
                <select id="supportType"><option value="">-- H·ªó tr·ª£ --</option></select>
            </div>
            <textarea id="content" spellcheck="false" placeholder="M√¥ t·∫£ c√¥ng vi·ªác th·ª±c hi·ªán (B·∫Øt bu·ªôc)..."
                      style="height:100px"></textarea>
            <input type="text" id="note" spellcheck="false" placeholder="Ghi ch√∫ th√™m (Kh√¥ng b·∫Øt bu·ªôc)...">
            <button class="btn-save" id="btnSave" onclick="saveData()">L∆ØU B√ÅO C√ÅO</button>
        </div>
    </div>

    <div id="process-tab" class="tab-content">

        <div id="proc-progress-container" class="process-progress-container">
             <div class="progress-labels">
                <span><i class="fas fa-tasks"></i> TI·∫æN TR√åNH C√îNG VI·ªÜC D·ª∞ KI·∫æN</span>
                <span id="proc-progress-text">0% Ho√†n th√†nh</span>
            </div>
            <div class="progress-track">
                <div id="proc-progress-fill" class="progress-fill"></div>
            </div>
             <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:11px;">
                <span style="color:var(--text-muted)">T·ªïng: <b id="proc-total" style="color:white">0</b></span>
                <span style="color:#10b981">Xong: <b id="proc-done">0</b></span>
                <span style="color:#f59e0b">Ch∆∞a: <b id="proc-pending">0</b></span>
            </div>
        </div>
        
	<button onclick="toggleForm('proc-progress-container-form', this)" class="btn-save" style="margin-bottom: 10px; background: #334155; width: auto; padding: 8px 15px; width: 100% !important;">
        <i class="fas fa-plus-circle"></i> ·∫®N/ HI·ªÜN FORM
    	</button>
    	<div id="proc-progress-container-form" style="display: none">
		<div style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px;">
		    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
		         <div class="input-group" style="margin-bottom:0">
		            <label style="font-size:10px; color:var(--text-muted)">Ng√†y b·∫Øt ƒë·∫ßu:</label>
		            <input type="date" id="proc_start_date" style="padding-left:12px!important">
		         </div>
		         <div class="input-group" style="margin-bottom:0">
		             <label style="font-size:10px; color:var(--text-muted)">T√™n ti·∫øn tr√¨nh:</label>
		             <input type="text" id="proc_name" spellcheck="false" placeholder="T√™n ti·∫øn tr√¨nh..." style="padding-left:12px!important">
		         </div>
		         <div class="input-group" style="margin-bottom:0">
		            <label style="font-size:10px; color:var(--text-muted)">K·ªπ thu·∫≠t ph·ª• tr√°ch:</label>
		            <select id="proc_tech" style="padding-left:12px!important"><option value="">-- Ch·ªçn k·ªπ thu·∫≠t --</option></select>
		         </div>
		    </div>
		    
		    <textarea id="proc_content" spellcheck="false" placeholder="N·ªôi dung chi ti·∫øt..." style="height:80px; margin-top:10px;"></textarea>
		    <input type="text" id="proc_note" spellcheck="false" placeholder="Ghi ch√∫...">
		    
		    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">

			    <div class="input-group">
				<label style="font-size:10px; color:var(--success); font-weight:bold">Ng√†y ho√†n th√†nh d·ª± ki·∫øn:</label>
				<input type="date" id="proc_end_date_p" style="padding-left:12px!important; border-color: var(--success);">
			    </div>
			    
			    <div class="input-group">
				<label style="font-size:10px; color:var(--success); font-weight:bold">Ng√†y ho√†n th√†nh (ƒê·ªÉ tr·ªëng n·∫øu CH∆ØA xong):</label>
				<input type="date" id="proc_end_date" style="padding-left:12px!important; border-color: var(--success);">
			    </div>
		    
		    </div>

		    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:15px;">
		        <button class="btn-save" onclick="saveProcess()" style="background:#065f46">‚ûï TH√äM</button>
		        <button class="btn-save" id="btnUpdateProc" onclick="updateProcess()"
		                style="background:#1e3a8a; display:none;">üíæ C·∫¨P NH·∫¨T
		        </button>
		        <button class="btn-save" id="btnDeleteProc" onclick="deleteProcess()"
		                style="background:#7f1d1d; display:none;">üóëÔ∏è X√ìA
		        </button>
		        <button class="btn-save" onclick="resetProcessForm()" style="background:#475569">üßπ L√ÄM M·ªöI</button>
		    </div>
		</div>
	</div>
        <input type="text" id="searchProcess" onkeyup="filterProcesses()" spellcheck="false" placeholder="üîç T√¨m ki·∫øm ti·∫øn tr√¨nh..."
               style="border: 1px solid var(--primary); background: rgba(0,210,255,0.05);">

        <div class="table-container">
            <table>
                <thead>
                <tr>
                    <th>B·∫Øt ƒë·∫ßu</th>
                    <th>Ti·∫øn tr√¨nh</th>
                    <th>N·ªôi dung</th>
                    <th>Ghi ch√∫</th>
                    <th>K·ªπ thu·∫≠t</th>
                    <th>D·ª± ki·∫øn</th>
                    <th>Ho√†n th√†nh</th>
                    <th>Tr·∫°ng th√°i</th>
                </tr>
                </thead>
                <tbody id="processTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="meta-tab" class="tab-content">
        <div class="meta-grid">
            <div class="meta-col">
                <h4>KH√ÅCH H√ÄNG</h4>
                <div class="meta-list" id="list-customers"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('customers')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('customers')" style="display:none;">
                        L∆ØU
                    </button>
                </div>
            </div>
            <div class="meta-col">
                <h4>LO·∫†I M√ÅY</h4>
                <div class="meta-list" id="list-machineTypes"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('machineTypes')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('machineTypes')" style="display:none;">
                        L∆ØU
                    </button>
                </div>
            </div>
            <div class="meta-col">
                <h4>K·ª∏ THU·∫¨T</h4>
                <div class="meta-list" id="list-techs"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('techs')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('techs')" style="display:none;">L∆ØU
                    </button>
                </div>
            </div>
            <div class="meta-col">
                <h4>H·ªñ TR·ª¢</h4>
                <div class="meta-list" id="list-supports"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('supports')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('supports')" style="display:none;">
                        L∆ØU
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="user-tab" class="tab-content">
	<button onclick="toggleForm('userFormWrapper', this)" class="btn-save" style="margin-bottom: 10px; background: #334155; width: auto; padding: 8px 15px; width: 100% !important;">
        <i class="fas fa-user-plus"></i> ·∫®N/ HI·ªÜN FORM
   	</button>
   	<div id="userFormWrapper" style="display: none;">
		<div style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px;">
		    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px;">
		        <input type="text" id="u_id" spellcheck="false" placeholder="User ID (T√™n ƒëƒÉng nh·∫≠p)">
		        <input type="text" id="u_name" spellcheck="false" placeholder="H·ªç t√™n">
		        <input type="text" id="u_pass" spellcheck="false" placeholder="M·∫≠t kh·∫©u">
		        <select id="u_role">
		            <option value="VIEWER">VIEWER</option>
		            <option value="EDIT">EDIT</option>
		            <option value="ADMIN">ADMIN</option>
		        </select>
		    </div>


		    <div style="background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid var(--border); overflow: hidden;">
		        <div style="padding: 5px 10px; font-size: 11px; color: var(--primary); font-weight: bold; border-bottom: 1px solid var(--border);">
		            QUY·ªÄN TRUY C·∫¨P (CH·ªàNH KH√ÅCH H√ÄNG)
		        </div>
		        <div id="u_access_checks" style="max-height: 150px; overflow-y: auto; padding: 5px 0;">
		        </div>
		    </div>


		</div>
		<div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap:10px; margin-top:10px;">
		    <button class="btn-save" onclick="addUser()" style="background:#065f46">‚ûï TH√äM</button>
		    <button class="btn-save" id="btnUpdateUser" onclick="updateUser()"
		            style="background:#1e3a8a; display:none;">üíæ C·∫¨P NH·∫¨T
		    </button>
		    
		    <button class="btn-save" id="btnResetPass" onclick="resetUserPassword()"
		            style="background:#ca8a04; display:none;">üîê RESET PASS
		    </button>

		    <button class="btn-save" id="btnDeleteUser" onclick="deleteUser()"
		            style="background:#7f1d1d; display:none;">üóëÔ∏è X√ìA
		    </button>
		    <button class="btn-save" onclick="resetUserForm()" style="background:#475569">üßπ L√ÄM M·ªöI</button>
		</div>
	</div>

        <div class="table-container">
            <table>
                <thead>
                <tr>
                    <th>User ID</th>
                    <th>H·ªç t√™n</th>
                    <th>Quy·ªÅn</th>
                    <th>M·∫≠t kh·∫©u</th>
                    <th>Truy c·∫≠p</th>
                </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>
        <div id="admin-backup-zone">
            <div class="meta-col"
                 style="margin-top: 20px; border: 1px dashed var(--primary); padding: 20px; border-radius: 12px;">
                <h3 style="color: var(--primary); margin-top: 0;"><i class="fas fa-database"></i> QU·∫¢N TR·ªä D·ªÆ LI·ªÜU
                    (BACKUP)</h3>
                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">
                    * L∆∞u √Ω: T·∫£i b·∫£n sao l∆∞u ƒë·ªãnh k·ª≥ ƒë·ªÉ ƒë·ªÅ ph√≤ng m·∫•t m√°t d·ªØ li·ªáu. File kh√¥i ph·ª•c ph·∫£i c√≥ ƒë·ªãnh d·∫°ng .json
                    ƒë∆∞·ª£c xu·∫•t t·ª´ h·ªá th·ªëng.
                </p>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="backupData()" class="btn-edit-mode"
                            style="background: #10b981; color: white; border: none; display: block;">
                        üì• XU·∫§T D·ªÆ LI·ªÜU (BACKUP JSON)
                    </button>

                    <label for="restore-input" class="btn-edit-mode"
                           style="background: #f59e0b; color: white; cursor: pointer; display: inline-block;">
                        üì§ PH·ª§C H·ªíI D·ªÆ LI·ªÜU (RESTORE)
                    </label>
                    <input type="file" id="restore-input" accept=".json" style="display: none;"
                           onchange="restoreData(event)">
                </div>
            </div>
        </div>
    </div>


    <div id="doc-tab" class="tab-content">
    <button onclick="toggleForm('doc-form-container', this)" class="btn-save" style="margin-bottom: 10px; background: #334155; width: auto; padding: 8px 15px; width: 100% !important;">
        <i class="fas fa-file-upload"></i> ·∫®N/ HI·ªÜN FORM
    </button>
        <div id="doc-form-container"
             style="display: none; background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1.5fr; gap:10px;">
                <input type="text" id="doc_name" spellcheck="false" placeholder="T√™n t√†i li·ªáu (VD: HDSD Bi·∫øn t·∫ßn...)">
                <select id="doc_machine_type">
                    <option value="">-- Lo·∫°i m√°y --</option>
                </select>
                <input type="text" id="doc_link" spellcheck="false" placeholder="Link t√†i li·ªáu (Drive, Dropbox...)">
            </div>

            <p style="font-size: 12px; color: var(--primary); margin: 10px 0 5px 0;">Ph√¢n quy·ªÅn xem t√†i li·ªáu (Ch·ªçn kh√°ch
                h√†ng ƒë∆∞·ª£c ph√©p xem - Tr·ªëng = T·∫•t c·∫£):</p>
            <div style="background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid var(--border); overflow: hidden;">
                <div style="display: grid; grid-template-columns: 1fr 80px; background: rgba(255,255,255,0.05); padding: 8px 15px; border-bottom: 1px solid var(--border); font-size: 11px; font-weight: 600; color: var(--text-muted);">
                    <div>T√äN KH√ÅCH H√ÄNG</div>
                    <div style="text-align: center;">CH·ªåN</div>
                </div>
                <div id="doc_customer_checks" style="max-height: 180px; overflow-y: auto; padding: 5px 0;">
                </div>
            </div>

            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:15px;">
                <button class="btn-save" onclick="addDoc()" style="background:#065f46">‚ûï TH√äM</button>
                <button class="btn-save" id="btnUpdateDoc" onclick="updateDoc()"
                        style="background:#1e3a8a; display:none;">üíæ C·∫¨P NH·∫¨T
                </button>
                <button class="btn-save" id="btnDeleteDoc" onclick="deleteDoc()"
                        style="background:#7f1d1d; display:none;">üóëÔ∏è X√ìA
                </button>
                <button class="btn-save" onclick="resetDocForm()" style="background:#475569">üßπ L√ÄM M·ªöI</button>
            </div>
        </div>

        <input type="text" id="searchDoc" onkeyup="filterDocs()" spellcheck="false" placeholder="üîç T√¨m ki·∫øm t√†i li·ªáu..."
               style="border: 1px solid var(--primary); background: rgba(0,210,255,0.05);">

        <div id="doc_groups_container" style="margin-top: 15px;"></div>
    </div>


    <div id="infoModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
        <div class="modal-content">
            <h3 style="color:var(--primary); text-align:center; margin:0 0 20px 0">CHI TI·∫æT üîé</h3>
            <div id="modalBody"></div>
            <button class="btn-save" style="margin-top:25px"
                    onclick="document.getElementById('infoModal').style.display='none'">ƒê√ìNG
            </button>
        </div>
    </div>

    <div id="dateModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
        <div class="modal-content" style="text-align:center">
            <h4 style="margin:0 0 15px 0">CH·ªåN NG√ÄY L√ÄM VI·ªÜC</h4>
            <input type="date" id="hiddenDate" onchange="confirmDate(this.value)">
            <button class="btn-save" onclick="document.getElementById('dateModal').style.display='none'">X√ÅC NH·∫¨N
            </button>
        </div>
    </div>
    
	  <footer class="main-footer">
	    <div class="footer-content">
		<div class="footer-section">
		    <h3 class="footer-logo">üõ†Ô∏è B√ÅO C√ÅO K·ª∏ THU·∫¨T</h3>
		    <p>H·ªá th·ªëng qu·∫£n l√Ω b√°o c√°o k·ªπ thu·∫≠t & th∆∞ vi·ªán t√†i li·ªáu.</p>
		</div>

		<div class="footer-section">
		    <h4>LI√äN K·∫æT</h4>
		    <div class="footer-links">
		        <a href="https://laser.info.vn" target="_blank" rel="noopener noreferrer">Laser.info.vn</a>
		        <a href="https://minhphatcij.com.vn" target="_blank" rel="noopener noreferrer">Minhphatcij.com.vn</a>
		    </div>
		</div>

		<div class="footer-section">
		    <h4>H·ªñ TR·ª¢</h4>
			<p>
			    <a href="tel:0971646403" style="text-decoration: none; color: inherit;">
				üìû 0971.64.64.03
			    </a>
			</p>
		</div>
	    </div>

	    <div class="footer-bottom">
		<p>¬© 2026 B·∫£n quy·ªÅn thu·ªôc b·ªô ph·∫≠n K·ªπ thu·∫≠t</p>
	    </div>
	</footer>  
    
</div>


<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script>
    // --- FIREBASE CONFIG (ORIGINAL) ---
    const firebaseConfig = {
        apiKey: "AIzaSyC-WW6N3ZzmZ8gk_XypHWa3oW6VJMMGloM",
        authDomain: "data-260206.firebaseapp.com",
        projectId: "data-260206",
        storageBucket: "data-260206.firebasestorage.app",
        messagingSenderId: "992766098254",
        appId: "1:992766098254:web:8e9f5d3216541023d03c1f"
    };
    firebase.initializeApp(firebaseConfig);
    // Kh·ªüi t·∫°o Firestore
    const db = firebase.firestore();

    // Ki·ªÉm tra n·∫øu ch∆∞a thi·∫øt l·∫≠p th√¨ m·ªõi thi·∫øt l·∫≠p
    try {
        db.settings({
            experimentalForceLongPolling: true,
            useFetchStreams: false
        });
    } catch (e) {
        console.warn("Firestore settings already configured");
    }

    let AUTH = JSON.parse(localStorage.getItem('tech_auth_v4')) || null;
    let USER_ROLE = "VIEWER";
    window.currentLogs = [];
    window.currentProcesses = []; // L∆∞u tr·ªØ ti·∫øn tr√¨nh

    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        const tab = document.getElementById(tabId);
        if(tab) tab.classList.add('active');
        if(btn) btn.classList.add('active');
        if (tabId === 'data-tab') resetSaveButton();
    }

    document.addEventListener("DOMContentLoaded", () => {
        setInitialDate();
        checkSession();
    });

    function checkSession() {
        const now = new Date().getTime();
        if (AUTH && AUTH.expire && now < AUTH.expire) {
            USER_ROLE = AUTH.role;
            showApp();
            fetchData();
        } else {
            localStorage.removeItem('tech_auth_v4');
            document.getElementById('lock-screen').style.display = 'flex';
        }
    }

    async function unlock() {
        const email = document.getElementById('userInput').value.trim();
        const pass = document.getElementById('passInput').value.trim();

        if (!email || !pass) {
            showToast("Vui l√≤ng nh·∫≠p Email v√† M·∫≠t kh·∫©u", "error");
            return;
        }

        showLoading(true, "ƒêANG X√ÅC TH·ª∞C...");
        try {
            // B∆Ø·ªöC 1: X√°c th·ª±c v·ªõi Firebase Auth
            const userCredential = await firebase.auth().signInWithEmailAndPassword(email, pass);
            const userAuth = userCredential.user;

            // B∆Ø·ªöC 2: L·∫•y Role t·ª´ Firestore d·ª±a tr√™n Document ID
            const userDoc = await db.collection("users").doc(email).get();

            if (userDoc.exists) {
                const userData = userDoc.data();
                USER_ROLE = userData.role;

                AUTH = {
                    user: email,
                    uid: userAuth.uid,
                    role: USER_ROLE,
                    access: userData.access || "ALL",
                    expire: new Date().getTime() + (24 * 60 * 60 * 1000)
                };

                localStorage.setItem('tech_auth_v4', JSON.stringify(AUTH));
                showApp();
                fetchData();
                showToast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!", "success");
            } else {
                await firebase.auth().signOut();
                showToast("T√†i kho·∫£n ch∆∞a c√≥ d·ªØ li·ªáu trong b·∫£ng Users!", "error");
            }
        } catch (e) {
            console.error("L·ªói chi ti·∫øt:", e.code, e.message);
            showToast("Email ho·∫∑c M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!", "error");
        }
        showLoading(false);
    }

    async function signOut() {
        try {
            await firebase.auth().signOut();
            AUTH = null;
            localStorage.removeItem('tech_auth_v4');
            location.reload();
        } catch (e) {
            console.error("L·ªói ƒëƒÉng xu·∫•t:", e);
            showToast("Kh√¥ng th·ªÉ ƒëƒÉng xu·∫•t, vui l√≤ng th·ª≠ l·∫°i", "error");
        }
    }


    function handlePresetChange(el) {
        const preset = el.value;
        const parent = el.closest('.inner-filter-box');
        const customGroup = parent.querySelectorAll('.customDateGroup'); 
        const now = new Date();

        let from = '', to = '';

        if (preset === 'today') {
            from = to = now.toISOString().split('T')[0];
        } else if (preset === '7days') {
            const d = new Date();
            d.setDate(d.getDate() - 7);
            from = d.toISOString().split('T')[0];
        } else if (preset === 'thisMonth') {
            from = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        }

        document.querySelectorAll('.timePreset').forEach(s => s.value = preset);
        document.querySelectorAll('.customDateGroup').forEach(g => g.style.display = (preset === 'custom' ? 'flex' : 'none'));
        document.querySelectorAll('.filterFrom').forEach(i => i.value = from);
        document.querySelectorAll('.filterTo').forEach(i => i.value = to);

        syncAndFilter();
    }

    function syncAndFilter(el) {
        if (el) {
            if (el.classList.contains('filterFrom')) document.querySelectorAll('.filterFrom').forEach(i => i.value = el.value);
            if (el.classList.contains('filterTo')) document.querySelectorAll('.filterTo').forEach(i => i.value = el.value);
            if (el.classList.contains('filterCust')) document.querySelectorAll('.filterCust').forEach(i => i.value = el.value);
        }

        const fromElement = document.querySelector('.filterFrom');
        const from = fromElement ? fromElement.value : '';
        const toElement = document.querySelector('.filterTo');
        const to = toElement ? toElement.value : '';
        const custElement = document.querySelector('.filterCust');
        const cust = custElement ? custElement.value : 'ALL';

        const filtered = window.rawLogs.filter(row => {
            const date = row[1]; // workDate
            const customer = row[2];
            const mFrom = from ? date >= from : true;
            const mTo = to ? date <= to : true;
            const mCust = cust === "ALL" ? true : customer === cust;
            return mFrom && mTo && mCust;
        });

        renderData({logs: [["Header"], ...filtered], role: AUTH.role});
        updateDashboard(filtered);
    }


    window.rawLogs = []; // Bi·∫øn l∆∞u d·ªØ li·ªáu g·ªëc

    function fetchData() {
        if (!AUTH) return;
        let query = db.collection("logs");

        // X·ª≠ l√Ω ph√¢n quy·ªÅn cho VIEWER
        if (AUTH.role === "VIEWER") {
            if (AUTH.access && AUTH.access.trim() !== "" && AUTH.access !== "ALL") {
                const allowedList = AUTH.access.split(",").map(s => s.trim()).filter(s => s !== "");
                if (allowedList.length > 0) {
                    query = query.where("customer", "in", allowedList);
                }
            } else if (!AUTH.access || AUTH.access.trim() === "") {
                window.rawLogs = []; 
                renderData({logs: [["Header"]], role: AUTH.role});
                updateDashboard([]);
                return;
            }
        }

        query.orderBy("workDate", "desc").limit(500).onSnapshot((snapshot) => {
            window.rawLogs = snapshot.docs.map(doc => {
                const d = doc.data();
                return [doc.id, d.workDate, d.customer, d.machineType, d.support, d.content, d.tech, d.createdBy || "", d.note || ""];
            });

            const custs = [...new Set(window.rawLogs.map(l => l[2]))].sort();
            document.querySelectorAll('.filterCust').forEach(select => {
                const currentVal = select.value;
                select.innerHTML = '<option value="ALL">T·∫•t c·∫£ kh√°ch h√†ng</option>' +
                    custs.map(c => `<option value="${c}">${c}</option>`).join('');
                select.value = currentVal;
            });

            // G·ªåI H√ÄM N√ÄY ƒê·ªÇ K√çCH HO·∫†T B·ªò L·ªåC M·∫∂C ƒê·ªäNH
            initDefaultFilters(); 
        }, (error) => {
            console.error("L·ªói m√°y ch·ªß:", error);
        });

        if (AUTH.role === "ADMIN" || AUTH.role === "EDIT") {
            db.collection("metadata").doc("dropdowns").onSnapshot((doc) => {
                if (doc.exists) {
                    const d = doc.data();
                    updateDropdowns(d);
                    renderMetaBlock(d);
                }
            });
        }
    }

    // --- H√ÄM THI·∫æT L·∫¨P M·∫∂C ƒê·ªäNH 7 NG√ÄY ---
    function initDefaultFilters() {
        // Ch·ªâ ch·∫°y 1 l·∫ßn n·∫øu input date ch∆∞a c√≥ gi√° tr·ªã
        const fromInput = document.querySelector('.filterFrom');
        if(!fromInput.value) {
             const d = new Date();
             d.setDate(d.getDate() - 7);
             const sevenDaysAgo = d.toISOString().split('T')[0];
             
             // G√°n gi√° tr·ªã
             document.querySelectorAll('.timePreset').forEach(s => s.value = '7days');
             document.querySelectorAll('.filterFrom').forEach(i => i.value = sevenDaysAgo);
             document.querySelectorAll('.filterTo').forEach(i => i.value = new Date().toISOString().split('T')[0]);
        }
        syncAndFilter();
    }


    // --- UI RENDER ---
    function renderData(data) {
        window.currentLogs = data.logs.slice(1);
        const html = window.currentLogs.map((row, index) => `
            <tr onclick="openInfoModal(${index})">
                <td style="color:var(--text-muted)">${formatVN(row[1])}</td>
                <td><b style="color:var(--primary)">${row[2] || ''}</b></td>
                <td style="font-size:11px"><span class="badge-mec">${row[3] || ''}</span></td>
                <td><small>${row[4] || ''}</small></td>
                <td style="color:#cbd5e1">${(row[5] || "").substring(0, 30)}${(row[5] || "").length > 30 ? '...' : ''}</td>
                <td><span class="badge-tech">${row[6] || ''}</span></td>
                <td style="font-style:italic; color:var(--text-muted); font-size:12px">
                    ${(row[8] || '').substring(0, 15)}${(row[8] || '').length > 15 ? '...' : ''}</td>
                
            </tr>
        `).join('');
        document.getElementById('tableBody').innerHTML = html;
        document.getElementById('syncStatus').innerText = "ƒê·ªìng b·ªô: " + new Date().toLocaleTimeString();
    }

    function updateDropdowns(d) {
        // Ch·ªâ ch·∫°y cho Admin/Edit
        const update = (id, list, txt) => {
            const select = document.getElementById(id);
            if(!select) return; 
            const val = select.value;
            select.innerHTML = `<option value="">-- ${txt} --</option>` + list.map(i => `<option value="${i}">${i}</option>`).join('');
            select.value = val;
        };
        if (d.customers) update('customer', d.customers, 'Kh√°ch h√†ng');
        if (d.techs) {
            update('techName', d.techs, 'K·ªπ thu·∫≠t');
            // Update cho c·∫£ tab Ti·∫øn tr√¨nh m·ªõi
            update('proc_tech', d.techs, 'Ch·ªçn k·ªπ thu·∫≠t');
        }
        if (d.machineTypes) update('machineType', d.machineTypes, 'Lo·∫°i m√°y');
        if (d.supports) update('supportType', d.supports, 'H·ªó tr·ª£');
        
        if(d.machineTypes) {
             const docMachineSelect = document.getElementById('doc_machine_type');
             if(docMachineSelect) {
                 const currentVal = docMachineSelect.value;
                 docMachineSelect.innerHTML = '<option value="">-- Lo·∫°i m√°y --</option>' + 
                     d.machineTypes.map(m => `<option value="${m}">${m}</option>`).join('');
                 docMachineSelect.value = currentVal;
             }
        }
        
        if(d.customers) {
            loadCustomerCheckboxes(d.customers); 
            loadUserAccessCheckboxes(d.customers);
        }
    }

    // --- POPUP CHI TI·∫æT ---
    function openInfoModal(index) {
        const row = window.currentLogs[index];
        const isAdmin = (AUTH && AUTH.role === "ADMIN"); 
        
        let modalHtml = `
            <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; border:1px solid var(--border)">
                <div class="detail-grid">
                    <div class="detail-item"><span class="detail-label">üóìÔ∏è Ng√†y l√†m:</span><span class="detail-value">${formatVN(row[1])}</span></div>
                    <div class="detail-item"><span class="detail-label">üïµÔ∏è‚Äç‚ôÇÔ∏è Kh√°ch:</span><span class="detail-value">${row[2]}</span></div>
                    <div class="detail-item"><span class="detail-label">‚öôÔ∏è Lo·∫°i m√°y:</span><span class="detail-value">${row[3] || '---'}</span></div>
                    <div class="detail-item"><span class="detail-label">üìå H·ªó tr·ª£:</span><span class="detail-value">${row[4] || '---'}</span></div>
                    <div class="detail-item"><span class="detail-label">üë∑‚Äç‚ôÇÔ∏è K·ªπ thu·∫≠t:</span><span class="detail-value">${row[6]}</span></div>
                    <div class="detail-item"><span class="detail-label">ü™™ User:</span><span class="detail-value">${row[7] || '---'}</span></div>
                </div>
                <div style="margin-top:10px; border-top:1px solid var(--border); padding-top:10px">
                    <p style="margin:0 0 5px 0; color:var(--text-muted); font-size:11px; font-weight:600">üìù N·ªòI DUNG:</p>
                    <div style="white-space:pre-wrap; color:#fff; background:rgba(0,0,0,0.3); padding:12px; border-radius:10px; font-size:14px;">${row[5]}</div>
                </div>
                <div style="margin-top:10px">
                    <p style="margin:0 0 5px 0; color:var(--text-muted); font-size:11px; font-weight:600">üóíÔ∏è GHI CH√ö:</p>
                    <div style="color:var(--primary); font-style:italic; font-size:13px">${row[8] || 'Kh√¥ng c√≥ ghi ch√∫.'}</div>
                </div>
            </div>
        `;
        if (isAdmin) {
            modalHtml += `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px">
                <button onclick="deleteLog('${row[0]}')" style="background:#450a0a; color:#f87171; border:1px solid #7f1d1d; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold">üóëÔ∏è X√ìA</button>
                <button onclick="editLog(${index})" style="background:#1e1b4b; color:#818cf8; border:1px solid #312e81; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold">‚úèÔ∏è S·ª¨A</button>
            </div>`;
        }
        document.getElementById('modalBody').innerHTML = modalHtml;
        document.getElementById('infoModal').style.display = 'flex';
    }

    // --- TAB 3 LOGIC ---
    function renderMetaBlock(data) {
        const renderCol = (id, list) => {
            const container = document.getElementById('list-' + id);
            if(!container) return;
            const fullList = [...(list || []), "", "", ""]; 
            container.innerHTML = fullList.map(v => `<div class="meta-item"><input type="text" value="${v}" readonly></div>`).join('');
        };
        renderCol('customers', data.customers);
        renderCol('machineTypes', data.machineTypes);
        renderCol('techs', data.techs);
        renderCol('supports', data.supports);
    }


    function enableMetaEdit(id) {
        document.querySelectorAll(`#list-${id} .meta-item`).forEach(item => {
            item.classList.add('editing');
            const input = item.querySelector('input');
            if (input) input.readOnly = false;
        });

        const parentCol = document.getElementById(`list-${id}`).closest('.meta-col');
        const btnEdit = parentCol.querySelector('.btn-edit-mode');
        const btnSave = parentCol.querySelector('.btn-save-mode');

        if (btnEdit) btnEdit.style.display = 'none';
        if (btnSave) btnSave.style.display = 'block';

        showToast("ƒê√£ m·ªü ch·∫ø ƒë·ªô s·ª≠a!", "info");
    }

    async function saveMetaData(id) {
        const inputs = document.querySelectorAll(`#list-${id} input`);
        const newList = [...new Set(Array.from(inputs).map(i => i.value.trim()).filter(v => v !== ""))];

        showLoading(true, "ƒêANG L∆ØU...");

        try {
            await db.collection("metadata").doc("dropdowns").set({
                [id]: newList
            }, {merge: true});

            document.querySelectorAll(`#list-${id} .meta-item`).forEach(item => {
                item.classList.remove('editing');
                const input = item.querySelector('input');
                if (input) input.readOnly = true;
            });

            const parentCol = document.getElementById(`list-${id}`).closest('.meta-col');
            const btnEdit = parentCol.querySelector('.btn-edit-mode');
            const btnSave = parentCol.querySelector('.btn-save-mode');

            if (btnSave) btnSave.style.display = 'none';
            if (btnEdit) btnEdit.style.display = 'block';

            showToast("ƒê√£ l∆∞u th√†nh c√¥ng!", "success");

        } catch (e) {
            console.error("L·ªói c·∫≠p nh·∫≠t Firestore:", e);
            showToast("L·ªói: " + e.message, "error");
        } finally {
            showLoading(false);
        }
    }

    // --- OTHER LOGIC ---
    async function saveData() {
        const d = document.getElementById('hiddenDate').value;
        const c = document.getElementById('customer').value;
        const n = document.getElementById('content').value.trim();

        if (!c || !n) return showToast("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin!", "error");

        showLoading(true, "ƒêANG L∆ØU...");
        try {
            await db.collection("logs").add({
                workDate: d,
                customer: c,
                tech: document.getElementById('techName').value,
                machineType: document.getElementById('machineType').value,
                support: document.getElementById('supportType').value,
                content: n,
                note: document.getElementById('note').value.trim(),
                createdBy: AUTH.user, 
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            showToast("ƒê√£ l∆∞u b√°o c√°o!", "success");
            resetSaveButton();
            switchTab('dashboard', document.querySelector('.tab-btn'));
        } catch (e) {
            console.error("L·ªói chi ti·∫øt:", e); 
            showToast("L·ªói khi l∆∞u! " + e.message, "error");
        }
        showLoading(false);
    }

    function deleteLog(id) {
        const confirmHtml = `
        <div style="min-width: 200px;">
            <p style="margin: 0 0 12px 0; font-weight: 600;">üóëÔ∏è X√ìA B√ÅO C√ÅO N√ÄY?</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button id="logNo" style="background: #475569; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">KH√îNG</button>
                <button id="logYes" style="background: #7f1d1d; color: #f87171; border: 1px solid #7f1d1d; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">X√ìA</button>
            </div>
        </div>
    `;

        const t = showToast("", "error", confirmHtml);

        t.querySelector('#logNo').onclick = () => t.remove();

        t.querySelector('#logYes').onclick = async () => {
            t.remove();
            showLoading(true, "ƒêANG X√ìA...");
            await db.collection("logs").doc(id).delete();
            document.getElementById('infoModal').style.display = 'none';
            showLoading(false);
            showToast("ƒê√£ x√≥a xong!", "success");
        };
    }

    function editLog(index) {
        const row = window.currentLogs[index];
        document.getElementById('infoModal').style.display = 'none';
        switchTab('form-tab', document.getElementById('btnTabForm'));
        document.getElementById('hiddenDate').value = row[1];
        document.getElementById('workDateDisplay').value = formatVN(row[1]);
        
        document.getElementById('customer').value = row[2];
        document.getElementById('machineType').value = row[3];
        document.getElementById('supportType').value = row[4];
        document.getElementById('content').value = row[5];
        document.getElementById('techName').value = row[6];
        document.getElementById('note').value = row[8] || "";
        
        const btn = document.getElementById('btnSave');
        btn.innerHTML = "üíæ C·∫¨P NH·∫¨T";
        btn.onclick = async () => {
            showLoading(true);
            await db.collection("logs").doc(row[0]).update({
                workDate: document.getElementById('hiddenDate').value,
                customer: document.getElementById('customer').value,
                content: document.getElementById('content').value.trim(),
                note: document.getElementById('note').value.trim(),
                tech: document.getElementById('techName').value,
                machineType: document.getElementById('machineType').value,
                support: document.getElementById('supportType').value
            });
            showLoading(false);
            resetSaveButton();
            switchTab('dashboard', document.querySelector('.tab-btn'));
        };
    }

    function resetSaveButton() {
        const btn = document.getElementById('btnSave');
        if(btn) {
            btn.innerHTML = "L∆ØU B√ÅO C√ÅO";
            btn.onclick = saveData;
        }
        const content = document.getElementById('content');
        const note = document.getElementById('note');
        if(content) content.value = '';
        if(note) note.value = '';
    }


    function showApp() {
        document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';

        if (AUTH && AUTH.user) {
            const helloEl = document.getElementById('helloUser');
            if (helloEl) helloEl.innerText = "Ch√†o, " + AUTH.user;
        }

        const nav = document.querySelector('.tab-navigation');
        if(nav) nav.style.display = 'flex'; 

        // √ÅP D·ª§NG PH√ÇN QUY·ªÄN V√Ä X√ìA CODE TH·ª™A
        applyPermissions();
    }
    
    // --- H√ÄM QUAN TR·ªåNG: PH√ÇN QUY·ªÄN V√Ä X√ìA HTML ---
    function applyPermissions() {
        const role = AUTH.role;
        
        // C√ÅC TH√ÄNH PH·∫¶N C·∫¶N X√ìA CHO C·∫¢ VIEWER V√Ä EDIT
        let idsToRemove = [];

        if (role === "VIEWER") {
            idsToRemove = [
                'form-tab',       // Tab B√°o c√°o
                'process-tab',    // Tab Ti·∫øn tr√¨nh (NEW)
                'meta-tab',       // Tab C·∫•u h√¨nh
                'user-tab',       // Tab Th√†nh vi√™n
                'btnTabForm',     // N√∫t tab B√°o c√°o
                'btnTabProcess',  // N√∫t tab Ti·∫øn tr√¨nh (NEW)
                'btnTabMeta',     // N√∫t tab C·∫•u h√¨nh
                'btnTabUser',     // N√∫t tab Th√†nh vi√™n
                'doc-form-container', // Form nh·∫≠p li·ªáu ·ªü Tab T√†i li·ªáu
                'admin-backup-zone', // Khu v·ª±c backup
                'dash-progress-container' // Thanh ti·∫øn tr√¨nh ·ªü Dashboard
            ];
             // Viewer v·∫´n xem ƒë∆∞·ª£c doc n·∫øu c√≥ access
            if (AUTH.access && AUTH.access !== "") {
                 const docBtn = document.getElementById('btnTabDoc');
                 if(docBtn) docBtn.style.display = 'block';
                 fetchDocs(); 
            }

        } else if (role === "EDIT") {
            // EDIT: ƒê∆∞·ª£c d√πng Form, nh∆∞ng KH√îNG ƒë∆∞·ª£c d√πng Meta, User
            // EDIT: Kh√¥ng ƒë∆∞·ª£c d√πng Ti·∫øn tr√¨nh
            idsToRemove = [
                'process-tab',    // Tab Ti·∫øn tr√¨nh (NEW)
                'meta-tab',       // Tab C·∫•u h√¨nh
                'user-tab',       // Tab Th√†nh vi√™n
                'btnTabProcess',  // N√∫t tab Ti·∫øn tr√¨nh (NEW)
                'btnTabMeta',     // N√∫t tab C·∫•u h√¨nh
                'btnTabUser',     // N√∫t tab Th√†nh vi√™n
                'doc-form-container', // Form nh·∫≠p li·ªáu t√†i li·ªáu (Ch·ªâ xem)
                'admin-backup-zone', // Khu v·ª±c backup
                'dash-progress-container' // Thanh ti·∫øn tr√¨nh ·ªü Dashboard
            ];
            
            // EDIT ƒë∆∞·ª£c xem t·∫•t c·∫£ t√†i li·ªáu
            const docBtn = document.getElementById('btnTabDoc');
            if(docBtn) docBtn.style.display = 'block';
            fetchDocs(); 
        } else if (role === "ADMIN") {
            // ADMIN: Gi·ªØ nguy√™n, load th√™m user v√† TI·∫æN TR√åNH
            fetchUsers();
            fetchDocs();
            fetchProcesses(); // (NEW)
            document.getElementById('dash-progress-container').style.display = 'block';
        }

        // X√≥a DOM
        idsToRemove.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.remove(); 
        });
    }


    function setInitialDate() {
        const iso = new Date().toISOString().split('T')[0];
        document.getElementById('hiddenDate').value = iso;
        document.getElementById('workDateDisplay').value = formatVN(iso);
        // Set cho form ti·∫øn tr√¨nh m·ªõi
        const pStart = document.getElementById('proc_start_date');
        if(pStart) pStart.value = iso;
    }

    function confirmDate(v) {
        document.getElementById('workDateDisplay').value = formatVN(v);
        document.getElementById('dateModal').style.display = 'none';
    }

    function formatVN(s) {
        if (!s) return '';
        const d = new Date(s);
        return d.getDate().toString().padStart(2, '0') + '/' + (d.getMonth() + 1).toString().padStart(2, '0') + '/' + d.getFullYear();
    }

    function filterTable() {
        const v = document.getElementById('searchBox').value.toUpperCase();
        const rows = document.getElementById('tableBody').getElementsByTagName('tr');
        for (let r of rows) r.style.display = r.innerText.toUpperCase().includes(v) ? "" : "none";
    }

    function showLoading(s, t) {
        document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none';
        if (t) document.getElementById('loading-text').innerText = t;
    }

    function showToast(m, type, htmlContent = "") {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.style.pointerEvents = "auto";

        if (htmlContent) {
            t.innerHTML = htmlContent;
        } else {
            t.innerText = m;
        }

        c.appendChild(t);

        if (!htmlContent) {
            setTimeout(() => t.remove(), 2500);
        }
        return t;
    }

    // --- LOGIC QU·∫¢N L√ù TI·∫æN TR√åNH (NEW FUNCTIONALITY) ---
    
    let selectedProcessId = null;

    function fetchProcesses() {
        // Ch·ªâ Admin m·ªõi g·ªçi h√†m n√†y (ƒë√£ check ·ªü applyPermissions)
        db.collection("processes").orderBy("startDate", "desc").onSnapshot(snapshot => {
            window.currentProcesses = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            renderProcesses(window.currentProcesses);
            updateProgressBar();
        });
    }

    function renderProcesses(list) {
        const tbody = document.getElementById('processTableBody');
        if(!tbody) return;

        const html = list.map(p => {
            const isCompleted = p.endDate && p.endDate.trim() !== "";
            const statusBadge = isCompleted 
                ? `<span style="background:#065f46; color:#6ee7b7; padding:4px 8px; border-radius:6px; font-size:10px; font-weight:bold;">HO√ÄN TH√ÄNH</span>`
                : `<span style="background:#78350f; color:#fcd34d; padding:4px 8px; border-radius:6px; font-size:10px; font-weight:bold;">ƒêANG X·ª¨ L√ù</span>`;

            return `
            <tr onclick="openProcessModal('${p.id}')">
                <td style="color:var(--text-muted); font-size:12px">${formatVN(p.startDate)}</td>
                <td style="font-weight:600; color:var(--primary)">${p.name}</td>
                <td style="color:#cbd5e1">${(p.content || "").substring(0, 30)}${(p.content || "").length > 30 ? '...' : ''}</td>
                <td style="font-style:italic; font-size:12px; color:var(--text-muted)">${p.note || ""}</td>
                <td><span class="badge-tech">${p.tech || ""}</span></td>
                <td style="font-size:12px">${p.endDateP ? formatVN(p.endDateP) : '---'}</td>
                <td style="font-size:12px">${p.endDate ? formatVN(p.endDate) : '---'}</td>
                <td>${statusBadge}</td>
            </tr>
            `;
        }).join('');
        tbody.innerHTML = html;
    }
    // H√ÄM M·ªöI: M·ªü modal chi ti·∫øt ti·∫øn tr√¨nh
    function openProcessModal(id) {
        const p = window.currentProcesses.find(item => item.id === id);
        if(!p) return;
        selectedProcessId = id; // L∆∞u ID ƒë·ªÉ d√πng cho x√≥a/s·ª≠a

        const isCompleted = p.endDate && p.endDate.trim() !== "";
        const statusText = isCompleted ? "HO√ÄN TH√ÄNH" : "ƒêANG X·ª¨ L√ù";
        const statusColor = isCompleted ? "#10b981" : "#f59e0b";

        let modalHtml = `
            <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; border:1px solid var(--border)">
                <div class="detail-grid">
                    <div class="detail-item"><span class="detail-label">üóìÔ∏è B·∫Øt ƒë·∫ßu:</span><span class="detail-value">${formatVN(p.startDate)}</span></div>
                    <div class="detail-item"><span class="detail-label">üöÄ Ti·∫øn tr√¨nh:</span><span class="detail-value">${p.name}</span></div>
                    <div class="detail-item"><span class="detail-label">üë∑‚Äç‚ôÇÔ∏è K·ªπ thu·∫≠t:</span><span class="detail-value">${p.tech || '---'}</span></div>
                    <div class="detail-item"><span class="detail-label">üìä Tr·∫°ng th√°i:</span><span class="detail-value" style="color:${statusColor}">${statusText}</span></div>
                    <div class="detail-item"><span class="detail-label">‚è± D·ª± ki·∫øn:</span><span class="detail-value">${p.endDateP ? formatVN(p.endDateP) : '---'}</span></div>
                    <div class="detail-item"><span class="detail-label">üèÅ Ho√†n th√†nh:</span><span class="detail-value">${p.endDate ? formatVN(p.endDate) : '---'}</span></div>
                    <div class="detail-item"><span class="detail-label">ü™™ User:</span><span class="detail-value">${p.createdBy}</span></div>
                </div>
                <div style="margin-top:10px; border-top:1px solid var(--border); padding-top:10px">
                    <p style="margin:0 0 5px 0; color:var(--text-muted); font-size:11px; font-weight:600">üìù N·ªòI DUNG:</p>
                    <div style="white-space:pre-wrap; color:#fff; background:rgba(0,0,0,0.3); padding:12px; border-radius:10px; font-size:14px;">${p.content || ""}</div>
                </div>
                <div style="margin-top:10px">
                    <p style="margin:0 0 5px 0; color:var(--text-muted); font-size:11px; font-weight:600">üóíÔ∏è GHI CH√ö:</p>
                    <div style="color:var(--primary); font-style:italic; font-size:13px">${p.note || 'Kh√¥ng c√≥ ghi ch√∫.'}</div>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px">
                <button onclick="triggerProcessDelete()" style="background:#450a0a; color:#f87171; border:1px solid #7f1d1d; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold">üóëÔ∏è X√ìA</button>
                <button onclick="triggerProcessEdit()" style="background:#1e1b4b; color:#818cf8; border:1px solid #312e81; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold">‚úèÔ∏è S·ª¨A</button>
            </div>
        `;

        document.getElementById('modalBody').innerHTML = modalHtml;
        document.getElementById('infoModal').style.display = 'flex';
    }

    // H√ÄM M·ªöI: X·ª≠ l√Ω khi nh·∫•n n√∫t S·ª¨A t·ª´ Modal
    function triggerProcessEdit() {
        document.getElementById('infoModal').style.display = 'none';
        loadProcessToForm(selectedProcessId);
        // Scroll l√™n form nh·∫≠p li·ªáu
        document.getElementById('proc_name').focus();
        toggleForm('proc-progress-container-form', this)
        showToast("M·ªü tr√¨nh s·ª≠a!", "success");
    }
    
    // H√ÄM M·ªöI: X·ª≠ l√Ω khi nh·∫•n n√∫t X√ìA t·ª´ Modal
    function triggerProcessDelete() {
        // ƒê√≥ng modal chi ti·∫øt tr∆∞·ªõc khi hi·ªán modal x√°c nh·∫≠n x√≥a
        document.getElementById('infoModal').style.display = 'none';
        deleteProcess(); // G·ªçi h√†m x√≥a c≈©
    }

    function loadProcessToForm(id) {
        const p = window.currentProcesses.find(item => item.id === id);
        if(!p) return;
        
        selectedProcessId = id;
        document.getElementById('proc_start_date').value = p.startDate;
        document.getElementById('proc_name').value = p.name;
        document.getElementById('proc_tech').value = p.tech || "";
        document.getElementById('proc_content').value = p.content || "";
        document.getElementById('proc_note').value = p.note || "";
        document.getElementById('proc_end_date_p').value = p.endDate || "";
        document.getElementById('proc_end_date').value = p.endDate || "";
        // document.getElementById('created_by').value = p.createdBy || "";

        document.getElementById('btnUpdateProc').style.display = 'block';
        document.getElementById('btnDeleteProc').style.display = 'block';
    }

    async function saveProcess() {
        const start = document.getElementById('proc_start_date').value;
        const name = document.getElementById('proc_name').value.trim();
        const tech = document.getElementById('proc_tech').value;
        const content = document.getElementById('proc_content').value.trim();
        
        if(!start || !name || !content) return showToast("Vui l√≤ng nh·∫≠p Ng√†y, T√™n v√† N·ªôi dung!", "error");

        const data = {
            startDate: start,
            name: name,
            tech: tech,
            content: content,
            note: document.getElementById('proc_note').value.trim(),
            endDateP: document.getElementById('proc_end_date_p').value, // R·ªóng nghƒ©a l√† ch∆∞a xong
            endDate: document.getElementById('proc_end_date').value, // R·ªóng nghƒ©a l√† ch∆∞a xong
            createdBy: AUTH.user, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        showLoading(true, "ƒêANG TH√äM TI·∫æN TR√åNH...");
        try {
            await db.collection("processes").add(data);
            showToast("Th√™m ti·∫øn tr√¨nh th√†nh c√¥ng!", "success");
            resetProcessForm();
        } catch(e) {
            showToast("L·ªói: " + e.message, "error");
        }
        showLoading(false);
    }

    async function updateProcess() {
        if(!selectedProcessId) return;
        const data = {
            startDate: document.getElementById('proc_start_date').value,
            name: document.getElementById('proc_name').value.trim(),
            tech: document.getElementById('proc_tech').value,
            content: document.getElementById('proc_content').value.trim(),
            note: document.getElementById('proc_note').value.trim(),
            endDateP: document.getElementById('proc_end_date_p').value,
            endDate: document.getElementById('proc_end_date').value
        };

        showLoading(true, "ƒêANG C·∫¨P NH·∫¨T...");
        try {
            await db.collection("processes").doc(selectedProcessId).update(data);
            showToast("C·∫≠p nh·∫≠t th√†nh c√¥ng!", "success");
            resetProcessForm();
        } catch(e) {
             showToast("L·ªói: " + e.message, "error");
        }
        showLoading(false);
    }

    async function deleteProcess() {
        if(!selectedProcessId) return;
        
        const confirmHtml = `
            <div style="min-width: 200px;">
                <p style="margin: 0 0 12px 0; font-weight: 600;">‚ö†Ô∏è X√ìA TI·∫æN TR√åNH N√ÄY?</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button id="pNo" style="background: #475569; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer;">H·ª¶Y</button>
                    <button id="pYes" style="background: #ef4444; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer;">X√ìA NGAY</button>
                </div>
            </div>`;
        
        const t = showToast("", "info", confirmHtml);
        t.querySelector('#pNo').onclick = () => t.remove();
        t.querySelector('#pYes').onclick = async () => {
            t.remove();
            showLoading(true, "ƒêANG X√ìA...");
            try {
                await db.collection("processes").doc(selectedProcessId).delete();
                showToast("ƒê√£ x√≥a!", "success");
                resetProcessForm();
            } catch(e) {
                showToast("L·ªói: " + e.message, "error");
            }
            showLoading(false);
        };
    }

    function resetProcessForm() {
        selectedProcessId = null;
        document.getElementById('proc_name').value = "";
        document.getElementById('proc_content').value = "";
        document.getElementById('proc_note').value = "";
        document.getElementById('proc_end_date_p').value = "";
        document.getElementById('proc_end_date').value = "";
        document.getElementById('proc_tech').value = "";
        
        // Reset ng√†y b·∫Øt ƒë·∫ßu v·ªÅ h√¥m nay
        const iso = new Date().toISOString().split('T')[0];
        document.getElementById('proc_start_date').value = iso;

        document.getElementById('btnUpdateProc').style.display = 'none';
        document.getElementById('btnDeleteProc').style.display = 'none';
    }

    function filterProcesses() {
        const val = document.getElementById('searchProcess').value.toUpperCase();
        const rows = document.getElementById('processTableBody').getElementsByTagName('tr');
        for (let r of rows) r.style.display = r.innerText.toUpperCase().includes(val) ? "" : "none";
    }

    function updateProgressBar() {
        const total = window.currentProcesses.length;
        if(total === 0) return;

        const done = window.currentProcesses.filter(p => p.endDate && p.endDate.trim() !== "").length;
        const percent = Math.round((done / total) * 100);
        const pending = total - done;

        // C·∫≠p nh·∫≠t UI ·ªü 2 n∆°i: Dashboard v√† Tab Ti·∫øn tr√¨nh
        const updateUI = (prefix) => {
            const fill = document.getElementById(prefix + 'progress-fill');
            const text = document.getElementById(prefix + 'progress-text');
            const elTotal = document.getElementById(prefix + 'total');
            const elDone = document.getElementById(prefix + 'done');
            const elPending = document.getElementById(prefix + 'pending');

            if(fill) {
                fill.style.width = percent + '%';
                fill.innerText = percent + '%';
            }
            if(text) text.innerText = percent + "% Ho√†n th√†nh";
            if(elTotal) elTotal.innerText = total;
            if(elDone) elDone.innerText = done;
            if(elPending) elPending.innerText = pending;
        };

        updateUI('dash-');
        updateUI('proc-');
    }

    // --- LOGIC QU·∫¢N L√ù T√ÄI KHO·∫¢N (TAB 4) ---

    // 1. T·ª± ƒë·ªông l·∫•y danh s√°ch user khi tab m·ªü
    function fetchUsers() {
        // Double check: N·∫øu kh√¥ng ph·∫£i ADMIN th√¨ return
        if (AUTH.role !== "ADMIN") return; 
        
        db.collection("users").onSnapshot((snapshot) => {
            const html = snapshot.docs.map(doc => {
                const u = doc.data();
                return `
                <tr onclick="loadUserToForm('${doc.id}', '${u.name}', '${u.role}', '${u.access || ""}')">
                    <td><b style="color:var(--primary)">${doc.id}</b></td>
                    <td>${u.name}</td>
                    <td><span class="badge-tech">${u.role}</span></td>
                    <td>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                    <td style="font-size:11px; color:var(--text-muted)">${u.access || 'ALL'}</td>
                </tr>
            `;
            }).join('');
            const tbody = document.getElementById('userTableBody');
            if(tbody) tbody.innerHTML = html;
        });
    }

    // 2. Load d·ªØ li·ªáu t·ª´ b·∫£ng l√™n form khi k√≠ch v√†o d√≤ng
    // ƒê√£ b·ªè load pass, pass lu√¥n l√† r·ªóng ho·∫∑c ******
    function loadUserToForm(id, name, role, access) {
        document.getElementById('u_id').value = id;
        document.getElementById('u_id').readOnly = true;
        document.getElementById('u_name').value = name;
        document.getElementById('u_role').value = role;
        
        // M·∫≠t kh·∫©u kh√¥ng hi·ªÉn th·ªã, v√† ƒë·ªÉ readOnly
        const passInput = document.getElementById('u_pass');
        passInput.value = "******";
        passInput.readOnly = true;

        // X·ª≠ l√Ω Checkbox quy·ªÅn truy c·∫≠p
        const allowedList = (access || "").split(",").map(s => s.trim());
        const checks = document.querySelectorAll('input[name="user_cust"]');
        checks.forEach(ch => {
            ch.checked = allowedList.includes(ch.value);
        });
        document.getElementById('btnUpdateUser').style.display = 'block';
        document.getElementById('btnDeleteUser').style.display = 'block';
        document.getElementById('btnResetPass').style.display = 'block';
        toggleForm('userFormWrapper', this);
        showToast("ƒê√£ ch·ªçn user: " + id, "info");
    }

    // 3. Th√™m User m·ªõi
    async function addUser() {
        const id = document.getElementById('u_id').value.trim(); // ƒê√¢y ch√≠nh l√† Email
        const pass = document.getElementById('u_pass').value.trim();

        if (!id) return showToast("Vui l√≤ng nh·∫≠p Email l√†m User ID", "error");
        if (pass.length < 6) return showToast("M·∫≠t kh·∫©u ph·∫£i t·ª´ 6 k√Ω t·ª± tr·ªü l√™n", "error");

        const selectedAccess = Array.from(document.querySelectorAll('input[name="user_cust"]:checked'))
            .map(cb => cb.value)
            .join(', ') || "ALL"; // N·∫øu v·∫ø tr√°i r·ªóng, l·∫•y "ALL"

        showLoading(true, "ƒêANG T·∫†O T√ÄI KHO·∫¢N...");

        try {
            const secondaryApp = firebase.initializeApp(firebaseConfig, "SecondaryContext");
            try {
                await secondaryApp.auth().createUserWithEmailAndPassword(id, pass);
            } catch (authError) {
                if (authError.code === 'auth/email-already-in-use') {
                    throw new Error("Email n√†y ƒë√£ ƒë∆∞·ª£c t·∫°o t√†i kho·∫£n ƒëƒÉng nh·∫≠p r·ªìi!");
                }
                throw authError;
            }

            await db.collection("users").doc(id).set({
                name: document.getElementById('u_name').value,
                role: document.getElementById('u_role').value,
                access: selectedAccess
                // KH√îNG L∆ØU PASS V√ÄO FIRESTORE N·ªÆA
            });

            await secondaryApp.delete();

            showToast("ƒê√£ t·∫°o t√†i kho·∫£n th√†nh c√¥ng!", "success");
            resetUserForm();

        } catch (e) {
            showToast("L·ªói: " + e.message, "error");
        } finally {
            showLoading(false);
        }
    }

    // 4. C·∫≠p nh·∫≠t User (Ch·ªâ c·∫≠p nh·∫≠t info, kh√¥ng pass)
    async function updateUser() {
        const id = document.getElementById('u_id').value.trim();
        const selectedAccess = Array.from(document.querySelectorAll('input[name="user_cust"]:checked'))
            .map(cb => cb.value)
            .join(', ') || "ALL"; 
        showLoading(true, "ƒêANG C·∫¨P NH·∫¨T...");
        try {
            await db.collection("users").doc(id).update({
                name: document.getElementById('u_name').value,
                role: document.getElementById('u_role').value,
                access: selectedAccess 
            });
            showToast("ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!", "success");
        } catch (e) {
            showToast("L·ªói khi c·∫≠p nh·∫≠t!", "error");
        }
        showLoading(false);
    }
    
    // 6. Reset Password (G·ª≠i email)
    async function resetUserPassword() {
        const email = document.getElementById('u_id').value.trim();
        if(!email) return showToast("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c email user!", "error");
        
        const confirmHtml = `
        <div style="min-width: 250px;">
            <p style="margin: 0 0 10px 0; font-weight: 600; color: #fbbf24;">üîê ƒê·∫∂T L·∫†I M·∫¨T KH·∫®U?</p>
            <p style="font-size:12px; margin-bottom:15px">H·ªá th·ªëng s·∫Ω g·ª≠i email y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ƒë·∫øn: <br><b style="color:white">${email}</b></p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button id="resetNo" style="background: #475569; color: white; border: none; padding: 8px; border-radius: 6px; font-weight: bold;">H·ª¶Y</button>
                <button id="resetYes" style="background: #ca8a04; color: white; border: none; padding: 8px; border-radius: 6px; font-weight: bold;">G·ª¨I EMAIL</button>
            </div>
        </div>
        `;
        
        const t = showToast("", "info", confirmHtml);
        
        t.querySelector('#resetNo').onclick = () => t.remove();
        
        t.querySelector('#resetYes').onclick = async () => {
            t.remove();
            showLoading(true, "ƒêANG G·ª¨I Y√äU C·∫¶U...");
            try {
                await firebase.auth().sendPasswordResetEmail(email);
                showToast("ƒê√£ g·ª≠i email kh√¥i ph·ª•c th√†nh c√¥ng!", "success");
            } catch (e) {
                showToast("L·ªói: " + e.message, "error");
            }
            showLoading(false);
        };
    }

    // 5. X√≥a User
    function deleteUser() {
        const id = document.getElementById('u_id').value.trim();
        if (!id) return showToast("Vui l√≤ng ch·ªçn t√†i kho·∫£n c·∫ßn x√≥a!", "error");

        const confirmHtml = `
        <div style="min-width: 220px;">
            <p style="margin: 0 0 5px 0; font-weight: 600; color: #f87171;">‚ö†Ô∏è X√ìA T√ÄI KHO·∫¢N?</p>
            <p style="margin: 0 0 12px 0; font-size: 13px; color: #cbd5e1;">X√°c nh·∫≠n x√≥a user: <b>${id}</b></p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button id="userNo" style="background: #475569; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">H·ª¶Y</button>
                <button id="userYes" style="background: #7f1d1d; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">X√ìA USER</button>
            </div>
        </div>
    `;

        const t = showToast("", "error", confirmHtml);
        t.querySelector('#userNo').onclick = () => t.remove();
        t.querySelector('#userYes').onclick = async () => {
            t.remove();
            showLoading(true, "ƒêANG X√ìA T√ÄI KHO·∫¢N...");
            try {
                await db.collection("users").doc(id).delete();
                showToast("ƒê√£ x√≥a t√†i kho·∫£n " + id, "success");
                resetUserForm();
            } catch (e) {
                showToast("L·ªói khi x√≥a: " + e.message, "error");
            }
            showLoading(false);
        };
    }

    function resetUserForm() {
        document.getElementById('u_id').value = "";
        document.getElementById('u_id').readOnly = false; // Khi th√™m m·ªõi th√¨ cho nh·∫≠p
        document.getElementById('u_name').value = "";
        
        // Reset √¥ pass v·ªÅ tr·∫°ng th√°i nh·∫≠p ƒë∆∞·ª£c cho user m·ªõi
        const passInput = document.getElementById('u_pass');
        passInput.value = "";
        passInput.readOnly = false;
        
        document.querySelectorAll('input[name="user_cust"]').forEach(ch => ch.checked = false);
        document.getElementById('btnUpdateUser').style.display = 'none';
        document.getElementById('btnDeleteUser').style.display = 'none';
        document.getElementById('btnResetPass').style.display = 'none';
    }

    let selectedDocId = null;

    // 1. Load danh s√°ch kh√°ch h√†ng v√†o Checkbox (Ch·ªâ g·ªçi khi l√† Admin/Edit)
    function loadCustomerCheckboxes(customers) {
        const container = document.getElementById('doc_customer_checks');
        if (!container) return; 

        if (!customers || customers.length === 0) {
            container.innerHTML = `<div style="padding:15px; text-align:center; font-size:12px; color:var(--text-muted);">Ch∆∞a c√≥ d·ªØ li·ªáu kh√°ch h√†ng.</div>`;
            return;
        }

        container.innerHTML = customers.map(c => `
        <label style="display: flex; align-items: center; padding: 5px 15px; cursor: pointer;" class="cust-row">
            <input type="checkbox" name="doc_cust" value="${c}" style="width: 16px; height: 16px; margin-right: 10px; accent-color: var(--primary);">
            <span style="font-size: 13px;">${c}</span>
        </label>
    `).join('');
    }

    // 2. L·∫•y d·ªØ li·ªáu t√†i li·ªáu
    function fetchDocs() {
        db.collection("documents").onSnapshot((snapshot) => {
            const docs = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            renderDocs(docs);
        });
    }

    // 3. Hi·ªÉn th·ªã t√†i li·ªáu 
    function renderDocs(docs) {
        const container = document.getElementById('doc_groups_container');
        if(!container) return; 
        
        let filtered = docs;

        if (AUTH.role === "VIEWER") {
            const allowedList = (AUTH.access || "")
                .split(",")
                .map(s => s.trim())
                .filter(s => s !== "");

            filtered = docs.filter(d => {
                if (!d.customers || d.customers.length === 0) return true;
                return d.customers.some(c => allowedList.includes(c.trim()));
            });
        }
        // EDIT V√Ä ADMIN S·∫º TH·∫§Y H·∫æT (KH√îNG FILTER)

        const groups = {};
        if (filtered.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-muted);">B·∫°n kh√¥ng c√≥ quy·ªÅn xem t√†i li·ªáu n√†o ho·∫∑c ch∆∞a c√≥ t√†i li·ªáu.</div>`;
            return;
        }

        filtered.forEach(d => {
            const type = d.machineType || "KH√ÅC / CH∆ØA PH√ÇN LO·∫†I";
            if (!groups[type]) groups[type] = [];
            groups[type].push(d);
        });

        container.innerHTML = Object.keys(groups).sort().map(groupName => `
        <div class="doc-group-section" style="margin-bottom: 20px;">
            <div style="background: rgba(0, 210, 255, 0.1); padding: 8px 15px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid var(--primary);">
                <span style="color: var(--primary); font-weight: 600; font-size: 14px;">üì¶ NH√ìM: ${groupName}</span>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                ${groups[groupName].map(d => {
            const custsAttr = encodeURIComponent(JSON.stringify(d.customers || []));

            // Ch·ªâ hi·ªÉn th·ªã d√≤ng Quy·ªÅn xem n·∫øu l√† ADMIN (Edit v√† Viewer ·∫©n)
            const accessInfoHtml = (AUTH.role === "ADMIN")
                ? `<div style="font-size:11px; color:var(--text-muted); margin: 5px 0 10px 0;">
                               <span style="color:var(--primary)">üë§ Quy·ªÅn xem:</span> ${(!d.customers || d.customers.length === 0) ? 'T·∫•t c·∫£' : d.customers.join(', ')}
                           </div>`
                : `<div style="margin-top: 15px;"></div>`; 

            return `
                        <div class="meta-col" style="cursor:pointer;" onclick="handleDocClick('${d.id}', '${d.name}', '${d.link}', '${custsAttr}', '${d.machineType || ""}')">
                            <h4 style="border:none; margin:0; text-align:left; font-size:14px;">üìÑ ${d.name}</h4>
                            
                            ${accessInfoHtml}

                            <a href="${d.link}" target="_blank" onclick="event.stopPropagation()" 
                               style="background:var(--primary); color:var(--dark); text-decoration:none; padding:8px; border-radius:6px; text-align:center; font-weight:600; font-size:11px; text-transform:uppercase;">
                               XEM T√ÄI LI·ªÜU
                            </a>
                        </div>
                    `;
        }).join('')}
            </div>
        </div>
    `).join('');
    }

    // Th√™m tham s·ªë mType v√†o click
    function handleDocClick(id, name, link, encodedCusts, mType) {
        if (AUTH.role === "VIEWER" || AUTH.role === "EDIT") {
            // Viewer v√† Edit kh√¥ng ƒë∆∞·ª£c hi·ªán form s·ª≠a
            return;
        }
        
        // CH·ªà ADMIN M·ªöI CH·∫†Y ƒêO·∫†N D∆Ø·ªöI
        selectedDocId = id;
        document.getElementById('doc_name').value = name;
        document.getElementById('doc_link').value = link;
        document.getElementById('doc_machine_type').value = mType; 

        const custs = JSON.parse(decodeURIComponent(encodedCusts));
        const checks = document.querySelectorAll('input[name="doc_cust"]');
        checks.forEach(ch => {
            ch.checked = custs.includes(ch.value);
        });

        document.getElementById('btnUpdateDoc').style.display = 'block';
        document.getElementById('btnDeleteDoc').style.display = 'block';
        toggleForm('doc-form-container', this);
        showToast("ƒêang s·ª≠a: " + name, "info");
    }

    // 4. L∆∞u t√†i li·ªáu m·ªõi
    async function addDoc() {
        const name = document.getElementById('doc_name').value.trim();
        const link = document.getElementById('doc_link').value.trim();
        const mType = document.getElementById('doc_machine_type').value;
        if (!name || !link) return showToast("Thi·∫øu t√™n ho·∫∑c link!", "error");

        const selectedCusts = Array.from(document.querySelectorAll('input[name="doc_cust"]:checked')).map(cb => cb.value);

        showLoading(true, "ƒêANG L∆ØU...");
        await db.collection("documents").add({
            name,
            link,
            machineType: mType,
            customers: selectedCusts,
            createdBy: AUTH.user,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()

        });
        resetDocForm();
        showLoading(false);
    }

    // 5. C·∫≠p nh·∫≠t (Update) t∆∞∆°ng t·ª±
    async function updateDoc() {
        const selectedCusts = Array.from(document.querySelectorAll('input[name="doc_cust"]:checked')).map(cb => cb.value);
        showLoading(true, "ƒêANG C·∫¨P NH·∫¨T...");
        await db.collection("documents").doc(selectedDocId).update({
            name: document.getElementById('doc_name').value,
            link: document.getElementById('doc_link').value,
            machineType: document.getElementById('doc_machine_type').value,
            customers: selectedCusts
        });
        resetDocForm();
        showLoading(false);
    }

    function resetDocForm() {
        selectedDocId = null;
        document.getElementById('doc_name').value = "";
        document.getElementById('doc_link').value = "";
        document.getElementById('doc_machine_type').value = ""; 
        document.querySelectorAll('input[name="doc_cust"]').forEach(ch => ch.checked = false);
        document.getElementById('btnUpdateDoc').style.display = 'none';
        document.getElementById('btnDeleteDoc').style.display = 'none';
    }

    function deleteDoc() {
        const confirmHtml = `
        <div style="min-width: 200px;">
            <p style="margin: 0 0 12px 0; font-weight: 600;">‚ö†Ô∏è X√ìA T√ÄI LI·ªÜU N√ÄY?</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button id="btnNo" style="background: #475569; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">H·ª¶Y</button>
                <button id="btnYes" style="background: #ef4444; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">X√ìA NGAY</button>
            </div>
        </div>
    `;

        const t = showToast("", "info", confirmHtml);

        t.querySelector('#btnNo').onclick = () => t.remove();

        t.querySelector('#btnYes').onclick = async () => {
            t.remove(); 
            showLoading(true, "ƒêANG X√ìA...");
            try {
                await db.collection("documents").doc(selectedDocId).delete();
                showToast("ƒê√£ x√≥a t√†i li·ªáu!", "success");
                resetDocForm();
            } catch (e) {
                showToast("L·ªói: " + e.message, "error");
            }
            showLoading(false);
        };
    }

    function filterDocs() {
        const val = document.getElementById('searchDoc').value.toUpperCase();
        const cards = document.querySelectorAll('#doc-tab .meta-col');
        cards.forEach(c => c.style.display = c.innerText.toUpperCase().includes(val) ? "" : "none");
    }

    function loadUserAccessCheckboxes(customers) {
        const container = document.getElementById('u_access_checks');
        if (!container || !customers) return;

        container.innerHTML = customers.map(c => `
        <label style="display: flex; align-items: center; padding: 5px 15px; cursor: pointer;" class="cust-row">
            <input type="checkbox" name="user_cust" value="${c}" style="width: 16px; height: 16px; margin-right: 10px; accent-color: var(--primary);">
            <span style="font-size: 13px;">${c}</span>
        </label>
    `).join('');
    }


    let charts = {}; 

    function updateDashboard(logs) {
        const stats = {
            cust: {},
            machine: {},
            staff: {},
            support: {}
        };

        logs.forEach(log => {
            const customer = log[2];
            const machine = log[3];
            const support = log[4];
            const staff = log[6];

            if (customer) stats.cust[customer] = (stats.cust[customer] || 0) + 1;
            if (machine) stats.machine[machine] = (stats.machine[machine] || 0) + 1;
            if (staff) stats.staff[staff] = (stats.staff[staff] || 0) + 1;
            if (support) stats.support[support] = (stats.support[support] || 0) + 1;
        });

        renderChart("chartCust", "S·ªë l·∫ßn theo Kh√°ch h√†ng", stats.cust, 'bar');
        renderChart("chartMachine", "S·ªë l·∫ßn theo Lo·∫°i m√°y", stats.machine, 'bar');
        renderChart("chartStaff", "S·ªë l·∫ßn theo K·ªπ thu·∫≠t", stats.staff, 'bar');
        renderChart("chartSupport", "S·ªë l·∫ßn theo Lo·∫°i h·ªó tr·ª£", stats.support, 'bar');
    }

    function renderChart(canvasId, label, dataObj, type) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[canvasId]) charts[canvasId].destroy();

        const sortedEntries = Object.entries(dataObj).sort((a, b) => b[1] - a[1]);
        const labels = sortedEntries.map(el => el[0]);
        const values = sortedEntries.map(el => el[1]);

        const isCust = (canvasId === "chartCust" || canvasId === "chartMachine");

        charts[canvasId] = new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: values,
                    backgroundColor: 'rgba(0, 210, 255, 0.7)',
                    borderColor: '#00d2ff',
                    borderWidth: 1,
                    borderRadius: 5,
                    barPercentage: 0.6,
                    categoryPercentage: 0.7,
                    maxBarThickness: isCust ? 20 : 35
                }]
            },
            options: {
                indexAxis: isCust ? 'y' : 'x',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            display: isCust ? false : true,
                            color: 'rgba(255,255,255,0.05)'
                        },
                        ticks: {
                            color: '#94a3b8',
                            font: {size: 10},
                            stepSize: 1
                        }
                    },
                    x: {
                        beginAtZero: true,
                        grid: {
                            display: isCust ? true : false,
                            color: 'rgba(255,255,255,0.05)'
                        },
                        ticks: {
                            color: '#94a3b8',
                            font: {size: 10}
                        }
                    }
                },
                plugins: {
                    legend: {display: false}
                }
            }
        });
    }


    firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
            const email = user.email;
            try {
                const userDoc = await db.collection("users").doc(email).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    AUTH = {
                        user: email,
                        uid: user.uid,
                        role: userData.role,
                        access: userData.access || "ALL"
                    };

                    showApp();
                    fetchData();
                }
            } catch (e) {
                console.error("L·ªói ƒë·ªìng b·ªô d·ªØ li·ªáu khi F5:", e);
            }
        } else {
            const lockScreen = document.getElementById('lock-screen');
            const mainContent = document.getElementById('main-content');
            if (lockScreen) lockScreen.style.display = 'flex';
            if (mainContent) mainContent.style.display = 'none';
        }
    });

    function updateOnlineStatus() {
        const dot = document.getElementById('status-dot');
        const text = document.getElementById('status-text');
        const container = document.getElementById('network-status-container');

        if (navigator.onLine) {
            container.classList.remove('offline');
            dot.style.display = 'block';
            text.innerText = "H·ªá th·ªëng ƒëang tr·ª±c tuy·∫øn";
        } else {
            container.classList.add('offline');
            text.innerText = "H·ªá th·ªëng ƒëang ngo·∫°i tuy·∫øn";
            showToast("M·∫•t k·∫øt n·ªëi internet!", "error");
        }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    document.addEventListener('DOMContentLoaded', updateOnlineStatus);

    document.addEventListener("DOMContentLoaded", () => {
        const passwordInput = document.getElementById('passInput');
        const userInput = document.getElementById('userInput');
        const handleEnter = (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                unlock();
            }
        };
        if (passwordInput) passwordInput.addEventListener('keypress', handleEnter);
        if (userInput) userInput.addEventListener('keypress', handleEnter);
    });

    function handleLogin(event) {
        event.preventDefault();
        unlock();
    }

    async function backupData() {
        showToast("ƒêang chu·∫©n b·ªã b·∫£n sao l∆∞u...", "info");

        showLoading(true, "ƒêANG GOM D·ªÆ LI·ªÜU...");
        try {
            const collections = ['logs', 'metadata', 'users', 'documents', 'processes'];
            let backup = {};

            for (const colName of collections) {
                const snapshot = await db.collection(colName).get();
                backup[colName] = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            }

            const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `Backup_TechLog_${date}.json`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast("Sao l∆∞u th√†nh c√¥ng!", "success");
        } catch (e) {
            console.error(e);
            showToast("L·ªói sao l∆∞u: " + e.message, "error");
        } finally {
            showLoading(false);
        }
    }

    async function restoreData(event) {
        const file = event.target.files[0];
        if (!file) return;

        showToast("ƒêang ƒë·ªçc file v√† chu·∫©n b·ªã kh√¥i ph·ª•c...", "info");

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                showLoading(true, "ƒêANG KH√îI PH·ª§C...");

                for (const colName in data) {
                    const items = data[colName];
                    for (const item of items) {
                        const {id, ...details} = item;
                        await db.collection(colName).doc(id).set(details);
                    }
                }

                showToast("Kh√¥i ph·ª•c ho√†n t·∫•t! Trang s·∫Ω t·∫£i l·∫°i.", "success");
                setTimeout(() => location.reload(), 2000);
            } catch (err) {
                console.error(err);
                showToast("L·ªói: File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng!", "error");
            } finally {
                showLoading(false);
                event.target.value = ''; 
            }
        };
        reader.readAsText(file);
    }
    
    function toggleForm(containerId, btn) {
    const form = document.getElementById(containerId);
    if (form.style.display === "none" || form.style.display === "") {
        form.style.display = "block";
        btn.innerHTML = `<i class="fas fa-minus-circle"></i> ·∫®N/ HI·ªÜN FORM`;
        btn.style.background = "#7f1d1d"; // ƒê·ªïi sang m√†u ƒë·ªè khi ƒëang m·ªü
    } else {
        form.style.display = "none";
        // C·∫≠p nh·∫≠t l·∫°i t√™n n√∫t t√πy theo tab
        if (containerId === 'formContainer') btn.innerHTML = `<i class="fas fa-plus-circle"></i> ·∫®N/ HI·ªÜN FORM`;
        if (containerId === 'userFormWrapper') btn.innerHTML = `<i class="fas fa-user-plus"></i> ·∫®N/ HI·ªÜN FORM`;
        if (containerId === 'doc-form-container') btn.innerHTML = `<i class="fas fa-file-upload"></i> ·∫®N/ HI·ªÜN FORM`;
        
        btn.style.background = "#334155"; // Tr·ªü v·ªÅ m√†u x√°m xanh
    }
   }

</script>

</body>
</html>
