<!DOCTYPE html>
<html lang="vi">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="color-scheme" content="light dark">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√ÅO C√ÅO K·ª∏ THU·∫¨T</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ†Ô∏è</text></svg>">
    <style>
        :root {
            --primary: #00d2ff;
            --secondary: #3a7bd5;
            --dark: #0f172a;
            --card: #1e293b;
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark);
            color: var(--text-main);
            margin: 0;
            padding: 12px;
            line-height: 1.5;
            -webkit-tap-highlight-color: transparent;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: 0.3s;
            font-size: 13px;
            text-transform: uppercase;
        }

        .tab-btn.active {
            background: var(--primary);
            color: var(--dark);
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Login Screen */
        #lock-screen {
            position: fixed;
            inset: 0;
            background: var(--dark);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-box {
            width: 320px;
            padding: 30px;
            background: var(--card);
            border-radius: 20px;
            border: 1px solid var(--border);
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .login-box img {
            filter: drop-shadow(0 0 15px var(--primary)) brightness(1.2);
        }

        /* Container & Header */
        .container {
            max-width: 1000px;
            margin: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
            margin-bottom: 20px;
        }

        /* Inputs */
        input, select, textarea {
            background: #0f172a;
            border: 1px solid #334155;
            color: white;
            padding: 12px;
            border-radius: 10px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 12px;
            outline: none;
            transition: 0.3s;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 210, 255, 0.2);
        }

        .btn-save {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            transition: transform 0.1s;
        }

        .btn-save:active {
            transform: scale(0.98);
        }

        /* Tables */
        .table-container {
            margin-top: 15px;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow-x: auto;
            background: var(--card);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 850px;
        }

        th {
            background: #111827;
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 14px 12px;
            border-bottom: 2px solid var(--border);
            text-align: left;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            cursor: pointer;
            transition: 0.2s;
        }

        tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        tbody tr:hover td {
            background: rgba(0, 210, 255, 0.08);
        }

        .badge-tech, .badge-mec, .badge-sup {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }
        .badge-tech { background: rgba(58, 123, 213, 0.2); color: #93c5fd; }
        .badge-mec { background: rgba(58, 123, 213, 0.2); color: #93c5ff; }
        .badge-sup { background: rgba(58, 123, 213, 0.2); color: #93c5dd; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
            padding: 20px;
        }

        .modal-content {
            background: var(--card);
            width: 95%;
            max-width: 600px;
            border-radius: 20px;
            border: 1px solid var(--primary);
            padding: 25px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        
        #modalBody { overflow-y: auto; margin-top: 15px; padding-right: 5px; }

        .detail-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;
        }
        .detail-item {
            display: flex; align-items: center; font-size: 13px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 6px 0;
        }
        .detail-label { color: var(--text-muted); width: 85px; flex-shrink: 0; }
        .detail-value { color: var(--primary); font-weight: 600; }

        /* Meta Block */
        .meta-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px;
        }
        .meta-col {
            background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; display: flex; flex-direction: column;
        }
        .meta-col h4 {
            margin: 0 0 12px 0; color: var(--primary); font-size: 12px; text-align: center; border-bottom: 1px solid var(--border); padding-bottom: 8px;
        }
        .meta-list { flex-grow: 1; min-height: 250px; max-height: 400px; overflow-y: auto; }
        .meta-item { background: rgba(0, 0, 0, 0.2); margin-bottom: 4px; border-radius: 6px; }
        .meta-item input { margin-bottom: 0; padding: 8px; font-size: 12px; background: transparent; border: none; color: #fff; }
        .meta-item.editing input { background: #1e293b; border: 1px solid var(--primary); }
        
        .meta-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 12px; }
        .btn-meta { padding: 8px; border-radius: 6px; border: none; font-size: 11px; font-weight: 600; cursor: pointer; text-transform: uppercase; }
        .btn-edit-mode { background: rgba(0, 210, 255, 0.1); color: var(--primary); border: 1px solid var(--primary); }
        .btn-save-mode { background: var(--primary); color: var(--dark); }

        /* Responsive */
        @media (max-width: 768px) {
            .meta-grid { grid-template-columns: 1fr; }
            .detail-grid { grid-template-columns: 1fr; }
            .tab-navigation { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; margin-bottom: 0; z-index: 1000; background: #0f172a; flex-direction: row; }
            .container { margin-bottom: 80px !important; }
            .tab-btn { font-size: 22px !important; }
        }
        @media (min-width: 769px) {
            .tab-navigation { width: 100px; position: fixed; left: 0; top: 0; height: 100vh; flex-direction: column; padding: 10px; z-index: 1000; background: #0f172a; border-right: 1px solid var(--border); box-sizing: border-box; }
            .tab-btn { flex: 1; max-height: 15vh; font-size: 3vw !important; padding: 5px !important; margin: 2px 0; display: flex; align-items: center; justify-content: center; }
            .container { margin-left: 120px !important; max-width: calc(100% - 140px) !important; }
        }

        /* Process Progress */
        .process-progress-container { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        .progress-track { height: 20px; background: #334155; border-radius: 10px; overflow: hidden; position: relative; margin-top: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981, #34d399); width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: #064e3b; font-size: 10px; font-weight: bold; }
        
        .input-group { position: relative; margin-bottom: 15px; text-align: left; }
        .input-group i { position: absolute; left: 15px; top: 14px; color: var(--primary); }
        .input-group input { padding: 12px 15px 12px 45px !important; }

        #toast-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; pointer-events: none; display: flex; flex-direction: column; align-items: center; }
        .toast { background: rgba(30, 41, 59, 0.95); color: white; padding: 20px 30px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); animation: toastPop 0.3s forwards; }
        @keyframes toastPop { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(5px); z-index: 4000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255, 255, 255, 0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="toast-container"></div>
<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text" style="color:var(--primary); font-weight:600; margin-top:10px;">ƒêANG X·ª¨ L√ù...</div>
</div>

<form id="lock-screen" onsubmit="handleLogin(event)">
    <div class="login-box">
        <img src="https://lh3.googleusercontent.com/pw/AP1GczNyKJCNBen1I6WeBIOFBHnduEAc-raKjpQsiE-xMOPlkgBLUxSUPtPfnGUO-h_gVE4xbhoZyycDSfpCjJD_uk7EkCLQJEXeuBytxHxBTDS0NEIMKC7RqBA-GIxKhZed7ddwzYsTmKsh5fKxggPZvFM=w483-h154" alt="Logo" style="width: 250px; margin-bottom: 20px;">
        <h2 style="color:var(--primary); margin:0;">B√ÅO C√ÅO K·ª∏ THU·∫¨T</h2>
        <div class="input-group">
            <i class="fas fa-user"></i>
            <input type="text" id="userInput" placeholder="T√™n ƒëƒÉng nh·∫≠p" required autocomplete="username">
        </div>
        <div class="input-group">
            <i class="fas fa-lock"></i>
            <input type="password" id="passInput" placeholder="M·∫≠t kh·∫©u" required autocomplete="current-password">
        </div>
        <button type="submit" class="btn-save">ƒêƒÇNG NH·∫¨P <i class="fas fa-sign-in-alt"></i></button>
    </div>
</form>

<div class="container" id="main-content" style="display:none;">
    <div class="header">
        <img src="https://lh3.googleusercontent.com/pw/AP1GczNyKJCNBen1I6WeBIOFBHnduEAc-raKjpQsiE-xMOPlkgBLUxSUPtPfnGUO-h_gVE4xbhoZyycDSfpCjJD_uk7EkCLQJEXeuBytxHxBTDS0NEIMKC7RqBA-GIxKhZed7ddwzYsTmKsh5fKxggPZvFM=w483-h154" class="header-logo" alt="Logo" style="height: 55px;">
        <div style="text-align: right">
            <span id="helloUser" style="color:var(--primary); font-size:13px; font-weight:600">---</span>
            <button onclick="signOut()" style="color:#ef4444; background:none; border:none; cursor:pointer; font-weight:bold; font-size:12px;">THO√ÅT</button>
        </div>
    </div>

    <div class="tab-navigation">
        <button class="tab-btn active" onclick="switchTab('dashboard', this)">üè†</button>
        <button class="tab-btn" onclick="switchTab('data-tab', this)">üìë</button>
        <button class="tab-btn" id="btnTabForm" onclick="switchTab('form-tab', this)">üìù</button>
        <button class="tab-btn" id="btnTabProcess" onclick="switchTab('process-tab', this)">üöÄ</button>
        <button class="tab-btn" id="btnTabMeta" onclick="switchTab('meta-tab', this)">‚öôÔ∏è</button>
        <button class="tab-btn" id="btnTabUser" onclick="switchTab('user-tab', this)">üë®‚Äçüîß</button>
        <button class="tab-btn" id="btnTabDoc" onclick="switchTab('doc-tab', this)">üìÇ</button>
    </div>

    <div id="dashboard" class="tab-content active">
        <div id="dash-progress-container" class="process-progress-container" style="display:none;">
             <div style="display:flex; justify-content:space-between; font-size:11px; color:var(--text-muted); margin-bottom:5px;">
                <span><i class="fas fa-tasks"></i> TI·∫æN TR√åNH C√îNG VI·ªÜC D·ª∞ KI·∫æN</span>
                <span id="dash-progress-text">0% Ho√†n th√†nh</span>
            </div>
            <div class="progress-track">
                <div id="dash-progress-fill" class="progress-fill"></div>
            </div>
             <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:11px;">
                <span style="color:var(--text-muted)">T·ªïng: <b id="dash-total" style="color:white">0</b></span>
                <span style="color:#10b981">Xong: <b id="dash-done">0</b></span>
                <span style="color:#f59e0b">Ch∆∞a: <b id="dash-pending">0</b></span>
            </div>
        </div>
        <div class="card" style="padding:15px; height: 350px; background:var(--card); border-radius:12px; border:1px solid var(--border); margin-bottom:20px;">
            <h4 style="margin-top:0; color:var(--primary); text-align:center;">üïµÔ∏è‚Äç‚ôÇÔ∏è Th·ªëng k√™ Kh√°ch H√†ng</h4>
            <canvas id="chartCust"></canvas>
        </div>
    </div>

    <div id="data-tab" class="tab-content">
        <input type="text" id="searchBox" onkeyup="filterTable()" placeholder="üîç T√¨m ki·∫øm nhanh..." style="border: 1px solid var(--primary); background: rgba(0,210,255,0.05);">
        <div class="table-container">
            <table>
                <thead>
                <tr>
                    <th>Ng√†y</th>
                    <th>Kh√°ch</th>
                    <th>M√°y</th>
                    <th>H·ªó tr·ª£</th>
                    <th>N·ªôi dung</th>
                    <th>KTV</th>
                </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="form-tab" class="tab-content">
        <div style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary);">
            <input type="text" id="workDateDisplay" readonly onclick="document.getElementById('dateModal').style.display='flex'" style="text-align:center; color:var(--primary); font-weight:bold; cursor:pointer;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="customer"><option value="">Kh√°ch h√†ng...</option></select>
                <select id="techName"><option value="">K·ªπ thu·∫≠t...</option></select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="machineType"><option value="">Lo·∫°i m√°y...</option></select>
                <select id="supportType"><option value="">H·ªó tr·ª£...</option></select>
            </div>
            <textarea id="content" placeholder="M√¥ t·∫£ c√¥ng vi·ªác..." style="height:100px"></textarea>
            <input type="text" id="note" placeholder="Ghi ch√∫ th√™m...">
            <button class="btn-save" id="btnSave" onclick="saveData()">L∆ØU B√ÅO C√ÅO</button>
        </div>
    </div>

    <div id="process-tab" class="tab-content">
        <div id="proc-progress-container" class="process-progress-container">
            <div class="progress-track">
                <div id="proc-progress-fill" class="progress-fill"></div>
            </div>
        </div>

        <div style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                 <input type="date" id="proc_start_date">
                 <input type="text" id="proc_name" placeholder="T√™n ti·∫øn tr√¨nh...">
                 <select id="proc_tech"><option value="">-- K·ªπ thu·∫≠t --</option></select>
            </div>
            <textarea id="proc_content" placeholder="N·ªôi dung chi ti·∫øt..." style="height:80px; margin-top:10px;"></textarea>
            <input type="text" id="proc_note" placeholder="Ghi ch√∫...">
            <div class="input-group">
                <label style="font-size:10px; color:var(--success); font-weight:bold">Ng√†y ho√†n th√†nh (ƒê·ªÉ tr·ªëng n·∫øu CH∆ØA xong):</label>
                <input type="date" id="proc_end_date" style="padding-left:12px!important; border-color: var(--success);">
            </div>
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:15px;">
                <button class="btn-save" onclick="saveProcess()" style="background:#065f46">‚ûï TH√äM</button>
                <button class="btn-save" id="btnUpdateProc" onclick="updateProcess()" style="background:#1e3a8a; display:none;">üíæ L∆ØU</button>
                <button class="btn-save" id="btnDeleteProc" onclick="deleteProcess()" style="background:#7f1d1d; display:none;">üóëÔ∏è X√ìA</button>
                <button class="btn-save" onclick="resetProcessForm()" style="background:#475569">üßπ M·ªöI</button>
            </div>
        </div>

        <input type="text" id="searchProcess" onkeyup="filterProcesses()" placeholder="üîç T√¨m ki·∫øm ti·∫øn tr√¨nh..." style="border: 1px solid var(--primary); background: rgba(0,210,255,0.05);">
        <div class="table-container">
            <table>
                <thead>
                <tr>
                    <th>B·∫Øt ƒë·∫ßu</th>
                    <th>T√™n</th>
                    <th>N·ªôi dung</th>
                    <th>KTV</th>
                    <th>Tr·∫°ng th√°i</th>
                </tr>
                </thead>
                <tbody id="processTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="meta-tab" class="tab-content">
        <div class="meta-grid">
            <div class="meta-col">
                <h4>KH√ÅCH H√ÄNG</h4>
                <div class="meta-list" id="list-customers"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('customers')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('customers')" style="display:none;">L∆ØU</button>
                </div>
            </div>
            <div class="meta-col">
                <h4>LO·∫†I M√ÅY</h4>
                <div class="meta-list" id="list-machineTypes"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('machineTypes')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('machineTypes')" style="display:none;">L∆ØU</button>
                </div>
            </div>
            <div class="meta-col">
                <h4>K·ª∏ THU·∫¨T</h4>
                <div class="meta-list" id="list-techs"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('techs')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('techs')" style="display:none;">L∆ØU</button>
                </div>
            </div>
            <div class="meta-col">
                <h4>H·ªñ TR·ª¢</h4>
                <div class="meta-list" id="list-supports"></div>
                <div class="meta-actions">
                    <button class="btn-meta btn-edit-mode" onclick="enableMetaEdit('supports')">S·ª¨A</button>
                    <button class="btn-meta btn-save-mode" onclick="saveMetaData('supports')" style="display:none;">L∆ØU</button>
                </div>
            </div>
        </div>
    </div>

    <div id="user-tab" class="tab-content">
        <div style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px;">
                <input type="text" id="u_id" placeholder="Email (User ID)">
                <input type="text" id="u_name" placeholder="H·ªç t√™n">
                <input type="text" id="u_pass" placeholder="M·∫≠t kh·∫©u">
                <select id="u_role">
                    <option value="VIEWER">VIEWER</option>
                    <option value="EDIT">EDIT</option>
                    <option value="ADMIN">ADMIN</option>
                </select>
            </div>
            <div style="background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid var(--border); margin-top:10px;">
                <div style="padding: 5px 10px; font-size: 11px; color: var(--primary); font-weight: bold; border-bottom: 1px solid var(--border);">QUY·ªÄN TRUY C·∫¨P (KH√ÅCH H√ÄNG)</div>
                <div id="u_access_checks" style="max-height: 150px; overflow-y: auto; padding: 5px;"></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:15px;">
                <button class="btn-save" onclick="addUser()" style="background:#065f46">‚ûï TH√äM USER</button>
                <button class="btn-save" id="btnUpdateUser" onclick="updateUser()" style="background:#1e3a8a; display:none;">üíæ C·∫¨P NH·∫¨T</button>
                <button class="btn-save" id="btnDeleteUser" onclick="deleteUser()" style="background:#7f1d1d; display:none;">üóëÔ∏è X√ìA USER</button>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>User ID</th><th>H·ªç t√™n</th><th>Quy·ªÅn</th></tr></thead>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="doc-tab" class="tab-content">
        <div id="doc-form-container" style="background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1.5fr; gap:10px;">
                <input type="text" id="doc_name" placeholder="T√™n t√†i li·ªáu">
                <select id="doc_machine_type"><option value="">-- Lo·∫°i m√°y --</option></select>
                <input type="text" id="doc_link" placeholder="Link t√†i li·ªáu">
            </div>
            <div style="background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid var(--border); overflow: hidden; margin-top:10px;">
                 <div style="padding: 5px 10px; font-size: 11px; color: var(--primary); font-weight: bold; border-bottom: 1px solid var(--border);">KH√ÅCH H√ÄNG ƒê∆Ø·ª¢C XEM</div>
                <div id="doc_customer_checks" style="max-height: 150px; overflow-y: auto; padding: 5px 0;"></div>
            </div>
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:15px;">
                <button class="btn-save" onclick="addDoc()" style="background:#065f46">‚ûï TH√äM</button>
                <button class="btn-save" id="btnUpdateDoc" onclick="updateDoc()" style="background:#1e3a8a; display:none;">üíæ L∆ØU</button>
                <button class="btn-save" id="btnDeleteDoc" onclick="deleteDoc()" style="background:#7f1d1d; display:none;">üóëÔ∏è X√ìA</button>
                <button class="btn-save" onclick="resetDocForm()" style="background:#475569">üßπ M·ªöI</button>
            </div>
        </div>
        <input type="text" id="searchDoc" onkeyup="filterDocs()" placeholder="üîç T√¨m ki·∫øm t√†i li·ªáu..." style="border: 1px solid var(--primary); background: rgba(0,210,255,0.05);">
        <div id="doc_groups_container" style="margin-top: 15px;"></div>
    </div>

    <div id="infoModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
        <div class="modal-content">
            <h3 style="color:var(--primary); text-align:center; margin:0 0 20px 0">CHI TI·∫æT</h3>
            <div id="modalBody"></div>
            <button class="btn-save" style="margin-top:25px" onclick="document.getElementById('infoModal').style.display='none'">ƒê√ìNG</button>
        </div>
    </div>

    <div id="dateModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
        <div class="modal-content" style="text-align:center">
            <h4>CH·ªåN NG√ÄY L√ÄM VI·ªÜC</h4>
            <input type="date" id="hiddenDate" onchange="confirmDate(this.value)">
            <button class="btn-save" onclick="document.getElementById('dateModal').style.display='none'">X√ÅC NH·∫¨N</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC-WW6N3ZzmZ8gk_XypHWa3oW6VJMMGloM",
        authDomain: "data-260206.firebaseapp.com",
        projectId: "data-260206",
        storageBucket: "data-260206.firebasestorage.app",
        messagingSenderId: "992766098254",
        appId: "1:992766098254:web:8e9f5d3216541023d03c1f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let AUTH = JSON.parse(localStorage.getItem('tech_auth_v4')) || null;
    let USER_ROLE = "VIEWER";
    window.currentLogs = [];
    window.currentProcesses = [];
    let selectedProcessId = null;
    let selectedDocId = null;

    document.addEventListener("DOMContentLoaded", () => {
        const iso = new Date().toISOString().split('T')[0];
        document.getElementById('hiddenDate').value = iso;
        document.getElementById('workDateDisplay').value = formatVN(iso);
        const pStart = document.getElementById('proc_start_date');
        if(pStart) pStart.value = iso;

        checkSession();
    });

    function checkSession() {
        const now = new Date().getTime();
        if (AUTH && AUTH.expire && now < AUTH.expire) {
            USER_ROLE = AUTH.role;
            showApp();
            fetchData();
        } else {
            localStorage.removeItem('tech_auth_v4');
            document.getElementById('lock-screen').style.display = 'flex';
        }
    }

    async function unlock() {
        const email = document.getElementById('userInput').value.trim();
        const pass = document.getElementById('passInput').value.trim();
        if (!email || !pass) return showToast("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin", "error");

        showLoading(true, "ƒêANG X√ÅC TH·ª∞C...");
        try {
            const userCredential = await firebase.auth().signInWithEmailAndPassword(email, pass);
            const userDoc = await db.collection("users").doc(email).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                AUTH = { user: email, uid: userCredential.user.uid, role: userData.role, access: userData.access || "ALL", expire: new Date().getTime() + 86400000 };
                localStorage.setItem('tech_auth_v4', JSON.stringify(AUTH));
                showApp();
                fetchData();
            } else {
                await firebase.auth().signOut();
                showToast("T√†i kho·∫£n ch∆∞a c√≥ d·ªØ li·ªáu!", "error");
            }
        } catch (e) {
            showToast("Sai Email ho·∫∑c M·∫≠t kh·∫©u!", "error");
        }
        showLoading(false);
    }

    async function signOut() {
        await firebase.auth().signOut();
        AUTH = null; localStorage.removeItem('tech_auth_v4'); location.reload();
    }

    function showApp() {
        document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('helloUser').innerText = "Ch√†o, " + AUTH.user;
        
        const role = AUTH.role;
        if(role === "VIEWER") {
            ['form-tab','process-tab','meta-tab','user-tab','btnTabForm','btnTabProcess','btnTabMeta','btnTabUser','doc-form-container','dash-progress-container'].forEach(id => {
               const el = document.getElementById(id); if(el) el.remove();
            });
             if (AUTH.access) fetchDocs();
        } else if(role === "EDIT") {
            ['process-tab','meta-tab','user-tab','btnTabProcess','btnTabMeta','btnTabUser','doc-form-container','dash-progress-container'].forEach(id => {
               const el = document.getElementById(id); if(el) el.remove();
            });
            fetchDocs();
        } else if(role === "ADMIN") {
            fetchUsers(); fetchDocs(); fetchProcesses();
            document.getElementById('dash-progress-container').style.display = 'block';
        }
    }

    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if(btn) btn.classList.add('active');
    }

    // --- DATA FETCHING ---
    function fetchData() {
        let query = db.collection("logs").orderBy("workDate", "desc").limit(500);
        if(AUTH.role === "VIEWER" && AUTH.access && AUTH.access !== "ALL") {
             const allowed = AUTH.access.split(",").map(s=>s.trim()).filter(s=>s);
             if(allowed.length) query = query.where("customer", "in", allowed);
        }
        
        query.onSnapshot(snapshot => {
            window.currentLogs = snapshot.docs.map(doc => {
                 const d = doc.data();
                 return [doc.id, d.workDate, d.customer, d.machineType, d.support, d.content, d.tech, d.createdBy, d.note];
            });
            renderLogs();
            updateDashboard();
        });

        if(AUTH.role === "ADMIN" || AUTH.role === "EDIT") {
            db.collection("metadata").doc("dropdowns").onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    updateDropdowns(d);
                    renderMetaBlock(d); // FIX: Meta tab render
                }
            });
        }
    }

    function updateDropdowns(d) {
        const fill = (id, list, txt) => {
            const el = document.getElementById(id); 
            if(el) {
                const val = el.value;
                el.innerHTML = `<option value="">-- ${txt} --</option>` + (list||[]).map(i=>`<option value="${i}">${i}</option>`).join('');
                el.value = val;
            }
        };
        fill('customer', d.customers, 'Kh√°ch h√†ng');
        fill('techName', d.techs, 'K·ªπ thu·∫≠t');
        fill('proc_tech', d.techs, 'K·ªπ thu·∫≠t');
        fill('machineType', d.machineTypes, 'Lo·∫°i m√°y');
        fill('supportType', d.supports, 'H·ªó tr·ª£');
        fill('doc_machine_type', d.machineTypes, 'Lo·∫°i m√°y');
        
        if(d.customers) {
            loadCustomerCheckboxes(d.customers);
            loadUserAccessCheckboxes(d.customers); // FIX: User Tab checkboxes
        }
    }

    function renderLogs() {
        const html = window.currentLogs.map((row, i) => `
            <tr onclick="openInfoModal(${i})">
                <td style="color:var(--text-muted)">${formatVN(row[1])}</td>
                <td><b style="color:var(--primary)">${row[2]}</b></td>
                <td><span class="badge-mec">${row[3]||''}</span></td>
                <td><small>${row[4]||''}</small></td>
                <td style="color:#cbd5e1">${cutText(row[5], 30)}</td>
                <td><span class="badge-tech">${row[6]||''}</span></td>
            </tr>`).join('');
        document.getElementById('tableBody').innerHTML = html;
    }
    
    // --- FIX: Cut Text Logic ---
    function cutText(str, len) {
        if(!str) return "";
        return str.length > len ? str.substring(0, len) + "..." : str;
    }

    // --- PROCESS TAB LOGIC ---
    function fetchProcesses() {
        db.collection("processes").orderBy("startDate", "desc").onSnapshot(snapshot => {
            window.currentProcesses = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            renderProcesses(window.currentProcesses);
            updateProcProgress();
        });
    }

    function renderProcesses(list) {
        const tbody = document.getElementById('processTableBody');
        if(!tbody) return;
        tbody.innerHTML = list.map(p => {
            const isDone = p.endDate && p.endDate.trim() !== "";
            // FIX: √Åp d·ª•ng h√†m cutText chu·∫©n cho c·ªôt n·ªôi dung
            const displayContent = cutText(p.content, 30);
            return `
            <tr onclick="loadProcessToForm('${p.id}')">
                <td style="color:var(--text-muted); font-size:12px">${formatVN(p.startDate)}</td>
                <td style="font-weight:600; color:var(--primary)">${p.name}</td>
                <td style="color:#cbd5e1">${displayContent}</td>
                <td><span class="badge-tech">${p.tech||""}</span></td>
                <td>${isDone ? '<span class="badge-mec" style="background:#064e3b; color:#6ee7b7">HO√ÄN TH√ÄNH</span>' : '<span class="badge-mec" style="background:#78350f; color:#fcd34d">ƒêANG X·ª¨ L√ù</span>'}</td>
            </tr>`;
        }).join('');
    }

    function loadProcessToForm(id) {
        const p = window.currentProcesses.find(i => i.id === id);
        if(!p) return;
        selectedProcessId = id;
        document.getElementById('proc_start_date').value = p.startDate;
        document.getElementById('proc_name').value = p.name;
        document.getElementById('proc_tech').value = p.tech||"";
        document.getElementById('proc_content').value = p.content||"";
        document.getElementById('proc_note').value = p.note||"";
        document.getElementById('proc_end_date').value = p.endDate||"";
        document.getElementById('btnUpdateProc').style.display = 'block';
        document.getElementById('btnDeleteProc').style.display = 'block';
    }

    async function saveProcess() {
        const start = document.getElementById('proc_start_date').value;
        const name = document.getElementById('proc_name').value.trim();
        const content = document.getElementById('proc_content').value.trim();
        if(!start || !name) return showToast("Thi·∫øu ng√†y ho·∫∑c t√™n!", "error");
        
        await db.collection("processes").add({
            startDate: start, name, tech: document.getElementById('proc_tech').value,
            content, note: document.getElementById('proc_note').value,
            endDate: document.getElementById('proc_end_date').value
        });
        showToast("ƒê√£ th√™m!", "success"); resetProcessForm();
    }
    
    async function updateProcess() {
        if(!selectedProcessId) return;
        await db.collection("processes").doc(selectedProcessId).update({
             startDate: document.getElementById('proc_start_date').value,
             name: document.getElementById('proc_name').value.trim(),
             tech: document.getElementById('proc_tech').value,
             content: document.getElementById('proc_content').value.trim(),
             note: document.getElementById('proc_note').value,
             endDate: document.getElementById('proc_end_date').value
        });
        showToast("C·∫≠p nh·∫≠t xong!", "success"); resetProcessForm();
    }
    
    async function deleteProcess() {
        if(!selectedProcessId || !confirm("X√≥a ti·∫øn tr√¨nh n√†y?")) return;
        await db.collection("processes").doc(selectedProcessId).delete();
        showToast("ƒê√£ x√≥a!", "success"); resetProcessForm();
    }

    function resetProcessForm() {
        selectedProcessId = null;
        ['proc_name','proc_content','proc_note','proc_end_date','proc_tech'].forEach(id=>document.getElementById(id).value='');
        document.getElementById('proc_start_date').value = new Date().toISOString().split('T')[0];
        document.getElementById('btnUpdateProc').style.display = 'none';
        document.getElementById('btnDeleteProc').style.display = 'none';
    }
    
    function updateProcProgress() {
        const total = window.currentProcesses.length;
        const done = window.currentProcesses.filter(p => p.endDate).length;
        const pct = total ? Math.round((done/total)*100) : 0;
        
        ['dash-','proc-'].forEach(p => {
             const fill = document.getElementById(p+'progress-fill');
             if(fill) { fill.style.width = pct+'%'; fill.innerText = pct+'%'; }
             const txt = document.getElementById(p+'progress-text'); if(txt) txt.innerText = pct + "% Ho√†n th√†nh";
             const t = document.getElementById(p+'total'); if(t) t.innerText = total;
             const d = document.getElementById(p+'done'); if(d) d.innerText = done;
             const pd = document.getElementById(p+'pending'); if(pd) pd.innerText = total-done;
        });
    }

    // --- META TAB FIX ---
    function renderMetaBlock(data) {
        // H√†m render cho t·ª´ng c·ªôt trong Meta tab
        const render = (id, list) => {
            const c = document.getElementById('list-' + id);
            if(!c) return; 
            const arr = [...(list || []), "",""]; // Th√™m d√≤ng tr·ªëng ƒë·ªÉ d·ªÖ s·ª≠a
            c.innerHTML = arr.map(v => `<div class="meta-item"><input type="text" value="${v}" readonly></div>`).join('');
        };
        render('customers', data.customers);
        render('machineTypes', data.machineTypes);
        render('techs', data.techs);
        render('supports', data.supports);
    }
    
    function enableMetaEdit(id) {
        const list = document.getElementById('list-'+id);
        if(!list) return;
        list.querySelectorAll('input').forEach(i => i.readOnly = false);
        list.querySelectorAll('.meta-item').forEach(d => d.classList.add('editing'));
        const col = list.closest('.meta-col');
        col.querySelector('.btn-edit-mode').style.display = 'none';
        col.querySelector('.btn-save-mode').style.display = 'inline-block';
    }
    
    async function saveMetaData(id) {
        const inputs = document.querySelectorAll(`#list-${id} input`);
        const arr = [...new Set(Array.from(inputs).map(i=>i.value.trim()).filter(v=>v!==""))];
        
        showLoading(true, "ƒêANG L∆ØU METADATA...");
        await db.collection("metadata").doc("dropdowns").set({[id]: arr}, {merge:true});
        
        const list = document.getElementById('list-'+id);
        list.querySelectorAll('input').forEach(i => i.readOnly = true);
        list.querySelectorAll('.meta-item').forEach(d => d.classList.remove('editing'));
        const col = list.closest('.meta-col');
        col.querySelector('.btn-edit-mode').style.display = 'inline-block';
        col.querySelector('.btn-save-mode').style.display = 'none';
        showLoading(false);
    }

    // --- USER TAB FIX ---
    function fetchUsers() {
        db.collection("users").onSnapshot(snap => {
            document.getElementById('userTableBody').innerHTML = snap.docs.map(doc => {
                const u = doc.data();
                return `<tr onclick="loadUser('${doc.id}','${u.name}','${u.role}','${u.access}')">
                    <td><b>${doc.id}</b></td><td>${u.name}</td><td>${u.role}</td></tr>`;
            }).join('');
        });
    }
    
    // H√†m m·ªõi: T·∫°o checkbox cho ph·∫ßn user
    function loadUserAccessCheckboxes(customers) {
        const c = document.getElementById('u_access_checks');
        if(!c) return;
        if(!customers || !customers.length) { c.innerHTML="Ch∆∞a c√≥ kh√°ch h√†ng"; return; }
        c.innerHTML = customers.map(cust => `
            <label style="display:block; margin-bottom:5px; cursor:pointer;">
                <input type="checkbox" name="user_cust" value="${cust}" style="accent-color:var(--primary)"> 
                <span style="font-size:12px">${cust}</span>
            </label>
        `).join('');
    }

    function loadUser(id, name, role, access) {
        document.getElementById('u_id').value = id;
        document.getElementById('u_id').readOnly = true;
        document.getElementById('u_name').value = name;
        document.getElementById('u_pass').readOnly = true; document.getElementById('u_pass').value = "******";
        document.getElementById('u_role').value = role;
        
        const arr = (access||"").split(',').map(s=>s.trim());
        document.querySelectorAll('input[name="user_cust"]').forEach(cb => cb.checked = arr.includes(cb.value));
        
        document.getElementById('btnUpdateUser').style.display = 'block';
        document.getElementById('btnDeleteUser').style.display = 'block';
    }
    
    async function addUser() {
        const id = document.getElementById('u_id').value.trim();
        const pass = document.getElementById('u_pass').value.trim();
        if(!id || pass.length < 6) return showToast("Email v√† Pass >= 6 k√Ω t·ª±!", "error");
        
        const access = Array.from(document.querySelectorAll('input[name="user_cust"]:checked')).map(c=>c.value).join(', ');
        
        showLoading(true);
        try {
            const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");
            await secondaryApp.auth().createUserWithEmailAndPassword(id, pass);
            await db.collection("users").doc(id).set({
                name: document.getElementById('u_name').value,
                role: document.getElementById('u_role').value,
                access: access || "ALL"
            });
            await secondaryApp.delete();
            showToast("T·∫°o user th√†nh c√¥ng!", "success");
        } catch(e) { showToast(e.message, "error"); }
        showLoading(false);
    }
    
    async function updateUser() {
        const id = document.getElementById('u_id').value;
        const access = Array.from(document.querySelectorAll('input[name="user_cust"]:checked')).map(c=>c.value).join(', ');
        await db.collection("users").doc(id).update({
            name: document.getElementById('u_name').value,
            role: document.getElementById('u_role').value,
            access: access || "ALL"
        });
        showToast("ƒê√£ c·∫≠p nh·∫≠t!", "success");
    }
    
    async function deleteUser() {
        const id = document.getElementById('u_id').value;
        if(confirm("X√≥a user "+id+"?")) {
            await db.collection("users").doc(id).delete();
            showToast("ƒê√£ x√≥a!", "success");
            // Reset form
            document.getElementById('u_id').value = ''; document.getElementById('u_id').readOnly = false;
            document.getElementById('u_pass').value = ''; document.getElementById('u_pass').readOnly = false;
            document.getElementById('u_name').value = '';
            document.getElementById('btnUpdateUser').style.display='none'; document.getElementById('btnDeleteUser').style.display='none';
        }
    }

    // --- DOC TAB ---
    function loadCustomerCheckboxes(list) {
        const c = document.getElementById('doc_customer_checks');
        if(c) c.innerHTML = (list||[]).map(cust => `
            <label style="display:block; cursor:pointer; padding:5px;">
                <input type="checkbox" name="doc_cust" value="${cust}"> <span style="font-size:12px">${cust}</span>
            </label>`).join('');
    }
    
    function fetchDocs() {
        db.collection("documents").onSnapshot(snap => {
            const docs = snap.docs.map(d=>({id:d.id, ...d.data()}));
            const c = document.getElementById('doc_groups_container');
            if(!c) return;
            // Gom nh√≥m
            const groups = {};
            docs.forEach(d => {
                const t = d.machineType || "KH√ÅC";
                if(!groups[t]) groups[t] = [];
                groups[t].push(d);
            });
            c.innerHTML = Object.keys(groups).map(g => `
                <div style="margin-bottom:20px">
                    <div style="background:rgba(0,210,255,0.1); padding:8px; border-radius:8px; color:var(--primary); font-weight:bold; margin-bottom:10px;">üì¶ ${g}</div>
                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:10px;">
                        ${groups[g].map(d => `
                            <div class="meta-col" onclick="loadDoc('${d.id}','${d.name}','${d.link}','${d.machineType}','${encodeURIComponent(JSON.stringify(d.customers||[]))}')">
                                <h4 style="border:none; text-align:left">üìÑ ${d.name}</h4>
                                <a href="${d.link}" target="_blank" style="display:block; text-align:center; background:var(--primary); padding:6px; border-radius:4px; color:#000; text-decoration:none; font-weight:bold; font-size:11px;">M·ªû T√ÄI LI·ªÜU</a>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        });
    }

    function loadDoc(id, name, link, type, custEncoded) {
        if(AUTH.role !== "ADMIN") return;
        selectedDocId = id;
        document.getElementById('doc_name').value = name;
        document.getElementById('doc_link').value = link;
        document.getElementById('doc_machine_type').value = type;
        const arr = JSON.parse(decodeURIComponent(custEncoded));
        document.querySelectorAll('input[name="doc_cust"]').forEach(cb => cb.checked = arr.includes(cb.value));
        document.getElementById('btnUpdateDoc').style.display='block';
        document.getElementById('btnDeleteDoc').style.display='block';
    }

    async function addDoc() {
        const name = document.getElementById('doc_name').value;
        const link = document.getElementById('doc_link').value;
        if(!name || !link) return showToast("Thi·∫øu t√™n ho·∫∑c link", "error");
        const custs = Array.from(document.querySelectorAll('input[name="doc_cust"]:checked')).map(c=>c.value);
        await db.collection("documents").add({ name, link, machineType: document.getElementById('doc_machine_type').value, customers: custs });
        showToast("ƒê√£ th√™m!", "success");
    }
    
    async function updateDoc() {
        const custs = Array.from(document.querySelectorAll('input[name="doc_cust"]:checked')).map(c=>c.value);
        await db.collection("documents").doc(selectedDocId).update({
            name: document.getElementById('doc_name').value,
            link: document.getElementById('doc_link').value,
            machineType: document.getElementById('doc_machine_type').value,
            customers: custs
        });
        showToast("C·∫≠p nh·∫≠t xong!", "success");
    }
    
    async function deleteDoc() {
        if(confirm("X√≥a t√†i li·ªáu n√†y?")) {
            await db.collection("documents").doc(selectedDocId).delete();
            showToast("ƒê√£ x√≥a!", "success");
            resetDocForm();
        }
    }
    
    function resetDocForm() {
        selectedDocId = null;
        document.getElementById('doc_name').value='';
        document.getElementById('doc_link').value='';
        document.querySelectorAll('input[name="doc_cust"]').forEach(c=>c.checked=false);
        document.getElementById('btnUpdateDoc').style.display='none';
        document.getElementById('btnDeleteDoc').style.display='none';
    }

    // --- COMMON UTILS ---
    async function saveData() {
        const c = document.getElementById('customer').value;
        const n = document.getElementById('content').value;
        if(!c || !n) return showToast("Ch·ªçn kh√°ch v√† nh·∫≠p n·ªôi dung!", "error");
        await db.collection("logs").add({
            workDate: document.getElementById('hiddenDate').value,
            customer: c, tech: document.getElementById('techName').value,
            machineType: document.getElementById('machineType').value,
            support: document.getElementById('supportType').value,
            content: n, note: document.getElementById('note').value,
            createdBy: AUTH.user
        });
        showToast("L∆∞u th√†nh c√¥ng!", "success");
        document.getElementById('content').value = ""; document.getElementById('note').value = "";
    }

    function openInfoModal(i) {
        const r = window.currentLogs[i];
        document.getElementById('modalBody').innerHTML = `
            <div class="detail-grid">
                <div class="detail-item"><span class="detail-label">Ng√†y:</span><b style="color:var(--primary)">${formatVN(r[1])}</b></div>
                <div class="detail-item"><span class="detail-label">Kh√°ch:</span><b>${r[2]}</b></div>
                <div class="detail-item"><span class="detail-label">M√°y:</span>${r[3]}</div>
                <div class="detail-item"><span class="detail-label">H·ªó tr·ª£:</span>${r[4]}</div>
            </div>
            <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; margin-top:10px;">${r[5]}</div>
            <div style="font-style:italic; color:var(--text-muted); margin-top:5px; font-size:12px">Note: ${r[8]}</div>
            ${AUTH.role === "ADMIN" ? `<button onclick="deleteLog('${r[0]}')" style="margin-top:15px; background:#7f1d1d; color:#fff; border:none; padding:8px; border-radius:5px; width:100%">X√ìA B√ÅO C√ÅO</button>` : ''}
        `;
        document.getElementById('infoModal').style.display='flex';
    }
    
    async function deleteLog(id) {
        if(confirm("X√≥a b√°o c√°o n√†y?")) {
            await db.collection("logs").doc(id).delete();
            document.getElementById('infoModal').style.display='none';
            showToast("ƒê√£ x√≥a!", "success");
        }
    }

    function confirmDate(v) { document.getElementById('workDateDisplay').value = formatVN(v); document.getElementById('dateModal').style.display='none'; }
    function formatVN(s) { if(!s) return ""; const d=new Date(s); return d.getDate().toString().padStart(2,'0')+"/"+(d.getMonth()+1).toString().padStart(2,'0')+"/"+d.getFullYear(); }
    function showLoading(s, t) { document.getElementById('loading-overlay').style.display = s?'flex':'none'; if(t) document.getElementById('loading-text').innerText=t; }
    function showToast(m, type) {
        const t = document.createElement('div'); t.className = 'toast'; t.innerText = m;
        if(type==='error') t.style.borderColor='#ef4444';
        document.getElementById('toast-container').appendChild(t);
        setTimeout(()=>t.remove(), 2500);
    }
    
    // --- DASHBOARD CHARTS ---
    function updateDashboard() {
        if(AUTH.role === "VIEWER") return; // Viewer th∆∞·ªùng kh√¥ng xem chart
        const stats = {};
        window.currentLogs.forEach(r => {
            const c = r[2]; stats[c] = (stats[c]||0)+1;
        });
        const ctx = document.getElementById('chartCust');
        if(!ctx) return;
        if(window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(stats),
                datasets: [{ label: 'S·ªë l·∫ßn h·ªó tr·ª£', data: Object.values(stats), backgroundColor: '#00d2ff' }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} } }
        });
    }

    function filterTable() {
        const v = document.getElementById('searchBox').value.toUpperCase();
        const trs = document.getElementById('tableBody').getElementsByTagName('tr');
        for(let r of trs) r.style.display = r.innerText.toUpperCase().includes(v) ? "" : "none";
    }
    function filterProcesses() {
        const v = document.getElementById('searchProcess').value.toUpperCase();
        const trs = document.getElementById('processTableBody').getElementsByTagName('tr');
        for(let r of trs) r.style.display = r.innerText.toUpperCase().includes(v) ? "" : "none";
    }
    function filterDocs() {
        const v = document.getElementById('searchDoc').value.toUpperCase();
        document.querySelectorAll('#doc-tab .meta-col').forEach(c => c.style.display = c.innerText.toUpperCase().includes(v)?"":"none");
    }
</script>
</body>
</html>
